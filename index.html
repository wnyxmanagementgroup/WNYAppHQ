<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Added Chart.js library -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.15s ease-in-out; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .form-label { font-weight: bold; color: #374151; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        fieldset { border-color: #e5e7eb; }
        legend { background-color: #f3f4f6; padding: 0.25rem 1rem; border-radius: 9999px; font-weight: 700; color: #4f46e5; font-size: 1.125rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; padding: 0.6rem 1.25rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 0.75rem; }
        .nav-button.active { background-color: #e0e7ff; border: 2px solid #4f46e5; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <div id="login-screen" class="max-w-md mx-auto mt-10 p-8 rounded-2xl shadow-2xl main-container">
            <div class="text-center mb-8">
                <img src="https://www.wny.ac.th/wny/storage/2025/03/Branner-WNY-Thai.png" alt="Logo" class="mx-auto h-28 mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WNY App ไปราชการ</h1>
                <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="form-label">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">รหัสผ่าน (Password)</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-full text-lg">
                    <div id="login-loader" class="loader hidden"></div>
                    <span id="login-button-text">เข้าสู่ระบบ</span>
                </button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
             <p class="text-center mt-4 text-sm text-gray-600">
                ยังไม่มีบัญชี? <button type="button" id="show-register-modal-button" class="font-semibold text-indigo-600 hover:text-indigo-500">สมัครใช้งานที่นี่</button>
            </p>
        </div>

        <div id="main-app" class="hidden">
            <header class="p-4 bg-white rounded-xl shadow-lg mb-6 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">ยินดีต้อนรับ, <span id="user-fullname"></span></h2>
                    <p class="text-sm text-gray-500">ตำแหน่ง: <span id="user-position"></span></p>
                </div>
                <button id="logout-button" class="btn btn-danger">ออกจากระบบ</button>
            </header>

            <div id="navigation" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 mb-6">
                <button data-target="dashboard-page" id="user-nav-dashboard" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition active">
                    <h3 class="font-bold text-indigo-700">แดชบอร์ด</h3>
                    <p class="text-xs text-gray-500">ภาพรวมของคุณ</p>
                </button>
                <button data-target="form-page" id="user-nav-form" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ร่างคำขอไปราชการ</h3>
                    <p class="text-xs text-gray-500">สร้างบันทึกข้อความ</p>
                </button>
                <button data-target="memo-page" id="user-nav-memo" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ส่งบันทึกข้อความ</h3>
                    <p class="text-xs text-gray-500">อัพโหลดไฟล์</p>
                </button>
                <button data-target="command-generation-page" id="admin-nav-command" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-purple-700">จัดการคำสั่ง</h3>
                    <p class="text-xs text-gray-500">อนุมัติคำสั่งราชการ</p>
                </button>
                <button data-target="admin-memos-page" id="admin-nav-management" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการบันทึกข้อความ</h3>
                    <p class="text-xs text-gray-500">รายการที่ส่งแล้ว</p>
                </button>
                 <button data-target="stats-page" id="nav-stats" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-green-700">สถิติข้อมูล</h3>
                    <p class="text-xs text-gray-500">สรุปภาพรวม</p>
                </button>
                <button data-target="profile-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ข้อมูลส่วนตัว</h3>
                    <p class="text-xs text-gray-500">จัดการข้อมูลของคุณ</p>
                </button>
                <button id="admin-nav-users" data-target="admin-users-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการผู้ใช้</h3>
                    <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
                </button>
            </div>

            <main id="page-content" class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg">
                <div id="dashboard-page" class="page-view">
                    <h2 class="text-2xl font-bold mb-4">รายการคำขอไปราชการของฉัน</h2>
                    <input type="text" id="search-requests" class="form-input mb-4" placeholder="ค้นหาตามวัตถุประสงค์, สถานที่, เลขอ้างอิง...">
                    <div id="requests-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                    </div>
                    <div id="requests-list" class="hidden"></div>
                    <p id="no-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบรายการคำขอของคุณ</p>
                </div>

                <div id="form-page" class="page-view hidden">
                     <!-- Datalist for attendee positions -->
                     <datalist id="position-options">
                        <option value="ผู้อำนวยการ"></option>
                        <option value="รองผู้อำนวยการ"></option>
                        <option value="ครู"></option>
                        <option value="ครูผู้ช่วย"></option>
                        <option value="พนักงานราชการ"></option>
                        <option value="ครูอัตราจ้าง"></option>
                        <option value="พนักงานขับรถ"></option>
                        <option value="นักเรียน"></option>
                     </datalist>

                     <form id="request-form">
                          <input type="hidden" id="form-request-id">
                           <fieldset class="border p-4 rounded-lg mb-6"><legend>ข้อมูลทั่วไป</legend>
                                <div><label for="form-doc-date" class="form-label">วันที่</label><input type="date" id="form-doc-date" class="form-input" required></div>
                        </fieldset>
                       <fieldset class="border p-4 rounded-lg mb-6"><legend>1. รายละเอียดการไปราชการ</legend>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                   <div><label for="form-requester-name" class="form-label">ชื่อ-นามสกุลผู้ขอ</label><input type="text" id="form-requester-name" class="form-input" required></div>
                                   <div><label for="form-requester-position" class="form-label">ตำแหน่ง</label><input type="text" id="form-requester-position" class="form-input" required></div>
                              </div>
                             <div class="mt-4"><label for="form-location" class="form-label">ขออนุญาตไปราชการ ณ สถานที่</label><input type="text" id="form-location" class="form-input" required></div>
                             <div class="mt-4"><label for="form-purpose" class="form-label">เพื่อ</label><textarea id="form-purpose" rows="2" class="form-input" required></textarea></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                   <div><label for="form-start-date" class="form-label">ตั้งแต่วันที่</label><input type="date" id="form-start-date" class="form-input" required></div>
                                   <div><label for="form-end-date" class="form-label">ถึงวันที่</label><input type="date" id="form-end-date" class="form-input" required></div>
                              </div>
                       </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ผู้ร่วมเดินทาง (ถ้ามี)</legend>
                                <div id="form-attendees-list"></div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button type="button" id="form-add-attendee" class="btn btn-success w-full sm:w-auto"><span>+ เพิ่มผู้ร่วมเดินทาง</span></button>
                                    <button type="button" id="form-import-excel" class="btn btn-primary w-full sm:w-auto"><span>นำเข้าจาก Excel</span></button>
                                    <button type="button" id="form-download-template" class="btn bg-gray-500 text-white hover:bg-gray-600 w-full sm:w-auto"><span>ดาวน์โหลดแม่แบบ</span></button>
                                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                                </div>
                        </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>2. การเบิกค่าใช้จ่าย</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="expense_no" name="expense_option" value="no" checked class="h-4 w-4"><label for="expense_no" class="ml-2">ไม่ขอเบิกค่าใช้จ่าย</label></div>
                                    <div><input type="radio" id="expense_partial" name="expense_option" value="partial" class="h-4 w-4"><label for="expense_partial" class="ml-2">ขอเบิกเฉพาะค่าใช้จ่าย</label></div>
                               </div>
                             <div id="partial-expense-options" class="pl-6 mt-3 hidden space-y-2">
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าเบี้ยเลี้ยง" class="rounded"> ค่าเบี้ยเลี้ยง</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าอาหาร" class="rounded"> ค่าอาหาร</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าที่พัก" class="rounded"> ค่าที่พัก</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าพาหนะ" class="rounded"> ค่าพาหนะ</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าน้ำมัน" class="rounded"> ค่าน้ำมัน</label>
                                  <div class="flex items-center gap-2"><label><input type="checkbox" name="expense_item" id="expense_other_check" value="ค่าใช้จ่ายอื่นๆ" class="rounded"> ค่าใช้จ่ายอื่นๆ</label><input type="text" id="expense_other_text" class="form-input text-sm p-1 flex-grow" placeholder="ระบุ"></div>
                             </div>
                             <div id="total-expense-container" class="mt-4 hidden"><label for="form-total-expense" class="form-label">รวมเป็นจำนวนเงิน (บาท)</label><input type="text" id="form-total-expense" class="form-input w-full md:w-1/2" placeholder="0.00"></div>
                        </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>3. การเดินทาง</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="vehicle_gov" name="vehicle_option" value="gov" checked class="h-4 w-4"><label for="vehicle_gov" class="ml-2">รถยนต์ราชการ (รถโรงเรียน)</label></div>
                                    <div><input type="radio" id="vehicle_private" name="vehicle_option" value="private" class="h-4 w-4"><label for="vehicle_private" class="ml-2">รถยนต์ส่วนตัว</label></div>
                                    <div id="private-vehicle-details" class="pl-8 mt-2 hidden"><label for="form-license-plate" class="form-label">หมายเลขทะเบียน</label><input type="text" id="form-license-plate" class="form-input w-full md:w-1/2"></div>
                                    <div><input type="radio" id="vehicle_public" name="vehicle_option" value="public" class="h-4 w-4"><label for="vehicle_public" class="ml-2">พาหนะอื่นๆ</label></div>
                                </div>
                        </fieldset>
                            <fieldset id="signer-fieldset" class="border p-4 rounded-lg mb-6"><legend>5. ข้อมูลผู้ลงนาม</legend>
                                <div class="mb-4">
                                    <label for="form-department" class="form-label">กลุ่มสาระฯ / งาน</label>
                                    <select id="form-department" class="form-input" required></select>
                                </div>
                                <div><label for="form-head-name" class="form-label">ชื่อหัวหน้ากลุ่มสาระ / หัวหน้างาน</label><input type="text" id="form-head-name" class="form-input bg-gray-200" readonly></div>
                        </fieldset>
                       <div class="text-center mt-10 border-t pt-6 border-gray-200">
                                <button type="submit" id="submit-request-button" class="btn btn-primary w-full sm:w-auto text-lg">
                                  <div id="submit-loader" class="loader hidden"></div>
                                  <span id="submit-button-text">บันทึกและสร้างเอกสาร</span>
                                </button>
                        </div>
                    </form>
                      <div id="form-result" class="hidden mt-6 p-6 text-center">
                          <h3 id="form-result-title" class="font-bold text-lg"></h3>
                          <p id="form-result-message" class="mt-2 text-gray-700"></p>
                           <div class="flex justify-center flex-wrap gap-4 mt-4">
                               <a id="form-result-link" href="#" target="_blank" class="btn btn-success">เปิดไฟล์ PDF</a>
                               <button type="button" id="go-to-memo-page-button" class="btn btn-primary">ไปที่หน้าส่งบันทึกข้อความ</button>
                           </div>
                      </div>
                </div>

                <div id="memo-page" class="page-view hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl font-bold mb-4">ส่งบันทึกข้อความใหม่</h2>
                            <form id="memo-form">
                                <fieldset class="border p-4 rounded-lg bg-white">
                                    <legend>อัพโหลดไฟล์และกรอกข้อมูล</legend>
                                    <div class="mb-4">
                                        <label for="memo-ref-number" class="form-label">เลือกร่างคำขอ (เลขที่อ้างอิง)</label>
                                        <select id="memo-ref-number" class="form-input" required></select>
                                    </div>
                                     <div class="mb-4">
                                        <label class="form-label">ประเภทการส่ง</label>
                                        <div class="flex gap-4 mt-2">
                                            <div><input type="radio" id="memo-type-no-reimburse" name="memo_type" value="no-reimburse" checked><label for="memo-type-no-reimburse" class="ml-2">ไม่เบิก (ต้องแนบไฟล์)</label></div>
                                            <div><input type="radio" id="memo-type-reimburse" name="memo_type" value="reimburse"><label for="memo-type-reimburse" class="ml-2">เบิก (ไม่ต้องแนบไฟล์)</label></div>
                                        </div>
                                    </div>
                                    <div id="memo-file-container" class="mb-6"><label for="memo-file" class="form-label">ไฟล์บันทึกข้อความ (PDF เท่านั้น)</label><input type="file" id="memo-file" class="form-input" accept="application/pdf" required><span id="memo-filename" class="text-sm text-gray-500 mt-1 block"></span></div>
                                    <button type="submit" id="submit-memo-button" class="btn btn-primary w-full"><div id="memo-submit-loader" class="loader hidden"></div><span id="memo-submit-button-text">ส่งบันทึกข้อความ</span></button>
                                </fieldset>
                            </form>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-4">รายการที่ส่งแล้ว</h2>
                            <div id="memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                            <div id="memos-list" class="hidden space-y-3"></div>
                            <p id="no-memos-message" class="text-center text-gray-500 p-8 hidden">ยังไม่มีรายการที่ส่ง</p>
                        </div>
                    </div>
                </div>

                <div id="profile-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">ข้อมูลส่วนตัว</h2>
                      <form id="profile-form">
                         <div class="mb-4"><label for="profile-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="profile-username" class="form-input" required></div>
                          <div class="mb-4"><label for="profile-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="profile-fullname" class="form-input" required></div>
                          <div class="mb-4"><label for="profile-position" class="form-label">ตำแหน่ง</label><input type="text" id="profile-position" class="form-input" required></div>
                        <div class="mb-6"><label for="profile-department" class="form-label">กลุ่มสาระการเรียนรู้/กลุ่มงาน</label><input type="text" id="profile-department" class="form-input" required></div>
                        <button type="submit" id="save-profile-button" class="btn btn-primary"><div id="profile-loader" class="loader hidden"></div><span id="profile-button-text">บันทึกข้อมูล</span></button>
                          <p id="profile-message" class="text-green-600 mt-4 hidden"></p>
                    </form>
                    
                    <h2 class="text-2xl font-bold mb-4 mt-10 border-t pt-6">เปลี่ยนรหัสผ่าน</h2>
                    <form id="password-form">
                        <div class="mb-4 relative">
                            <label for="profile-current-password" class="form-label">รหัสผ่านปัจจุบัน</label>
                            <input type="password" id="profile-current-password" class="form-input" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="profile-new-password" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" id="profile-new-password" class="form-input" required>
                        </div>
                        <div class="mb-6 relative">
                            <label for="profile-confirm-password" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                            <input type="password" id="profile-confirm-password" class="form-input" required>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-password-toggle" class="form-checkbox h-5 w-5 text-indigo-600">
                                <span class="ml-2 text-gray-700">แสดงรหัสผ่าน</span>
                            </label>
                        </div>
                        <button type="submit" id="save-password-button" class="btn btn-primary">
                            <div id="password-loader" class="loader hidden"></div>
                            <span id="password-button-text">เปลี่ยนรหัสผ่าน</span>
                        </button>
                        <p id="password-message" class="text-green-600 mt-4 hidden"></p>
                        <p id="password-error" class="text-red-500 mt-4 hidden"></p>
                    </form>
                </div>
                
                <div id="admin-users-page" class="page-view hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-2xl font-bold">จัดการผู้ใช้งาน</h2>
                        <div class="flex gap-2">
                             <button id="import-users-button" class="btn btn-primary">นำเข้าจาก Excel</button>
                             <button id="download-user-template-button" class="btn bg-gray-500 text-white hover:bg-gray-600">ดาวน์โหลดแม่แบบ</button>
                             <button id="add-user-button" class="btn btn-success">เพิ่มผู้ใช้ใหม่</button>
                             <input type="file" id="user-excel-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <div id="admin-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลผู้ใช้...</p></div>
                    <div id="admin-users-list" class="hidden overflow-x-auto"></div>
                </div>

                 <div id="admin-memos-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการบันทึกข้อความที่ส่งแล้ว</h2>
                    <div id="admin-memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                    <div id="admin-memos-list" class="hidden overflow-x-auto"></div>
                    <p id="no-admin-memos-message" class="text-center text-gray-500 p-8 hidden">ไม่พบบันทึกข้อความ</p>
                </div>

                <div id="command-generation-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการคำสั่งไปราชการ</h2>
                    <div id="command-requests-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดร่างคำขอทั้งหมด...</p></div>
                    <div id="command-requests-list" class="hidden overflow-x-auto"></div>
                    <p id="no-command-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบร่างคำขอ</p>
                </div>
                
                <div id="stats-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">สรุปสถิติข้อมูลทั้งหมด</h2>
                    <div id="stats-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังประมวลผลข้อมูลสถิติ...</p>
                    </div>
                    <div id="stats-content" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Stat cards will be dynamically inserted here -->
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            <p>พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">สมัครใช้งานใหม่</h3>
            <form id="register-form">
                <div class="mb-4"><label for="register-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="register-username" class="form-input" required></div>
                 <div class="mb-4"><label for="register-password" class="form-label">รหัสผ่าน (Password)</label><input type="password" id="register-password" class="form-input" required></div>
                 <div class="mb-4"><label for="register-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="register-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="register-position" class="form-label">ตำแหน่ง</label><input type="text" id="register-position" class="form-input" required></div>
                 <div class="mb-4">
                    <label for="register-department" class="form-label">กลุ่มสาระการเรียนรู้</label>
                    <select id="register-department" class="form-input" required>
                        <option value="">-- กรุณาเลือก --</option>
                        <option value="กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี">กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี</option>
                        <option value="กลุ่มสาระการเรียนรู้คณิตศาสตร์">กลุ่มสาระการเรียนรู้คณิตศาสตร์</option>
                        <option value="กลุ่มสาระการเรียนรู้ภาษาไทย">กลุ่มสาระการเรียนรู้ภาษาไทย</option>
                        <option value="กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ">กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ</option>
                        <option value="กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม">กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม</option>
                        <option value="กลุ่มสาระการเรียนรู้ศิลปะ">กลุ่มสาระการเรียนรู้ศิลปะ</option>
                        <option value="กลุ่มสาระการเรียนรู้การงานอาชีพ">กลุ่มสาระการเรียนรู้การงานอาชีพ</option>
                        <option value="กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา">กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา</option>
                    </select>
                </div>
                <p id="register-error" class="text-red-500 mb-4 hidden"></p>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="register-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="register-save-button" class="btn btn-primary"><div id="register-loader" class="loader hidden"></div><span id="register-button-text">สมัครใช้งาน</span></button></div>
            </form>
        </div>
    </div>
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 id="admin-modal-title" class="text-xl font-bold mb-4">เพิ่มผู้ใช้ใหม่</h3>
            <form id="admin-modal-form">
                <input type="hidden" id="modal-user-id">
                 <input type="hidden" id="modal-original-username">
                <div class="mb-4"><label for="modal-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="modal-username" class="form-input" required></div>
                <div class="mb-4"><label for="modal-password" class="form-label">รหัสผ่าน (เว้นว่างไว้หากไม่ต้องการเปลี่ยน)</label><input type="password" id="modal-password" class="form-input" placeholder="รหัสผ่านใหม่"></div>
                 <div class="mb-4"><label for="modal-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="modal-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-position" class="form-label">ตำแหน่ง</label><input type="text" id="modal-position" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-department" class="form-label">กลุ่มสาระฯ/งาน</label><input type="text" id="modal-department" class="form-input" required></div>
                 <div class="mb-4">
                    <label for="modal-role" class="form-label">สิทธิ์</label>
                    <select id="modal-role" class="form-input"><option value="user">User</option><option value="admin">Admin</option></select>
                </div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="admin-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="admin-modal-save-button" class="btn btn-primary"><div id="admin-modal-loader" class="loader hidden"></div><span id="admin-modal-button-text">บันทึก</span></button></div>
            </form>
        </div>
    </div>
    <div id="alert-modal" class="modal"><div class="modal-content text-center"><h3 id="alert-modal-title" class="text-xl font-bold mb-4"></h3><p id="alert-modal-message" class="mb-6"></p><button id="alert-modal-close-button" class="btn btn-primary">ตกลง</button></div></div>
    <div id="confirm-modal" class="modal"><div class="modal-content text-center"><h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3><p id="confirm-modal-message" class="mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-modal-no-button" class="btn bg-gray-300">ยกเลิก</button><button id="confirm-modal-yes-button" class="btn btn-danger">ยืนยัน</button></div></div></div>
    
    <div id="dispatch-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">ออกหนังสือส่ง</h3>
            <form id="dispatch-form">
                <input type="hidden" id="dispatch-request-id">
                <div class="mb-4">
                    <label for="dispatch-month" class="form-label">เดือน</label>
                    <select id="dispatch-month" class="form-input" required>
                        <option value="มกราคม">มกราคม</option>
                        <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                        <option value="มีนาคม">มีนาคม</option>
                        <option value="เมษายน">เมษายน</option>
                        <option value="พฤษภาคม">พฤษภาคม</option>
                        <option value="มิถุนายน">มิถุนายน</option>
                        <option value="กรกฎาคม">กรกฎาคม</option>
                        <option value="สิงหาคม">สิงหาคม</option>
                        <option value="กันยายน">กันยายน</option>
                        <option value="ตุลาคม">ตุลาคม</option>
                        <option value="พฤศจิกายน">พฤศจิกายน</option>
                        <option value="ธันวาคม">ธันวาคม</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="dispatch-year" class="form-label">ปี พ.ศ.</label>
                    <input type="number" id="dispatch-year" class="form-input" required>
                </div>
                 <div class="mb-4">
                    <label for="command-count" class="form-label">จำนวนคำสั่ง</label>
                    <input type="number" id="command-count" class="form-input" required>
                </div>
                 <div class="mb-4">
                    <label for="memo-count" class="form-label">จำนวนบันทึกข้อความ</label>
                    <input type="number" id="memo-count" class="form-input" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="dispatch-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">
                        <div id="dispatch-loader" class="loader hidden"></div>
                        <span id="dispatch-button-text">สร้างหนังสือส่ง</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Stats Detail Modal -->
    <div id="stats-detail-modal" class="modal">
        <div class="modal-content !max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="stats-detail-title" class="text-xl font-bold">รายละเอียด</h3>
                <button id="stats-detail-close-button" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="stats-detail-list" class="max-h-[70vh] overflow-y-auto space-y-3 p-2 bg-gray-50 rounded">
                <!-- Detailed request cards will be inserted here -->
            </div>
        </div>
    </div>

    <!-- NEW: Admin Memo File Upload Modal -->
    <div id="admin-upload-memo-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold">จัดการไฟล์เอกสาร</h3>
                 <button id="admin-upload-memo-close-button" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <input type="hidden" id="admin-upload-memo-id">
            <div class="space-y-4">
                <!-- Signed Memo -->
                <div>
                    <label for="signed-memo-file" class="form-label">ไฟล์บันทึกข้อความ (ลงนามแล้ว)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="file" id="signed-memo-file" class="form-input" accept="application/pdf">
                        <button class="btn btn-sm btn-primary upload-signed-file-btn" data-file-type="completedMemo">อัปโหลด</button>
                    </div>
                </div>
                <!-- Signed Command -->
                 <div>
                    <label for="signed-command-file" class="form-label">ไฟล์คำสั่ง (ลงนามแล้ว)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="file" id="signed-command-file" class="form-input" accept="application/pdf">
                        <button class="btn btn-sm btn-primary upload-signed-file-btn" data-file-type="completedCommand">อัปโหลด</button>
                    </div>
                </div>
                <!-- Signed Dispatch Letter -->
                 <div>
                    <label for="signed-dispatch-file" class="form-label">ไฟล์หนังสือส่ง (ลงนามแล้ว)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="file" id="signed-dispatch-file" class="form-input" accept="application/pdf">
                        <button class="btn btn-sm btn-primary upload-signed-file-btn" data-file-type="dispatchBook">อัปโหลด</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script type="module">
    // --- CONFIGURATION ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvi_gK-fITm3N74_-qrRI9t4oNkGBW2d02fo6a0j622nZpR1qq8aMhjroGSG-Oyp_Ryg/exec';

    // This object is now only a fallback.
    const DEPARTMENTS = {
        "กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี": "นางสาวจิราพร วิเศษ",
        "กลุ่มสาระการเรียนรู้คณิตศาสตร์": "นางสุภาพร ยอดสร้อย",
        "กลุ่มสาระการเรียนรู้ภาษาไทย": "นางสาวศิริพร บุญอาจ",
        "กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ": "นางรัตนาภรณ์ ไชยเสนา",
        "กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม": "นายณัฐพล บรรหาร",
        "กลุ่มสาระการเรียนรู้ศิลปะ": "นายกิตติธัช โพธิ์ศรี",
        "กลุ่มสาระการเรียนรู้การงานอาชีพ": "นางสาววัชรีภรณ์ ขันแข็ง",
        "กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา": "นายจิรภัทร ชาแท่น",
        "งานบริหารวิชาการ": "นางสาวขวัญใจ สมตัว",
        "งานบริหารงบประมาณ": "นางสาวจีรนันท์ อุปฮาด",
        "งานบริหารบุคคล": "นายธนายุทธ เย็นสบาย",
        "งานบริหารทั่วไป": "นายสุริยา นามวงษ์",
        "สำนักงานผู้อำนวยการ": "นายทวีศักดิ์ สมนอก"
    };

    // Global state
    let currentUserProfile = null;
    let userRequestsCache = [];
    let allRequestsCache = []; // Cache for stats
    let allUsersCache = []; // Cache for stats
    let signerMap = {};
    let specialPositions = [];
    
    // --- DOM ELEMENTS CACHING ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const loginScreen = $('#login-screen');
    const mainApp = $('#main-app');

    // --- API COMMUNICATION ---
    /**
     * Handles all communication with the Google Apps Script backend.
     * @param {string} action - The action to be performed by the script.
     * @param {object} payload - The data to send with the request.
     * @returns {Promise<object>} The response from the script.
     */
    async function api(action, payload = {}) {
        const READ_ACTIONS = new Set([
            "getUserRequests", "getAllUsers", "getSentMemos", 
            "getAllRequests", "getAllMemos", "getAttendeesForRequest", "getDepartmentData"
        ]);

        try {
            let response;
            let url = SCRIPT_URL;

            if (READ_ACTIONS.has(action)) {
                // Handle GET request for reading data
                const params = new URLSearchParams(payload);
                url = `${SCRIPT_URL}?action=${action}&${params.toString()}`;
                response = await fetch(url);
            } else {
                 // Handle POST request for writing data
                 response = await fetch(SCRIPT_URL, {
                     method: 'POST',
                     body: JSON.stringify({ action: action, payload: payload }),
                     headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Use text/plain to avoid preflight for simple POSTs
                     mode: 'cors',
                     redirect: 'follow'
                 });
            }

            if (!response.ok) {
                console.error('Fetch response not OK.', { status: response.status, statusText: response.statusText });
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }

            const text = await response.text();
            
            // Handle case where script might redirect to a login page on auth error, returning HTML
            if (text.trim().startsWith('{')) {
                const result = JSON.parse(text);
                if (result.status === 'error' && result.message) {
                    if (action !== 'verifyCredentials') { // Don't show generic alert for login failure
                        showAlert('ข้อผิดพลาดจากเซิร์ฟเวอร์', result.message);
                    }
                }
                return result;
            } else {
                 // The response is likely HTML from a redirect, which indicates a script/auth error.
                 console.error("Received non-JSON response:", text);
                 throw new Error("Received non-JSON response from server. This often happens due to a script error or incorrect deployment permissions.");
            }
            
        } catch (error) {
            console.error('API Communication Error:', error);
            showAlert('ข้อผิดพลาดในการเชื่อมต่อ', 'ไม่สามารถสื่อสารกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการตั้งค่า Deployment ของ Google Script (ต้องตั้งค่า "Who has access" เป็น "Anyone") หรือตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
            return { status: 'error', message: error.toString(), error: error };
        }
    }
    
    // --- UTILITY & HELPER FUNCTIONS ---

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); // Return only base64 data
            reader.onerror = error => reject(error);
        });
    }

    function showAlert(title, message) {
        $('#alert-modal-title').textContent = title;
        $('#alert-modal-message').textContent = message;
        $('#alert-modal').style.display = 'flex';
    }

    function showConfirm(title, message) {
        $('#confirm-modal-title').textContent = title;
        $('#confirm-modal-message').textContent = message;
        $('#confirm-modal').style.display = 'flex';
        return new Promise((resolve) => {
            $('#confirm-modal-yes-button').onclick = () => {
                $('#confirm-modal').style.display = 'none';
                resolve(true);
            };
            $('#confirm-modal-no-button').onclick = () => {
                $('#confirm-modal').style.display = 'none';
                resolve(false);
            };
        });
    }

    function formatThaiDate(dateInput) {
        if (!dateInput) return '';
        const date = new Date(dateInput);
        return date.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        });
    }
    
    function toggleButtonLoader(button, show) {
        const loader = button.querySelector('.loader');
        const text = button.querySelector('span');
        if (show) {
            button.disabled = true;
            if(loader) loader.classList.remove('hidden');
            if(text) text.style.display = 'none';
        } else {
            button.disabled = false;
            if(loader) loader.classList.add('hidden');
            if(text) text.style.display = 'inline';
        }
    }

    // --- NEW: Initialize dynamic data from spreadsheet ---
    async function initializeSignerData() {
        const result = await api('getAllUsers');
        if (result.status === 'success' && result.data) {
            allUsersCache = result.data; // Cache users for stats
            signerMap = {};
            const positions = new Set();
            result.data.forEach(user => {
                if (user.specialPosition && user.specialPosition.trim() !== '') {
                    const pos = user.specialPosition.trim();
                    positions.add(pos);
                    // Map the special position to the full name
                    signerMap[pos] = user.fullName;
                }
            });
            specialPositions = Array.from(positions).sort();
        }
    }
    
    // --- AUTHENTICATION ---
    
    $('#login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = $('#username').value.trim();
        const password = $('#password').value;
        const loginButton = $('#login-button');
        const loginError = $('#login-error');
        
        toggleButtonLoader(loginButton, true);
        loginError.classList.add('hidden');

        const result = await api('verifyCredentials', { username, password });
        
        if (result.status === 'success' && result.user) {
            currentUserProfile = result.user;
            await initializeSignerData(); // Fetch signer data after successful login
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            setupUIForUser();
        } else {
            loginError.textContent = result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            loginError.classList.remove('hidden');
        }
        toggleButtonLoader(loginButton, false);
    });
    
    $('#logout-button').addEventListener('click', () => {
        currentUserProfile = null;
        userRequestsCache = [];
        loginScreen.classList.remove('hidden');
        mainApp.classList.add('hidden');
        $('#login-form').reset();
    });

    // --- UI SETUP & NAVIGATION ---

    function setupUIForUser() {
        if (!currentUserProfile) return;
        $('#user-fullname').textContent = currentUserProfile.fullName;
        $('#user-position').textContent = currentUserProfile.position;
        if (currentUserProfile.role === 'admin') {
            $('#admin-nav-command').classList.remove('hidden');
            $('#admin-nav-management').classList.remove('hidden');
            $('#admin-nav-users').classList.remove('hidden');
        } else {
            $('#admin-nav-command').classList.add('hidden');
            $('#admin-nav-management').classList.add('hidden');
            $('#admin-nav-users').classList.add('hidden');
        }
        navigateToPage('dashboard-page');
    }

    function navigateToPage(targetPageId) {
        $$('.page-view').forEach(page => page.classList.add('hidden'));
        const targetPage = $(`#${targetPageId}`);
        if (targetPage) targetPage.classList.remove('hidden');
        $$('.nav-button').forEach(button => button.classList.toggle('active', button.dataset.target === targetPageId));
        switch (targetPageId) {
            case 'dashboard-page': loadUserRequests(); break;
            case 'form-page': resetRequestForm(); break;
            case 'memo-page': loadUserMemos(); loadRequestsForMemoDropdown(); break;
            case 'profile-page': loadProfileData(); break;
            case 'admin-users-page': if (currentUserProfile.role === 'admin') loadAllUsers(); break;
            case 'admin-memos-page': if (currentUserProfile.role === 'admin') loadAllMemos(); break;
            case 'command-generation-page': if (currentUserProfile.role === 'admin') loadAllRequestsForCommand(); break;
            case 'stats-page': loadStatsData(); break; 
        }
    }

    $('#navigation').addEventListener('click', (e) => {
        const navButton = e.target.closest('.nav-button');
        if (navButton && navButton.dataset.target) {
            navigateToPage(navButton.dataset.target);
        }
    });
    
    // --- DASHBOARD PAGE ---
    async function loadUserRequests() {
        if (!currentUserProfile) return;

        const list = $('#requests-list'), loader = $('#requests-loader'), msg = $('#no-requests-message');
        loader.classList.remove('hidden');
        list.classList.add('hidden');
        msg.classList.add('hidden');

        const result = await api('getUserRequests', { username: currentUserProfile.username });
        loader.classList.add('hidden');

        if (result.status === 'success' && result.data.length > 0) {
            userRequestsCache = result.data; // Cache the data
            renderRequests(userRequestsCache);
            list.classList.remove('hidden');
        } else {
            userRequestsCache = [];
            msg.classList.remove('hidden');
        }
    }

    function renderRequests(requests, targetElementId = 'requests-list') {
        const list = $(`#${targetElementId}`);
        if(!list) return;

        const searchTerm = targetElementId === 'requests-list' ? $('#search-requests').value.toLowerCase() : '';
        const filtered = requests.filter(r => !searchTerm || r.purpose?.toLowerCase().includes(searchTerm) || r.location?.toLowerCase().includes(searchTerm) || r.requestId?.toLowerCase().includes(searchTerm));

        if (filtered.length === 0) {
            list.innerHTML = `<p class="text-center text-gray-500 p-4">ไม่พบรายการ</p>`;
            return;
        }

        list.innerHTML = `<div class="space-y-4">${filtered.map(request => {
            let statusText, statusColor;
            switch(request.commandStatus) {
                case 'Approved': statusText = 'อนุมัติแล้ว'; statusColor = 'bg-green-100 text-green-800'; break;
                case 'Rejected': statusText = 'ปฏิเสธ'; statusColor = 'bg-red-100 text-red-800'; break;
                default: statusText = 'รออนุมัติ'; statusColor = 'bg-yellow-100 text-yellow-800';
            }
            const isDashboard = targetElementId === 'requests-list';
            return `
                <div class="p-4 border rounded-lg shadow-sm bg-white ${isDashboard ? 'hover:shadow-md transition-shadow' : ''}">
                    <div class="flex flex-wrap justify-between items-start gap-2">
                        <div>
                            <p class="font-bold text-lg text-indigo-700">${request.purpose}</p>
                            <p class="text-sm text-gray-600"><strong>สถานที่:</strong> ${request.location}</p>
                            <p class="text-sm text-gray-500"><strong>วันที่:</strong> ${formatThaiDate(request.startDate)} - ${formatThaiDate(request.endDate)}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${statusColor}">${statusText}</span>
                            <p class="text-xs text-gray-500 mt-1"><strong>เลขที่อ้างอิง:</strong> ${request.requestId || 'N/A'}</p>
                        </div>
                    </div>
                    ${isDashboard ? `
                    <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 justify-end">
                        <button class="btn btn-sm bg-gray-200 text-gray-800 edit-request-btn" data-id="${request.requestId}">แก้ไข</button>
                        ${request.pdfUrl ? `<a href="${request.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดู PDF</a>` : ''}
                        <button class="btn btn-sm btn-danger delete-request-btn" data-id="${request.requestId}">ลบ</button>
                    </div>` : ''}
                </div>`;
        }).join('')}</div>`;
    }
    
    $('#search-requests').addEventListener('input', () => renderRequests(userRequestsCache));

    $('#requests-list').addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (!id) return;

        if (e.target.classList.contains('edit-request-btn')) {
            const requestData = userRequestsCache.find(r => r.requestId === id);
            if(requestData) {
                const attendeesResult = await api('getAttendeesForRequest', { requestId: id });
                if (attendeesResult.status === 'success') {
                    requestData.attendees = attendeesResult.data;
                    navigateToPage('form-page');
                    loadRequestDataIntoForm(id, requestData);
                }
            } else {
                 showAlert('ข้อผิดพลาด', 'ไม่พบข้อมูลคำขอ');
            }
        }
        
        if (e.target.classList.contains('delete-request-btn')) {
            if (await showConfirm('ยืนยันการลบ', 'คุณต้องการลบรายการคำขอนี้ใช่หรือไม่?')) {
                await api('deleteRequest', { id });
                showAlert('สำเร็จ', 'ลบรายการคำขอเรียบร้อยแล้ว');
                loadUserRequests();
            }
        }
    });

    // --- MODALS, REGISTRATION, PROFILE ---
    const modals = {
        'register-modal': { open: $('#show-register-modal-button'), close: $('#register-modal-close-button'), el: $('#register-modal') },
        'admin-modal': { close: $('#admin-modal-close-button'), el: $('#admin-modal') },
        'alert-modal': { close: $('#alert-modal-close-button'), el: $('#alert-modal') },
        'dispatch-modal': { close: $('#dispatch-modal-close-button'), el: $('#dispatch-modal') },
        'stats-detail-modal': { close: $('#stats-detail-close-button'), el: $('#stats-detail-modal') },
        'admin-upload-memo-modal': { close: $('#admin-upload-memo-close-button'), el: $('#admin-upload-memo-modal') }

    };
    for (const key in modals) {
        const modal = modals[key];
        if (modal.open) modal.open.onclick = () => modal.el.style.display = 'flex';
        if (modal.close) modal.close.onclick = () => modal.el.style.display = 'none';
    }
    window.onclick = (event) => {
        for (const key in modals) { if (event.target == modals[key].el) modals[key].el.style.display = 'none'; }
        if (event.target == $('#confirm-modal')) $('#confirm-modal').style.display = 'none';
    };
    const registerDepartmentSelect = $('#register-department');
    registerDepartmentSelect.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
    Object.keys(DEPARTMENTS).forEach(dept => {
        const option = new Option(dept, dept);
        registerDepartmentSelect.appendChild(option);
    });

    $('#register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = $('#register-save-button'), errorEl = $('#register-error');
        const userData = {
            username: $('#register-username').value.trim(),
            password: $('#register-password').value,
            fullName: $('#register-fullname').value.trim(), // Corrected key
            position: $('#register-position').value.trim(),
            department: $('#register-department').value,
        };
        if (!userData.username || !userData.password || !userData.fullName || !userData.position || !userData.department) {
            errorEl.textContent = 'กรุณากรอกข้อมูลให้ครบถ้วน';
            errorEl.classList.remove('hidden');
            return;
        }
        toggleButtonLoader(button, true);
        errorEl.classList.add('hidden');
        await api('registerUser', userData); // Corrected action
        modals['register-modal'].el.style.display = 'none';
        e.target.reset();
        showAlert('สำเร็จ', 'สมัครใช้งานเรียบร้อยแล้ว กรุณาเข้าสู่ระบบ');
        toggleButtonLoader(button, false);
    });

    function loadProfileData() {
        if (!currentUserProfile) return;
        $('#profile-username').value = currentUserProfile.username;
        $('#profile-fullname').value = currentUserProfile.fullName;
        $('#profile-position').value = currentUserProfile.position;
        $('#profile-department').value = currentUserProfile.department;
    }

    $('#profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = $('#save-profile-button'), messageEl = $('#profile-message');
        const updatedProfile = {
            originalUsername: currentUserProfile.username,
            newUsername: $('#profile-username').value.trim(),
            fullName: $('#profile-fullname').value.trim(),
            position: $('#profile-position').value.trim(),
            department: $('#profile-department').value.trim(),
        };
        toggleButtonLoader(button, true);
        await api('updateUser', updatedProfile); // Corrected action and payload
        
        // Update local profile, especially if username changed
        currentUserProfile.username = updatedProfile.newUsername;
        currentUserProfile.fullName = updatedProfile.fullName;
        currentUserProfile.position = updatedProfile.position;
        currentUserProfile.department = updatedProfile.department;

        setupUIForUser();
        messageEl.textContent = 'บันทึกข้อมูลสำเร็จ';
        messageEl.className = 'text-green-600 mt-4 block';
        setTimeout(() => messageEl.classList.add('hidden'), 3000);

        toggleButtonLoader(button, false);
    });

    $('#password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = $('#save-password-button'), errorEl = $('#password-error'), messageEl = $('#password-message');
        const currentPassword = $('#profile-current-password').value;
        const newPassword = $('#profile-new-password').value;
        if (newPassword !== $('#profile-confirm-password').value) {
            errorEl.textContent = 'รหัสผ่านใหม่ไม่ตรงกัน';
            errorEl.classList.remove('hidden');
            return;
        }
        toggleButtonLoader(button, true);
        errorEl.classList.add('hidden');
        await api('updatePassword', { 
            username: currentUserProfile.username, 
            oldPassword: currentPassword, 
            newPassword: newPassword 
        }); // Corrected action and payload
        
        messageEl.textContent = 'เปลี่ยนรหัสผ่านสำเร็จ';
        messageEl.className = 'text-green-600 mt-4 block';
        e.target.reset();
        setTimeout(() => messageEl.classList.add('hidden'), 3000);

        toggleButtonLoader(button, false);
    });
     $('#show-password-toggle').addEventListener('change', (e) => {
        const type = e.target.checked ? 'text' : 'password';
        $('#profile-current-password').type = type;
        $('#profile-new-password').type = type;
        $('#profile-confirm-password').type = type;
    });

    // --- REQUEST FORM PAGE ---
    let attendees = [];

    function resetRequestForm() {
        $('#request-form').reset();
        $('#form-request-id').value = '';
        attendees = [];
        renderAttendees();
        $('#form-result').classList.add('hidden');
        $('#partial-expense-options').classList.add('hidden');
        $('#total-expense-container').classList.add('hidden');
        $('#private-vehicle-details').classList.add('hidden');
        $('#submit-button-text').textContent = 'บันทึกและสร้างเอกสาร';
        $('#form-doc-date').value = new Date().toISOString().split('T')[0];
        
        // NEW: Populate department from fetched special positions
        const deptSelect = $('#form-department');
        deptSelect.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
        specialPositions.forEach(pos => deptSelect.add(new Option(pos, pos)));

        if (currentUserProfile) {
            $('#form-requester-name').value = currentUserProfile.fullName;
            $('#form-requester-position').value = currentUserProfile.position;
            // Auto-select based on user's special position if available
             if (currentUserProfile.specialPosition && specialPositions.includes(currentUserProfile.specialPosition)) {
                deptSelect.value = currentUserProfile.specialPosition;
                $('#form-head-name').value = signerMap[currentUserProfile.specialPosition] || '';
            } else {
                $('#form-head-name').value = '';
            }
        }
    }

    function loadRequestDataIntoForm(id, data) {
        resetRequestForm();
        $('#form-request-id').value = id;
        $('#form-doc-date').value = data.docDate ? new Date(data.docDate).toISOString().split('T')[0] : '';
        $('#form-requester-name').value = data.requesterName;
        $('#form-requester-position').value = data.requesterPosition;
        $('#form-location').value = data.location;
        $('#form-purpose').value = data.purpose;
        $('#form-start-date').value = data.startDate ? new Date(data.startDate).toISOString().split('T')[0] : '';
        $('#form-end-date').value = data.endDate ? new Date(data.endDate).toISOString().split('T')[0] : '';
        attendees = data.attendees || [];
        renderAttendees();

        let expenseItems = [];
        try {
            expenseItems = typeof data.expenseItems === 'string' ? JSON.parse(data.expenseItems) : data.expenseItems || [];
        } catch(e) { console.error("Could not parse expense items:", data.expenseItems); }

        if (data.expenseOption === 'partial') {
            $('#expense_partial').checked = true;
            $('#partial-expense-options').classList.remove('hidden');
            $('#total-expense-container').classList.remove('hidden');
            expenseItems.forEach(item => {
                if (item.name === "ค่าใช้จ่ายอื่นๆ") {
                     $('#expense_other_check').checked = true;
                     $('#expense_other_text').value = item.detail || '';
                } else {
                    const cb = $(`input[name="expense_item"][value="${item.name}"]`);
                    if (cb) cb.checked = true;
                }
            });
            $('#form-total-expense').value = data.totalExpense ? parseFloat(data.totalExpense).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
        } else {
             $('#expense_no').checked = true;
        }
        $(`input[name="vehicle_option"][value="${data.vehicleOption}"]`).checked = true;
        if(data.vehicleOption === 'private') {
            $('#private-vehicle-details').classList.remove('hidden');
            $('#form-license-plate').value = data.licensePlate;
        }
        
        // Set department and head name
        $('#form-department').value = data.department;
        $('#form-head-name').value = data.headName;

        $('#submit-button-text').textContent = 'อัปเดตและสร้างเอกสารใหม่';
    }

    // NEW: Dynamic head name based on department selection
    $('#form-department').addEventListener('change', (e) => {
        $('#form-head-name').value = signerMap[e.target.value] || '';
    });
    $$('input[name="expense_option"]').forEach(r => r.addEventListener('change', (e) => {
        const show = e.target.value === 'partial';
        $('#partial-expense-options').classList.toggle('hidden', !show);
        $('#total-expense-container').classList.toggle('hidden', !show);
    }));
    $$('input[name="vehicle_option"]').forEach(r => r.addEventListener('change', (e) => {
        $('#private-vehicle-details').classList.toggle('hidden', e.target.value !== 'private');
    }));

    // NEW: Add input formatter for Total Expense
    $('#form-total-expense').addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9.]/g, ''); // Allow only numbers and a dot
        const parts = value.split('.');
        let integerPart = parts[0];
        let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : ''; // Keep up to 2 decimal places

        // Add commas to the integer part
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        e.target.value = integerPart + decimalPart;
    });

    function renderAttendees() {
        const list = $('#form-attendees-list');
        list.innerHTML = attendees.length ? '' : '<p class="text-sm text-gray-500 mb-2">ไม่มีผู้ร่วมเดินทาง</p>';
        attendees.forEach((att, index) => {
            const item = document.createElement('div');
            item.className = 'grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2 items-center';
            // NEW: Added list="position-options" to the position input
            item.innerHTML = `
                <input type="text" value="${att.name || ''}" class="form-input text-sm p-1" placeholder="ชื่อ-นามสกุล" data-index="${index}" data-field="name">
                <input type="text" value="${att.position || ''}" list="position-options" class="form-input text-sm p-1" placeholder="ตำแหน่ง" data-index="${index}" data-field="position">
                <button type="button" class="btn btn-danger btn-sm justify-self-start sm:justify-self-end remove-attendee-btn" data-index="${index}">ลบ</button>`;
            list.appendChild(item);
        });
    }
    $('#form-attendees-list').addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
            attendees[e.target.dataset.index][e.target.dataset.field] = e.target.value;
        }
    });
    $('#form-attendees-list').addEventListener('click', (e) => {
        const target = e.target.closest('.remove-attendee-btn');
        if (target) {
            attendees.splice(target.dataset.index, 1);
            renderAttendees();
        }
    });
    $('#form-add-attendee').addEventListener('click', () => { attendees.push({ name: '', position: '' }); renderAttendees(); });
    $('#form-download-template').addEventListener('click', () => {
        const ws = XLSX.utils.aoa_to_sheet([["name", "position"], ["นายตัวอย่าง ตั้งใจ", "ครู"]]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Attendees");
        XLSX.writeFile(wb, "attendee_template.xlsx");
    });
    $('#form-import-excel').addEventListener('click', () => $('#excel-file-input').click());
    $('#excel-file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const newAttendees = json.map(row => ({ name: row.name || row.fullname || '', position: row.position || '' })).filter(row => row.name && row.position);
            attendees = [...attendees, ...newAttendees];
            renderAttendees();
        };
        reader.readAsArrayBuffer(file);
        e.target.value = '';
    });
    
    $('#request-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = $('#submit-request-button');
        toggleButtonLoader(button, true);

        const expenseItems = [];
        if ($('#expense_partial').checked) {
            $$('input[name="expense_item"]:checked').forEach(cb => {
                let item = { name: cb.value };
                if (cb.id === 'expense_other_check' && $('#expense_other_text').value) {
                    item.detail = $('#expense_other_text').value;
                }
                expenseItems.push(item);
            });
        }
        
        const requestData = {
            id: $('#form-request-id').value,
            username: currentUserProfile.username, // Script expects username
            docDate: $('#form-doc-date').value,
            requesterName: $('#form-requester-name').value,
            requesterPosition: $('#form-requester-position').value,
            location: $('#form-location').value,
            purpose: $('#form-purpose').value,
            startDate: $('#form-start-date').value,
            endDate: $('#form-end-date').value,
            attendees: attendees,
            expenseOption: $('input[name="expense_option"]:checked').value,
            expenseItems: expenseItems, // Send structured data
            totalExpense: $('#form-total-expense').value.replace(/,/g, '') || 0, // MODIFIED: Remove commas before sending
            vehicleOption: $('input[name="vehicle_option"]:checked').value,
            licensePlate: $('#form-license-plate').value,
            department: $('#form-department').value,
            headName: $('#form-head-name').value,
        };

        try {
            await api('createRequest', requestData);
            // Since POST via iframe doesn't return data, we show a generic success and refresh
            showAlert('สำเร็จ', 'บันทึกข้อมูลและสร้างเอกสารเรียบร้อยแล้ว');
            navigateToPage('dashboard-page');
        } catch (error) {
            console.error("Form submission error: ", error);
            showAlert('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
        } finally {
            toggleButtonLoader(button, false);
        }
    });
    
    $('#go-to-memo-page-button').addEventListener('click', () => navigateToPage('memo-page'));

    // --- MEMO SUBMISSION PAGE ---
    async function loadRequestsForMemoDropdown() {
        if (!currentUserProfile) return;
        const select = $('#memo-ref-number');
        select.innerHTML = '<option value="">กำลังโหลด...</option>';
        const result = await api('getUserRequests', { username: currentUserProfile.username });
        if (result.status === 'success' && result.data.length > 0) {
            select.innerHTML = '<option value="">-- กรุณาเลือกรายการ --</option>';
            result.data
                .filter(req => req.status !== 'submitted') // Example filter
                .forEach(req => select.add(new Option(`${req.requestId} - ${req.purpose}`, req.requestId)));
        } else {
            select.innerHTML = '<option value="">ไม่พบรายการคำขอที่ยังไม่ได้ส่ง</option>';
        }
    }

    async function loadUserMemos() {
        if (!currentUserProfile) return;
        const loader = $('#memos-loader'), list = $('#memos-list'), noMsg = $('#no-memos-message');
        loader.classList.remove('hidden');
        list.classList.add('hidden');
        noMsg.classList.add('hidden');
        const result = await api('getSentMemos', { username: currentUserProfile.username });
        loader.classList.add('hidden');
        if(result.status === 'success' && result.data.length > 0) {
            list.classList.remove('hidden');
            list.innerHTML = result.data.map(renderMemoItem).join('');
        } else {
            noMsg.classList.remove('hidden');
        }
    }

    function renderMemoItem(memo) {
         let statusText, statusColor;
            switch(memo.status) {
                case 'เสร็จสิ้น/รับไฟล์ไปใช้งาน': statusText = 'เสร็จสิ้น'; statusColor = 'bg-green-100 text-green-800'; break;
                default: statusText = 'รอตรวจสอบ'; statusColor = 'bg-yellow-100 text-yellow-800';
            }
        return `
            <div class="p-3 border rounded-lg bg-gray-50 flex justify-between items-center flex-wrap gap-2">
                <div>
                    <p class="font-semibold">${memo.refNumber}</p>
                    <p class="text-sm text-gray-500">${formatThaiDate(memo.timestamp)}</p>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${statusColor}">${statusText}</span>
                    ${memo.fileUrl ? `<a href="${memo.fileUrl}" target="_blank" class="text-xs text-indigo-600 hover:underline">ต้นฉบับ</a>` : ''}
                    ${memo.completedMemoUrl ? `<a href="${memo.completedMemoUrl}" target="_blank" class="text-xs text-green-600 hover:underline">บันทึกลงนาม</a>` : ''}
                    ${memo.completedCommandUrl ? `<a href="${memo.completedCommandUrl}" target="_blank" class="text-xs text-blue-600 hover:underline">คำสั่งลงนาม</a>` : ''}
                    ${memo.dispatchBookUrl ? `<a href="${memo.dispatchBookUrl}" target="_blank" class="text-xs text-purple-600 hover:underline">หนังสือส่ง</a>` : ''}
                </div>
            </div>`;
    }

    $$('input[name="memo_type"]').forEach(r => r.addEventListener('change', (e) => {
        const requiresFile = e.target.value === 'no-reimburse';
        $('#memo-file-container').style.display = requiresFile ? 'block' : 'none';
        $('#memo-file').required = requiresFile;
    }));
    $('#memo-file').addEventListener('change', e => $('#memo-filename').textContent = e.target.files[0] ? e.target.files[0].name : '');

    $('#memo-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = $('#submit-memo-button');
        toggleButtonLoader(button, true);
        const refNumber = $('#memo-ref-number').value, memoType = $('input[name="memo_type"]:checked').value, fileInput = $('#memo-file').files[0];
        if (!refNumber) { showAlert('ข้อมูลไม่ครบ', 'กรุณาเลือกร่างคำขอ'); toggleButtonLoader(button, false); return; }
        if (memoType === 'no-reimburse' && !fileInput) { showAlert('ข้อมูลไม่ครบ', 'กรุณาแนบไฟล์บันทึกข้อความ'); toggleButtonLoader(button, false); return; }

        let fileData = null;
        if(fileInput) {
             fileData = { 
                data: await fileToBase64(fileInput), 
                filename: fileInput.name, 
                mimeType: fileInput.type 
            };
        }
        await api('uploadMemo', { refNumber, memoType, file: fileData, username: currentUserProfile.username });
        showAlert('สำเร็จ', 'ส่งบันทึกข้อความเรียบร้อยแล้ว');
        e.target.reset();
        $('#memo-filename').textContent = '';
        loadRequestsForMemoDropdown();
        loadUserMemos();
        toggleButtonLoader(button, false);
    });

    // --- ADMIN PAGES ---
    async function loadAllUsers() {
        const loader = $('#admin-loader'), list = $('#admin-users-list');
        loader.classList.remove('hidden'); list.classList.add('hidden');
        const result = await api('getAllUsers');
        loader.classList.add('hidden');
        if(result.status === 'success') {
            list.classList.remove('hidden');
            renderUsersTable(result.data);
        }
    }
    
    function renderUsersTable(users) {
        $('#admin-users-list').innerHTML = `
            <table class="min-w-full bg-white">
                <thead class="bg-gray-100"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ตำแหน่ง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สิทธิ์</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr></thead>
                <tbody class="divide-y divide-gray-200">
                    ${users.map(u => `<tr>
                        <td class="px-6 py-4 whitespace-nowrap">${u.fullName}</td> <td class="px-6 py-4 whitespace-nowrap">${u.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${u.username}</td> <td class="px-6 py-4 whitespace-nowrap">${u.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                           <button class="text-indigo-600 hover:text-indigo-900 edit-user-btn" data-username='${u.username}'>แก้ไข</button>
                           <button class="text-red-600 hover:text-red-900 ml-4 delete-user-btn" data-username='${u.username}'>ลบ</button>
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
    }

    $('#admin-users-list').addEventListener('click', async e => {
        const username = e.target.dataset.username;
        if (!username) return;

        if(e.target.classList.contains('edit-user-btn')) {
            const allUsers = (await api('getAllUsers')).data || [];
            const userData = allUsers.find(u => u.username === username);
            if (userData) openAdminModal(userData);
        }
        if(e.target.classList.contains('delete-user-btn')) {
             if (await showConfirm('ยืนยันการลบ', `คุณต้องการลบผู้ใช้ ${username} ใช่หรือไม่?`)) {
                await api('deleteUser', { username });
                showAlert('สำเร็จ', 'ลบผู้ใช้เรียบร้อยแล้ว');
                loadAllUsers();
            }
        }
    });
    $('#add-user-button').addEventListener('click', () => openAdminModal());

    function openAdminModal(userData = null) {
        const form = $('#admin-modal-form'); form.reset();
        if (userData) {
            $('#admin-modal-title').textContent = 'แก้ไขผู้ใช้';
            $('#modal-original-username').value = userData.username;
            $('#modal-username').value = userData.username;
            $('#modal-fullname').value = userData.fullName;
            $('#modal-position').value = userData.position;
            $('#modal-department').value = userData.department;
            $('#modal-role').value = userData.role;
        } else {
            $('#admin-modal-title').textContent = 'เพิ่มผู้ใช้ใหม่';
            $('#modal-original-username').value = '';
        }
        $('#admin-modal').style.display = 'flex';
    }

    $('#admin-modal-form').addEventListener('submit', async e => {
        e.preventDefault();
        const button = $('#admin-modal-save-button');
        toggleButtonLoader(button, true);
        
        const isUpdate = !!$('#modal-original-username').value;
        const action = isUpdate ? 'updateUser' : 'addUser';

        const userData = {
            fullName: $('#modal-fullname').value.trim(),
            position: $('#modal-position').value.trim(),
            department: $('#modal-department').value.trim(),
            role: $('#modal-role').value,
            password: $('#modal-password').value,
            // For updates
            originalUsername: $('#modal-original-username').value,
            newUsername: $('#modal-username').value.trim(),
            // For adds
            username: $('#modal-username').value.trim()
        };
        
        await api(action, userData);
        $('#admin-modal').style.display = 'none';
        showAlert('สำเร็จ', 'บันทึกข้อมูลผู้ใช้เรียบร้อยแล้ว');
        loadAllUsers();
        toggleButtonLoader(button, false);
    });
    
    async function loadAllMemos() {
        const loader = $('#admin-memos-loader'), list = $('#admin-memos-list'), noMsg = $('#no-admin-memos-message');
        loader.classList.remove('hidden'); list.classList.add('hidden'); noMsg.classList.add('hidden');
        const result = await api('getAllMemos');
        loader.classList.add('hidden');
        if (result.status === 'success' && result.data.length > 0) {
            list.classList.remove('hidden');
            renderMemosTable(result.data);
        } else {
            noMsg.classList.remove('hidden');
        }
    }
    
    function renderMemosTable(memos) {
        $('#admin-memos-list').innerHTML = `
            <table class="min-w-full bg-white">
                 <thead class="bg-gray-100"><tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ผู้ส่ง</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">เลขที่อ้างอิง</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">วันที่ส่ง</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">จัดการ</th>
                </tr></thead>
                <tbody class="divide-y divide-gray-200">
                    ${memos.map(memo => `<tr>
                        <td class="px-4 py-4">${memo.submittedBy}</td>
                        <td class="px-4 py-4">${memo.refNumber}</td>
                        <td class="px-4 py-4">${formatThaiDate(memo.timestamp)}</td>
                        <td class="px-4 py-4">${memo.status}</td>
                        <td class="px-4 py-4 text-right">
                           <button class="btn btn-sm btn-primary manage-memo-files-btn" data-id="${memo.memoId}">จัดการไฟล์</button>
                           ${memo.status === 'กำลังดำเนินการ' ? `<button class="btn btn-sm btn-success memo-update-status-btn" data-id="${memo.memoId}" data-status="เสร็จสิ้น/รับไฟล์ไปใช้งาน">เสร็จสิ้น</button>` : ''}
                        </td>
                    </tr>`).join('')}
                </tbody>
            </table>`;
    }

    $('#admin-memos-list').addEventListener('click', async e => {
        const memoId = e.target.dataset.id;
        if (!memoId) return;

        if (e.target.classList.contains('memo-update-status-btn')) {
            const newStatus = e.target.dataset.status;
            if (await showConfirm('ยืนยันสถานะ', `คุณต้องการอัปเดตสถานะเป็น "${newStatus}" ใช่หรือไม่?`)) {
                await api('updateMemoStatus', { id: memoId, status: newStatus });
                showAlert('สำเร็จ', 'อัปเดตสถานะเรียบร้อยแล้ว');
                loadAllMemos();
            }
        }

        if (e.target.classList.contains('manage-memo-files-btn')) {
            $('#admin-upload-memo-id').value = memoId;
            $('#admin-upload-memo-modal').style.display = 'flex';
        }
    });

    // NEW: Handle admin file uploads for memos
    $$('.upload-signed-file-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const fileType = e.target.dataset.fileType;
            const memoId = $('#admin-upload-memo-id').value;
            let fileInput;
            if (fileType === 'completedMemo') fileInput = $('#signed-memo-file');
            else if (fileType === 'completedCommand') fileInput = $('#signed-command-file');
            else if (fileType === 'dispatchBook') fileInput = $('#signed-dispatch-file');

            if (!fileInput || fileInput.files.length === 0) {
                showAlert('ข้อผิดพลาด', 'กรุณาเลือกไฟล์ก่อนอัปโหลด');
                return;
            }

            const file = fileInput.files[0];
            toggleButtonLoader(e.target, true);

            const fileData = {
                data: await fileToBase64(file),
                filename: file.name,
                mimeType: file.type
            };
            
            await api('adminUploadMemoFile', { memoId, fileData, fileType });
            showAlert('สำเร็จ', 'อัปโหลดไฟล์เรียบร้อยแล้ว');
            fileInput.value = ''; // Clear file input
            loadAllMemos(); // Refresh admin list
            toggleButtonLoader(e.target, false);
        });
    });


    async function loadAllRequestsForCommand() {
        const loader = $('#command-requests-loader'), list = $('#command-requests-list'), noMsg = $('#no-command-requests-message');
        loader.classList.remove('hidden'); list.classList.add('hidden'); noMsg.classList.add('hidden');

        const result = await api('getAllRequests');
        loader.classList.add('hidden');
        if (result.status === 'success' && result.data.length > 0) {
            list.classList.remove('hidden');
            renderCommandRequestsTable(result.data);
        } else {
            noMsg.classList.remove('hidden');
        }
    }

    function renderCommandRequestsTable(requests) {
         $('#command-requests-list').innerHTML = `
            <div class="space-y-4">
            ${requests.map(req => {
                let statusHtml, actionHtml;
                if (req.commandStatus === 'Pending Approval') {
                    statusHtml = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full bg-yellow-100 text-yellow-800">รออนุมัติ</span>`;
                    actionHtml = `
                        <div class="border-t mt-3 pt-3 space-y-3">
                            <div>
                                <h4 class="text-sm font-semibold text-gray-600 mb-1">ดูตัวอย่างคำสั่ง:</h4>
                                <div class="flex gap-3">
                                     ${req.commandPdfUrlSolo ? `<a href="${req.commandPdfUrlSolo}" target="_blank" class="text-sm text-blue-600 hover:underline">1 คน</a>` : '<span class="text-sm text-gray-400">1 คน</span>'}
                                     ${req.commandPdfUrlGroupSmall ? `<a href="${req.commandPdfUrlGroupSmall}" target="_blank" class="text-sm text-blue-600 hover:underline">2-5 คน</a>` : '<span class="text-sm text-gray-400">2-5 คน</span>'}
                                     ${req.commandPdfUrlGroupLarge ? `<a href="${req.commandPdfUrlGroupLarge}" target="_blank" class="text-sm text-blue-600 hover:underline">6+ คน</a>` : '<span class="text-sm text-gray-400">6+ คน</span>'}
                                </div>
                            </div>
                            <div class="flex items-center justify-end gap-2 flex-wrap">
                                 <select class="form-input text-sm p-1 w-36 command-template-select" data-id="${req.requestId}">
                                    <option value="">เลือกรูปแบบอนุมัติ</option>
                                    <option value="solo">1 คน</option>
                                    <option value="groupSmall">2-5 คน</option>
                                    <option value="groupLarge">6+ คน</option>
                                </select>
                                <button class="btn btn-sm btn-success approve-command-btn" data-id="${req.requestId}">อนุมัติ</button>
                            </div>
                        </div>`;
                } else {
                     statusHtml = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full bg-green-100 text-green-800">อนุมัติแล้ว</span>`;
                     actionHtml = req.commandPdfUrl ? `<div class="border-t mt-3 pt-3 text-right"><a href="${req.commandPdfUrl}" class="text-indigo-600 hover:underline" target="_blank">ดูคำสั่งที่อนุมัติแล้ว</a></div>` : '';
                }

                return `
                    <div class="p-4 border rounded-lg shadow-sm bg-white">
                        <div class="flex flex-wrap justify-between items-start gap-2">
                            <div>
                                <p class="font-bold text-gray-800">${req.purpose}</p>
                                <p class="text-sm text-gray-600">${req.requesterName} | ${formatThaiDate(req.startDate)}</p>
                            </div>
                            <div class="text-right">
                                ${statusHtml}
                                <p class="text-xs text-gray-500 mt-1">ID: ${req.requestId}</p>
                            </div>
                        </div>
                        ${actionHtml}
                    </div>
                `;
            }).join('')}
            </div>`;
    }

    $('#command-requests-list').addEventListener('click', async (e) => {
        const requestId = e.target.closest('[data-id]')?.dataset.id;
        if (!requestId) return;

        if (e.target.classList.contains('approve-command-btn')) {
            const select = e.target.parentElement.querySelector('.command-template-select');
            const templateType = select.value;
            if (!templateType) {
                showAlert('ข้อมูลไม่ครบ', 'กรุณาเลือกรูปแบบคำสั่งที่จะอนุมัติ');
                return;
            }
            if (await showConfirm('ยืนยันอนุมัติ', 'คุณต้องการอนุมัติคำสั่งนี้ใช่หรือไม่?')) {
                await api('approveCommand', { requestId, templateType });
                showAlert('สำเร็จ', 'อนุมัติคำสั่งเรียบร้อยแล้ว');
                loadAllRequestsForCommand();
            }
        }

        if (e.target.classList.contains('generate-dispatch-btn')) {
            openDispatchModal(requestId);
        }
    });

    function openDispatchModal(requestId) {
        const currentYear = new Date().getFullYear() + 543;
        $('#dispatch-form').reset();
        $('#dispatch-request-id').value = requestId;
        $('#dispatch-year').value = currentYear;
        $('#dispatch-modal').style.display = 'flex';
    }

    $('#dispatch-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const button = e.target.querySelector('button[type="submit"]');
        toggleButtonLoader(button, true);

        const payload = {
            requestId: $('#dispatch-request-id').value,
            dispatchMonth: $('#dispatch-month').value,
            dispatchYear: $('#dispatch-year').value,
            commandCount: $('#command-count').value,
            memoCount: $('#memo-count').value,
        };
        await api('generateDispatchBook', payload);
        $('#dispatch-modal').style.display = 'none';
        showAlert('สำเร็จ', 'สร้างหนังสือส่งเรียบร้อยแล้ว (อาจใช้เวลาสักครู่ในการสร้างไฟล์)');
        loadAllRequestsForCommand();
        toggleButtonLoader(button, false);
    });

    // --- REFACTORED: STATS PAGE ---

    function showStatsDetailModal(title, detailedRequests) {
        $('#stats-detail-title').textContent = title;
        renderRequests(detailedRequests, 'stats-detail-list'); // Reuse renderRequests function
        $('#stats-detail-modal').style.display = 'flex';
    }

    function createStatCard(title, iconSvg, data, filterKey, isSortable = true) {
        let itemsHtml = '';
        const sortedData = isSortable ? data.sort(([, a], [, b]) => b - a) : data;

        sortedData.forEach(([label, count]) => {
            itemsHtml += `
                <div class="flex justify-between items-center p-3 bg-gray-50 hover:bg-indigo-50 rounded-md cursor-pointer stat-item" data-filter-key="${filterKey}" data-filter-value="${label}">
                    <span class="text-gray-700 truncate">${label}</span>
                    <span class="font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full text-sm">${count}</span>
                </div>`;
        });

        return `
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center mb-4">
                    ${iconSvg}
                    <h3 class="text-xl font-semibold text-gray-800 ml-3">${title}</h3>
                </div>
                <div class="space-y-2 max-h-80 overflow-y-auto pr-2">
                    ${itemsHtml || '<p class="text-center text-gray-500 py-4">ไม่มีข้อมูล</p>'}
                </div>
            </div>`;
    }
    
    async function loadStatsData() {
        const loader = $('#stats-loader'), content = $('#stats-content');
        loader.classList.remove('hidden');
        content.classList.add('hidden');

        // Fetch both requests and users for accurate department mapping
        const [requestsResult, usersResult] = await Promise.all([
            api('getAllRequests'),
            api('getAllUsers')
        ]);
        
        loader.classList.add('hidden');
        if(requestsResult.status === 'success' && requestsResult.data && usersResult.status === 'success' && usersResult.data) {
            allRequestsCache = requestsResult.data; 
            allUsersCache = usersResult.data; // Cache all users
            content.classList.remove('hidden');

            const userDeptMap = allUsersCache.reduce((map, user) => {
                map[user.username] = user.department || 'ไม่ระบุ';
                return map;
            }, {});

            const iconUser = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;
            const iconDept = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>`;
            const iconYear = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`;
            const iconExpense = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`;

            // 1. By Requester
            const byRequester = allRequestsCache.reduce((acc, req) => {
                const key = req.requesterName || 'ไม่ระบุ';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});
            const requesterCard = createStatCard('ตามผู้ขอไปราชการ', iconUser, Object.entries(byRequester), 'requesterName');

            // 2. By Department (MODIFIED LOGIC)
            const byDepartment = allRequestsCache.reduce((acc, req) => {
                const userDepartment = userDeptMap[req.createdBy] || 'ไม่ระบุ';
                acc[userDepartment] = (acc[userDepartment] || 0) + 1;
                return acc;
            }, {});
            const departmentCard = createStatCard('ตามกลุ่มสาระการเรียนรู้', iconDept, Object.entries(byDepartment), 'department');

            // 3. By Year
            const byYear = allRequestsCache.reduce((acc, req) => {
                const year = new Date(req.docDate).getFullYear() + 543;
                const key = `พ.ศ. ${year}`;
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});
            const yearCard = createStatCard('ตามปี (พ.ศ.)', iconYear, Object.entries(byYear), 'year', false);

            // 4. By Expense Type
            const byExpense = allRequestsCache.reduce((acc, req) => {
                const key = req.expenseOption === 'partial' ? 'เบิก' : 'ไม่เบิก';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});
            const expenseCard = createStatCard('ตามการเบิกค่าใช้จ่าย', iconExpense, Object.entries(byExpense), 'expenseOption', false);

            content.innerHTML = requesterCard + departmentCard + yearCard + expenseCard;

        } else {
            content.innerHTML = `<p class="md:col-span-2 text-center text-red-500">ไม่สามารถโหลดข้อมูลสถิติได้</p>`;
            content.classList.remove('hidden');
        }
    }
    
    // Add single event listener for all stat sections
    $('#stats-content').addEventListener('click', (e) => {
        const item = e.target.closest('.stat-item');
        if (!item) return;

        const key = item.dataset.filterKey;
        const value = item.dataset.filterValue;
        let filteredRequests = [];
        let modalTitle = '';

        switch (key) {
            case 'requesterName':
                modalTitle = `รายการของ: ${value}`;
                filteredRequests = allRequestsCache.filter(r => r.requesterName === value);
                break;
            case 'department':
                const userDeptMap = allUsersCache.reduce((map, user) => {
                    map[user.username] = user.department || 'ไม่ระบุ';
                    return map;
                }, {});
                modalTitle = `รายการของ: ${value}`;
                filteredRequests = allRequestsCache.filter(r => userDeptMap[r.createdBy] === value);
                break;
            case 'year':
                const yearBE = parseInt(value.replace('พ.ศ. ', ''));
                const yearCE = yearBE - 543;
                modalTitle = `รายการในปี: ${value}`;
                filteredRequests = allRequestsCache.filter(r => new Date(r.docDate).getFullYear() === yearCE);
                break;
            case 'expenseOption':
                const expenseType = value === 'เบิก' ? 'partial' : 'no';
                modalTitle = `รายการที่: ${value}`;
                filteredRequests = allRequestsCache.filter(r => r.expenseOption === expenseType);
                break;
        }

        if (filteredRequests.length > 0) {
            showStatsDetailModal(modalTitle, filteredRequests);
        }
    });


</script>

</body>
</html>

