<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.15s ease-in-out; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .form-label { font-weight: bold; color: #374151; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        fieldset { border-color: #e5e7eb; }
        legend { background-color: #f3f4f6; padding: 0.25rem 1rem; border-radius: 9999px; font-weight: 700; color: #4f46e5; font-size: 1.125rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; padding: 0.6rem 1.25rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 0.75rem; }
        .nav-button.active { background-color: #e0e7ff; border: 2px solid #4f46e5; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <div id="login-screen" class="max-w-md mx-auto mt-10 p-8 rounded-2xl shadow-2xl main-container">
            <div class="text-center mb-8">
                <img src="https://www.wny.ac.th/wny/storage/2025/03/Branner-WNY-Thai.png" alt="Logo" class="mx-auto h-28 mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WNY App ไปราชการ</h1>
                <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="form-label">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">รหัสผ่าน (Password)</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-full text-lg">
                    <div id="login-loader" class="loader hidden"></div>
                    <span id="login-button-text">เข้าสู่ระบบ</span>
                </button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
             <p class="text-center mt-4 text-sm text-gray-600">
                ยังไม่มีบัญชี? <button type="button" id="show-register-modal-button" class="font-semibold text-indigo-600 hover:text-indigo-500">สมัครใช้งานที่นี่</button>
            </p>
        </div>

        <div id="main-app" class="hidden">
            <header class="p-4 bg-white rounded-xl shadow-lg mb-6 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">ยินดีต้อนรับ, <span id="user-fullname"></span></h2>
                    <p class="text-sm text-gray-500">ตำแหน่ง: <span id="user-position"></span></p>
                </div>
                <button id="logout-button" class="btn btn-danger">ออกจากระบบ</button>
            </header>

            <div id="navigation" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 mb-6">
                <button data-target="dashboard-page" id="user-nav-dashboard" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition active">
                    <h3 class="font-bold text-indigo-700">แดชบอร์ด</h3>
                    <p class="text-xs text-gray-500">ภาพรวมของคุณ</p>
                </button>
                <button data-target="form-page" id="user-nav-form" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ร่างคำขอไปราชการ</h3>
                    <p class="text-xs text-gray-500">สร้างบันทึกข้อความ</p>
                </button>
                <button data-target="memo-page" id="user-nav-memo" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ส่งบันทึกข้อความ</h3>
                    <p class="text-xs text-gray-500">อัพโหลดไฟล์</p>
                </button>
                <button data-target="command-generation-page" id="admin-nav-command" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-purple-700">จัดการคำสั่ง</h3>
                    <p class="text-xs text-gray-500">อนุมัติคำสั่งราชการ</p>
                </button>
                <button data-target="admin-memos-page" id="admin-nav-management" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการบันทึกข้อความ</h3>
                    <p class="text-xs text-gray-500">รายการที่ส่งแล้ว</p>
                </button>
                 <button data-target="stats-page" id="nav-stats" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-green-700">สถิติข้อมูล</h3>
                    <p class="text-xs text-gray-500">สรุปภาพรวม</p>
                </button>
                <button data-target="profile-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ข้อมูลส่วนตัว</h3>
                    <p class="text-xs text-gray-500">จัดการข้อมูลของคุณ</p>
                </button>
                <button id="admin-nav-users" data-target="admin-users-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการผู้ใช้</h3>
                    <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
                </button>
            </div>

            <main id="page-content" class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg">
                <div id="dashboard-page" class="page-view">
                    <h2 class="text-2xl font-bold mb-4">รายการคำขอไปราชการของฉัน</h2>
                    <input type="text" id="search-requests" class="form-input mb-4" placeholder="ค้นหาตามวัตถุประสงค์, สถานที่, เลขอ้างอิง...">
                    <div id="requests-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                    </div>
                    <div id="requests-list" class="hidden"></div>
                    <p id="no-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบรายการคำขอของคุณ</p>
                </div>

                <div id="form-page" class="page-view hidden">
                     <form id="request-form">
                          <input type="hidden" id="form-request-id">
                           <fieldset class="border p-4 rounded-lg mb-6"><legend>ข้อมูลทั่วไป</legend>
                               <div><label for="form-doc-date" class="form-label">วันที่</label><input type="date" id="form-doc-date" class="form-input" required></div>
                          </fieldset>
                         <fieldset class="border p-4 rounded-lg mb-6"><legend>1. รายละเอียดการไปราชการ</legend>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                   <div><label for="form-requester-name" class="form-label">ชื่อ-นามสกุลผู้ขอ</label><input type="text" id="form-requester-name" class="form-input" required></div>
                                   <div><label for="form-requester-position" class="form-label">ตำแหน่ง</label><input type="text" id="form-requester-position" class="form-input" required></div>
                              </div>
                             <div class="mt-4"><label for="form-location" class="form-label">ขออนุญาตไปราชการ ณ สถานที่</label><input type="text" id="form-location" class="form-input" required></div>
                             <div class="mt-4"><label for="form-purpose" class="form-label">เพื่อ</label><textarea id="form-purpose" rows="2" class="form-input" required></textarea></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                   <div><label for="form-start-date" class="form-label">ตั้งแต่วันที่</label><input type="date" id="form-start-date" class="form-input" required></div>
                                   <div><label for="form-end-date" class="form-label">ถึงวันที่</label><input type="date" id="form-end-date" class="form-input" required></div>
                              </div>
                         </fieldset>
                           <fieldset class="border p-4 rounded-lg mb-6"><legend>ผู้ร่วมเดินทาง (ถ้ามี)</legend>
                               <div id="form-attendees-list"></div>
                               <div class="flex flex-wrap gap-2 mt-4">
                                   <button type="button" id="form-add-attendee" class="btn btn-success w-full sm:w-auto"><span>+ เพิ่มผู้ร่วมเดินทาง</span></button>
                                   <button type="button" id="form-import-excel" class="btn btn-primary w-full sm:w-auto"><span>นำเข้าจาก Excel</span></button>
                                   <button type="button" id="form-download-template" class="btn bg-gray-500 text-white hover:bg-gray-600 w-full sm:w-auto"><span>ดาวน์โหลดแม่แบบ</span></button>
                                   <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                               </div>
                         </fieldset>
                           <fieldset class="border p-4 rounded-lg mb-6"><legend>2. การเบิกค่าใช้จ่าย</legend>
                               <div class="space-y-3">
                                   <div><input type="radio" id="expense_no" name="expense_option" value="no" checked class="h-4 w-4"><label for="expense_no" class="ml-2">ไม่ขอเบิกค่าใช้จ่าย</label></div>
                                   <div><input type="radio" id="expense_partial" name="expense_option" value="partial" class="h-4 w-4"><label for="expense_partial" class="ml-2">ขอเบิกเฉพาะค่าใช้จ่าย</label></div>
                              </div>
                             <div id="partial-expense-options" class="pl-6 mt-3 hidden space-y-2">
                                 <label class="block"><input type="checkbox" name="expense_item" value="ค่าเบี้ยเลี้ยง" class="rounded"> ค่าเบี้ยเลี้ยง</label>
                                 <label class="block"><input type="checkbox" name="expense_item" value="ค่าที่พัก" class="rounded"> ค่าที่พัก</label>
                                 <label class="block"><input type="checkbox" name="expense_item" value="ค่าพาหนะ" class="rounded"> ค่าพาหนะ</label>
                                 <label class="block"><input type="checkbox" name="expense_item" value="ค่าน้ำมัน" class="rounded"> ค่าน้ำมัน</label>
                                 <div class="flex items-center gap-2"><label><input type="checkbox" name="expense_item" id="expense_other_check" value="ค่าใช้จ่ายอื่นๆ" class="rounded"> ค่าใช้จ่ายอื่นๆ</label><input type="text" id="expense_other_text" class="form-input text-sm p-1 flex-grow" placeholder="ระบุ"></div>
                             </div>
                             <div id="total-expense-container" class="mt-4 hidden"><label for="form-total-expense" class="form-label">รวมเป็นจำนวนเงิน (บาท)</label><input type="number" id="form-total-expense" class="form-input w-full md:w-1/2" placeholder="0.00" step="0.01"></div>
                         </fieldset>
                           <fieldset class="border p-4 rounded-lg mb-6"><legend>3. การเดินทาง</legend>
                               <div class="space-y-3">
                                   <div><input type="radio" id="vehicle_gov" name="vehicle_option" value="gov" checked class="h-4 w-4"><label for="vehicle_gov" class="ml-2">รถยนต์ราชการ (รถโรงเรียน)</label></div>
                                   <div><input type="radio" id="vehicle_private" name="vehicle_option" value="private" class="h-4 w-4"><label for="vehicle_private" class="ml-2">รถยนต์ส่วนตัว</label></div>
                                   <div id="private-vehicle-details" class="pl-8 mt-2 hidden"><label for="form-license-plate" class="form-label">หมายเลขทะเบียน</label><input type="text" id="form-license-plate" class="form-input w-full md:w-1/2"></div>
                                   <div><input type="radio" id="vehicle_public" name="vehicle_option" value="public" class="h-4 w-4"><label for="vehicle_public" class="ml-2">พาหนะอื่นๆ</label></div>
                              </div>
                         </fieldset>
                           <fieldset id="signer-fieldset" class="border p-4 rounded-lg mb-6"><legend>5. ข้อมูลผู้ลงนาม</legend>
                               <div class="mb-4"><label for="form-department" class="form-label">กลุ่มสาระฯ / งาน</label><input type="text" id="form-department" class="form-input" required></div>
                               <div><label for="form-head-name" class="form-label">ชื่อหัวหน้ากลุ่มสาระ / หัวหน้างาน</label><input type="text" id="form-head-name" class="form-input"></div>
                         </fieldset>
                         <div class="text-center mt-10 border-t pt-6 border-gray-200">
                               <button type="submit" id="submit-request-button" class="btn btn-primary w-full sm:w-auto text-lg">
                                 <div id="submit-loader" class="loader hidden"></div>
                                 <span id="submit-button-text">บันทึกและสร้างเอกสาร</span>
                             </button>
                         </div>
                    </form>
                      <div id="form-result" class="hidden mt-6 p-6 text-center">
                          <h3 id="form-result-title" class="font-bold text-lg"></h3>
                          <p id="form-result-message" class="mt-2 text-gray-700"></p>
                           <div class="flex justify-center flex-wrap gap-4 mt-4">
                                <a id="form-result-link" href="#" target="_blank" class="btn btn-success">เปิดไฟล์ PDF</a>
                                <button type="button" id="go-to-memo-page-button" class="btn btn-primary">ไปที่หน้าส่งบันทึกข้อความ</button>
                            </div>
                      </div>
                </div>

                <div id="memo-page" class="page-view hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl font-bold mb-4">ส่งบันทึกข้อความใหม่</h2>
                            <form id="memo-form">
                                <fieldset class="border p-4 rounded-lg bg-white">
                                    <legend>อัพโหลดไฟล์และกรอกข้อมูล</legend>
                                    <div class="mb-4">
                                        <label for="memo-ref-number" class="form-label">เลือกร่างคำขอ (เลขที่อ้างอิง)</label>
                                        <select id="memo-ref-number" class="form-input" required></select>
                                    </div>
                                     <div class="mb-4">
                                        <label class="form-label">ประเภทการส่ง</label>
                                        <div class="flex gap-4 mt-2">
                                            <div><input type="radio" id="memo-type-no-reimburse" name="memo_type" value="no-reimburse" checked><label for="memo-type-no-reimburse" class="ml-2">ไม่เบิก (ต้องแนบไฟล์)</label></div>
                                            <div><input type="radio" id="memo-type-reimburse" name="memo_type" value="reimburse"><label for="memo-type-reimburse" class="ml-2">เบิก (ไม่ต้องแนบไฟล์)</label></div>
                                        </div>
                                    </div>
                                    <div id="memo-file-container" class="mb-6"><label for="memo-file" class="form-label">ไฟล์บันทึกข้อความ (PDF เท่านั้น)</label><input type="file" id="memo-file" class="form-input" accept="application/pdf" required><span id="memo-filename" class="text-sm text-gray-500 mt-1 block"></span></div>
                                    <button type="submit" id="submit-memo-button" class="btn btn-primary w-full"><div id="memo-submit-loader" class="loader hidden"></div><span id="memo-submit-button-text">ส่งบันทึกข้อความ</span></button>
                                </fieldset>
                            </form>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-4">รายการที่ส่งแล้ว</h2>
                            <div id="memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                            <div id="memos-list" class="hidden space-y-3"></div>
                            <p id="no-memos-message" class="text-center text-gray-500 p-8 hidden">ยังไม่มีรายการที่ส่ง</p>
                        </div>
                    </div>
                </div>

                <div id="profile-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">ข้อมูลส่วนตัว</h2>
                      <form id="profile-form">
                         <div class="mb-4"><label for="profile-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="profile-username" class="form-input" required></div>
                          <div class="mb-4"><label for="profile-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="profile-fullname" class="form-input" required></div>
                          <div class="mb-4"><label for="profile-position" class="form-label">ตำแหน่ง</label><input type="text" id="profile-position" class="form-input" required></div>
                        <div class="mb-6"><label for="profile-department" class="form-label">กลุ่มสาระการเรียนรู้/กลุ่มงาน</label><input type="text" id="profile-department" class="form-input" required></div>
                        <button type="submit" id="save-profile-button" class="btn btn-primary"><div id="profile-loader" class="loader hidden"></div><span id="profile-button-text">บันทึกข้อมูล</span></button>
                          <p id="profile-message" class="text-green-600 mt-4 hidden"></p>
                    </form>
                    
                    <h2 class="text-2xl font-bold mb-4 mt-10 border-t pt-6">เปลี่ยนรหัสผ่าน</h2>
                    <form id="password-form">
                        <div class="mb-4 relative">
                            <label for="profile-current-password" class="form-label">รหัสผ่านปัจจุบัน</label>
                            <input type="password" id="profile-current-password" class="form-input" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="profile-new-password" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" id="profile-new-password" class="form-input" required>
                        </div>
                        <div class="mb-6 relative">
                            <label for="profile-confirm-password" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                            <input type="password" id="profile-confirm-password" class="form-input" required>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-password-toggle" class="form-checkbox h-5 w-5 text-indigo-600">
                                <span class="ml-2 text-gray-700">แสดงรหัสผ่าน</span>
                            </label>
                        </div>
                        <button type="submit" id="save-password-button" class="btn btn-primary">
                            <div id="password-loader" class="loader hidden"></div>
                            <span id="password-button-text">เปลี่ยนรหัสผ่าน</span>
                        </button>
                        <p id="password-message" class="text-green-600 mt-4 hidden"></p>
                        <p id="password-error" class="text-red-500 mt-4 hidden"></p>
                    </form>
                </div>
                
                <div id="admin-users-page" class="page-view hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-2xl font-bold">จัดการผู้ใช้งาน</h2>
                        <div class="flex gap-2">
                             <button id="import-users-button" class="btn btn-primary">นำเข้าจาก Excel</button>
                             <button id="download-user-template-button" class="btn bg-gray-500 text-white hover:bg-gray-600">ดาวน์โหลดแม่แบบ</button>
                             <button id="add-user-button" class="btn btn-success">เพิ่มผู้ใช้ใหม่</button>
                             <input type="file" id="user-excel-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <div id="admin-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลผู้ใช้...</p></div>
                    <div id="admin-users-list" class="hidden overflow-x-auto"></div>
                </div>

                 <div id="admin-memos-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการบันทึกข้อความที่ส่งแล้ว</h2>
                    <div id="admin-memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                    <div id="admin-memos-list" class="hidden overflow-x-auto"></div>
                    <p id="no-admin-memos-message" class="text-center text-gray-500 p-8 hidden">ไม่พบบันทึกข้อความ</p>
                </div>

                <div id="command-generation-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการคำสั่งไปราชการ</h2>
                    <div id="command-requests-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดร่างคำขอทั้งหมด...</p></div>
                    <div id="command-requests-list" class="hidden overflow-x-auto"></div>
                    <p id="no-command-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบร่างคำขอ</p>
                </div>
                
                <div id="stats-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">สรุปสถิติข้อมูลทั้งหมด</h2>
                    <div id="stats-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังประมวลผลข้อมูลสถิติ...</p>
                    </div>
                    <div id="stats-content" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            <p>พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">สมัครใช้งานใหม่</h3>
            <form id="register-form">
                <div class="mb-4"><label for="register-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="register-username" class="form-input" required></div>
                 <div class="mb-4"><label for="register-password" class="form-label">รหัสผ่าน (Password)</label><input type="password" id="register-password" class="form-input" required></div>
                 <div class="mb-4"><label for="register-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="register-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="register-position" class="form-label">ตำแหน่ง</label><input type="text" id="register-position" class="form-input" required></div>
                 <div class="mb-4">
                    <label for="register-department" class="form-label">กลุ่มสาระการเรียนรู้</label>
                    <select id="register-department" class="form-input" required>
                        <option value="">-- กรุณาเลือก --</option>
                        <option value="กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี">กลุ่มสาระการเรียนรู้วิทยาศาสตร์และเทคโนโลยี</option>
                        <option value="กลุ่มสาระการเรียนรู้คณิตศาสตร์">กลุ่มสาระการเรียนรู้คณิตศาสตร์</option>
                        <option value="กลุ่มสาระการเรียนรู้ภาษาไทย">กลุ่มสาระการเรียนรู้ภาษาไทย</option>
                        <option value="กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ">กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ</option>
                        <option value="กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม">กลุ่มสาระการเรียนรู้สังคมศึกษา ศาสนา และวัฒนธรรม</option>
                        <option value="กลุ่มสาระการเรียนรู้ศิลปะ">กลุ่มสาระการเรียนรู้ศิลปะ</option>
                        <option value="กลุ่มสาระการเรียนรู้การงานอาชีพ">กลุ่มสาระการเรียนรู้การงานอาชีพ</option>
                        <option value="กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา">กลุ่มสาระการเรียนรู้สุขศึกษาและพลศึกษา</option>
                    </select>
                </div>
                <p id="register-error" class="text-red-500 mb-4 hidden"></p>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="register-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="register-save-button" class="btn btn-primary"><div id="register-loader" class="loader hidden"></div><span id="register-button-text">สมัครใช้งาน</span></button></div>
            </form>
        </div>
    </div>
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 id="admin-modal-title" class="text-xl font-bold mb-4">เพิ่มผู้ใช้ใหม่</h3>
            <form id="admin-modal-form">
                <input type="hidden" id="modal-original-username">
                <div class="mb-4"><label for="modal-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="modal-username" class="form-input" required></div>
                <div class="mb-4"><label for="modal-password" class="form-label">รหัสผ่าน (เว้นว่างไว้หากไม่ต้องการเปลี่ยน)</label><input type="password" id="modal-password" class="form-input" placeholder="รหัสผ่านใหม่"></div>
                 <div class="mb-4"><label for="modal-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="modal-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-position" class="form-label">ตำแหน่ง</label><input type="text" id="modal-position" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-department" class="form-label">กลุ่มสาระฯ/งาน</label><input type="text" id="modal-department" class="form-input" required></div>
                 <div class="mb-4">
                    <label for="modal-role" class="form-label">สิทธิ์</label>
                    <select id="modal-role" class="form-input"><option value="user">User</option><option value="admin">Admin</option></select>
                </div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="admin-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="admin-modal-save-button" class="btn btn-primary"><div id="admin-modal-loader" class="loader hidden"></div><span id="admin-modal-button-text">บันทึก</span></button></div>
            </form>
        </div>
    </div>
    <div id="alert-modal" class="modal"><div class="modal-content text-center"><h3 id="alert-modal-title" class="text-xl font-bold mb-4"></h3><p id="alert-modal-message" class="mb-6"></p><button id="alert-modal-close-button" class="btn btn-primary">ตกลง</button></div></div>
    <div id="confirm-modal" class="modal"><div class="modal-content text-center"><h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3><p id="confirm-modal-message" class="mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-modal-no-button" class="btn bg-gray-300">ยกเลิก</button><button id="confirm-modal-yes-button" class="btn btn-danger">ยืนยัน</button></div></div></div>
    
    <div id="dispatch-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">ออกหนังสือส่ง</h3>
            <form id="dispatch-form">
                <input type="hidden" id="dispatch-request-id">
                <div class="mb-4">
                    <label for="dispatch-month" class="form-label">เดือน</label>
                    <select id="dispatch-month" class="form-input" required>
                        <option value="มกราคม">มกราคม</option>
                        <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                        <option value="มีนาคม">มีนาคม</option>
                        <option value="เมษายน">เมษายน</option>
                        <option value="พฤษภาคม">พฤษภาคม</option>
                        <option value="มิถุนายน">มิถุนายน</option>
                        <option value="กรกฎาคม">กรกฎาคม</option>
                        <option value="สิงหาคม">สิงหาคม</option>
                        <option value="กันยายน">กันยายน</option>
                        <option value="ตุลาคม">ตุลาคม</option>
                        <option value="พฤศจิกายน">พฤศจิกายน</option>
                        <option value="ธันวาคม">ธันวาคม</option>
                    </select>
                </div>
                <div class="mb-4"><label for="dispatch-year" class="form-label">ปี (พ.ศ.)</label><input type="number" id="dispatch-year" class="form-input" required></div>
                <div class="mb-4"><label for="dispatch-command-count" class="form-label">จำนวนคำสั่งแนบ</label><input type="number" id="dispatch-command-count" class="form-input" required value="0"></div>
                <div class="mb-4"><label for="dispatch-memo-count" class="form-label">จำนวนบันทึกแนบ</label><input type="number" id="dispatch-memo-count" class="form-input" required value="0"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="dispatch-modal-close-button" class="btn bg-gray-300">ยกเลิก</button>
                    <button type="submit" id="dispatch-modal-save-button" class="btn btn-primary">
                        <div id="dispatch-modal-loader" class="loader hidden"></div>
                        <span id="dispatch-modal-button-text">สร้างหนังสือส่ง</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="stats-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="stats-detail-title" class="text-xl font-bold"></h3>
                <button id="stats-detail-close-button" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="stats-detail-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-1"></div>
        </div>
    </div>


<script>
    // This function is called by the onchange event in the admin memos list
    function toggleFileUpload(selectElement) {
        const uploadContainer = document.querySelector(`.upload-container[data-id="${selectElement.dataset.id}"]`);
        if (uploadContainer) {
            uploadContainer.classList.toggle('hidden', selectElement.value !== 'เสร็จสิ้น/รับไฟล์ไปใช้งาน');
        }
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCwt7IDdsYLs3YL_UtG7PopArnKksYIJIOv_H4W63kan8o5Hnuhl8EUjS-9pumf7MxeA/exec";

    const state = {
        currentUser: null,
        userRequests: [],
        allUsers: [],
        sentMemos: [],
        allUserRequests: [],
        allMemos: [],
    };

    const elements = {
        loginScreen: document.getElementById('login-screen'), mainApp: document.getElementById('main-app'),
        loginForm: document.getElementById('login-form'), loginButton: document.getElementById('login-button'),
        loginLoader: document.getElementById('login-loader'), loginButtonText: document.getElementById('login-button-text'),
        loginError: document.getElementById('login-error'), logoutButton: document.getElementById('logout-button'),
        userFullname: document.getElementById('user-fullname'), userPosition: document.getElementById('user-position'),
        navButtons: document.querySelectorAll('.nav-button'), pageViews: document.querySelectorAll('.page-view'),
        userNavDashboard: document.getElementById('user-nav-dashboard'), userNavForm: document.getElementById('user-nav-form'),
        userNavMemo: document.getElementById('user-nav-memo'), adminNavManagement: document.getElementById('admin-nav-management'),
        adminNavUsers: document.getElementById('admin-nav-users'), adminNavCommand: document.getElementById('admin-nav-command'),
        adminNavStats: document.getElementById('admin-nav-stats'),
        dashboardPage: document.getElementById('dashboard-page'),
        requestsLoader: document.getElementById('requests-loader'),
        requestsList: document.getElementById('requests-list'), noRequestsMessage: document.getElementById('no-requests-message'),
        searchRequests: document.getElementById('search-requests'),
        profilePage: document.getElementById('profile-page'), profileForm: document.getElementById('profile-form'),
        profileUsername: document.getElementById('profile-username'), profileFullname: document.getElementById('profile-fullname'),
        profilePosition: document.getElementById('profile-position'), profileDepartment: document.getElementById('profile-department'),
        saveProfileButton: document.getElementById('save-profile-button'), profileLoader: document.getElementById('profile-loader'),
        profileButtonText: document.getElementById('profile-button-text'), profileMessage: document.getElementById('profile-message'),
        passwordForm: document.getElementById('password-form'),
        savePasswordButton: document.getElementById('save-password-button'),
        passwordLoader: document.getElementById('password-loader'),
        passwordButtonText: document.getElementById('password-button-text'),
        passwordMessage: document.getElementById('password-message'),
        passwordError: document.getElementById('password-error'),
        showPasswordToggle: document.getElementById('show-password-toggle'),
        formPage: document.getElementById('form-page'), requestForm: document.getElementById('request-form'),
        submitRequestButton: document.getElementById('submit-request-button'), submitLoader: document.getElementById('submit-loader'),
        submitButtonText: document.getElementById('submit-button-text'), formResult: document.getElementById('form-result'),
        formResultTitle: document.getElementById('form-result-title'), formResultMessage: document.getElementById('form-result-message'),
        formResultLink: document.getElementById('form-result-link'),
        formImportExcel: document.getElementById('form-import-excel'),
        excelFileInput: document.getElementById('excel-file-input'), formDownloadTemplate: document.getElementById('form-download-template'),
        formAddAttendee: document.getElementById('form-add-attendee'), formAttendeesList: document.getElementById('form-attendees-list'),
        adminUsersPage: document.getElementById('admin-users-page'), adminLoader: document.getElementById('admin-loader'),
        adminUsersList: document.getElementById('admin-users-list'), addUserButton: document.getElementById('add-user-button'),
        importUsersButton: document.getElementById('import-users-button'),
        downloadUserTemplateButton: document.getElementById('download-user-template-button'),
        userExcelInput: document.getElementById('user-excel-input'),
        memoPage: document.getElementById('memo-page'), memoForm: document.getElementById('memo-form'),
        submitMemoButton: document.getElementById('submit-memo-button'), memoSubmitLoader: document.getElementById('memo-submit-loader'),
        memoSubmitButtonText: document.getElementById('memo-submit-button-text'), memoFile: document.getElementById('memo-file'),
        memoFilename: document.getElementById('memo-filename'), memosLoader: document.getElementById('memos-loader'),
        memosList: document.getElementById('memos-list'), noMemosMessage: document.getElementById('no-memos-message'),
        adminMemosPage: document.getElementById('admin-memos-page'), adminMemosLoader: document.getElementById('admin-memos-loader'),
        adminMemosList: document.getElementById('admin-memos-list'), noAdminMemosMessage: document.getElementById('no-admin-memos-message'),
        commandGenerationPage: document.getElementById('command-generation-page'),
        commandRequestsLoader: document.getElementById('command-requests-loader'),
        commandRequestsList: document.getElementById('command-requests-list'),
        noCommandRequestsMessage: document.getElementById('no-command-requests-message'),
        statsPage: document.getElementById('stats-page'),
        statsLoader: document.getElementById('stats-loader'),
        statsContent: document.getElementById('stats-content'),
        registerModal: document.getElementById('register-modal'), showRegisterModalButton: document.getElementById('show-register-modal-button'),
        registerModalCloseButton: document.getElementById('register-modal-close-button'), registerForm: document.getElementById('register-form'),
        registerSaveButton: document.getElementById('register-save-button'), registerLoader: document.getElementById('register-loader'),
        registerButtonText: document.getElementById('register-button-text'), registerError: document.getElementById('register-error'),
        adminModal: document.getElementById('admin-modal'), adminModalTitle: document.getElementById('admin-modal-title'),
        adminModalForm: document.getElementById('admin-modal-form'),
        adminModalCloseButton: document.getElementById('admin-modal-close-button'),
 		adminModalSaveButton: document.getElementById('admin-modal-save-button'),
        adminModalLoader: document.getElementById('admin-modal-loader'),
        adminModalButtonText: document.getElementById('admin-modal-button-text'),
        alertModal: document.getElementById('alert-modal'), alertModalTitle: document.getElementById('alert-modal-title'),
        alertModalMessage: document.getElementById('alert-modal-message'), alertModalCloseButton: document.getElementById('alert-modal-close-button'),
        confirmModal: document.getElementById('confirm-modal'), confirmModalTitle: document.getElementById('confirm-modal-title'),
        confirmModalMessage: document.getElementById('confirm-modal-message'), confirmModalNoButton: document.getElementById('confirm-modal-no-button'),
        confirmModalYesButton: document.getElementById('confirm-modal-yes-button'),
        dispatchModal: document.getElementById('dispatch-modal'),
        dispatchForm: document.getElementById('dispatch-form'),
        dispatchModalCloseButton: document.getElementById('dispatch-modal-close-button'),
        dispatchModalSaveButton: document.getElementById('dispatch-modal-save-button'),
        dispatchModalLoader: document.getElementById('dispatch-modal-loader'),
        dispatchModalButtonText: document.getElementById('dispatch-modal-button-text'),
        goToMemoPageButton: document.getElementById('go-to-memo-page-button'),
        statsDetailModal: document.getElementById('stats-detail-modal'),
        statsDetailTitle: document.getElementById('stats-detail-title'),
        statsDetailList: document.getElementById('stats-detail-list'),
        statsDetailCloseButton: document.getElementById('stats-detail-close-button'),
    };

    // --- UTILITY FUNCTIONS ---
    const showLoader = (loader, buttonText, button) => {
        if(loader) loader.classList.remove('hidden');
        if(buttonText) buttonText.classList.add('hidden');
        if (button) button.disabled = true;
    };

    const hideLoader = (loader, buttonText, button) => {
        if(loader) loader.classList.add('hidden');
        if(buttonText) buttonText.classList.remove('hidden');
        if (button) button.disabled = false;
    };
    
    const showAlert = (title, message) => {
        elements.alertModalTitle.textContent = title;
        elements.alertModalMessage.textContent = message;
        elements.alertModal.style.display = 'flex';
    };

    const hideAlert = () => {
        elements.alertModal.style.display = 'none';
    };

    const showConfirm = (title, message, onConfirm) => {
        elements.confirmModalTitle.textContent = title;
        elements.confirmModalMessage.textContent = message;
        elements.confirmModal.style.display = 'flex';
        
        const yesButtonClone = elements.confirmModalYesButton.cloneNode(true);
        elements.confirmModalYesButton.parentNode.replaceChild(yesButtonClone, elements.confirmModalYesButton);
        elements.confirmModalYesButton = yesButtonClone;

        elements.confirmModalYesButton.addEventListener('click', () => {
            hideConfirm();
            onConfirm();
        });
    };
    
    const hideConfirm = () => {
        elements.confirmModal.style.display = 'none';
    };
    
    const fileToBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });

    // --- API COMMUNICATION ---
    async function apiRequest(action, payload = {}, buttonElements = null) {
        if (buttonElements) {
            showLoader(buttonElements.loader, buttonElements.text, buttonElements.button);
        }

        const GET_ACTIONS = [ "getUserRequests", "getAllUsers", "getSentMemos", "getAllRequests", "getAllMemos", "getAttendeesForRequest"];

        let url = APPS_SCRIPT_URL;
        let options;

        if (GET_ACTIONS.includes(action)) {
            const params = new URLSearchParams({ action, ...payload, cacheBust: new Date().getTime() });
            url = `${APPS_SCRIPT_URL}?${params.toString()}`;
            options = { method: 'GET', redirect: 'follow' };
        } else {
             options = {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, payload }),
            };
        }

        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message || 'An unknown error occurred.');
            return result;
        } catch (error) {
            console.error(`API Error on action '${action}':`, error);
            showAlert('เกิดข้อผิดพลาด', error.message);
            return { status: 'error', message: error.message };
        } finally {
            if (buttonElements) {
                hideLoader(buttonElements.loader, buttonElements.text, buttonElements.button);
            }
        }
    }


    // --- AUTHENTICATION ---
    const handleLogin = async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        if (!username || !password) {
            elements.loginError.textContent = 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน';
            elements.loginError.classList.remove('hidden');
            return;
        }
        elements.loginError.classList.add('hidden');
        
        const result = await apiRequest('verifyCredentials', { username, password }, {
            loader: elements.loginLoader, text: elements.loginButtonText, button: elements.loginButton
        });

        if (result.status === 'success') {
            state.currentUser = result.user;
            localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
            showMainApp();
        } else {
            elements.loginError.textContent = result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            elements.loginError.classList.remove('hidden');
        }
    };
    
    const handleRegister = async (e) => {
        e.preventDefault();
        const payload = {
            username: elements.registerForm.querySelector('#register-username').value.trim(),
            password: elements.registerForm.querySelector('#register-password').value.trim(),
            fullName: elements.registerForm.querySelector('#register-fullname').value.trim(),
            position: elements.registerForm.querySelector('#register-position').value.trim(),
            department: elements.registerForm.querySelector('#register-department').value
        };

        if(!payload.username || !payload.password || !payload.fullName || !payload.position || !payload.department){
            elements.registerError.textContent = "กรุณากรอกข้อมูลให้ครบถ้วน";
            elements.registerError.classList.remove('hidden');
            return;
        }
        elements.registerError.classList.add('hidden');

        const result = await apiRequest('registerUser', payload, {
            loader: elements.registerLoader, text: elements.registerButtonText, button: elements.registerSaveButton
        });

        if(result.status === 'success'){
            showAlert('สมัครสำเร็จ', 'การสมัครสมาชิกของคุณสำเร็จแล้ว กรุณาเข้าสู่ระบบ');
            elements.registerModal.style.display = 'none';
            elements.registerForm.reset();
        } else {
            elements.registerError.textContent = result.message;
            elements.registerError.classList.remove('hidden');
        }
    };

    const handleLogout = () => {
        state.currentUser = null;
        localStorage.removeItem('currentUser');
        showLoginScreen();
    };
    
    // --- UI & NAVIGATION ---
    const showLoginScreen = () => {
        elements.loginScreen.classList.remove('hidden');
        elements.mainApp.classList.add('hidden');
    };
    
    const showMainApp = async () => {
        elements.loginScreen.classList.add('hidden');
        elements.mainApp.classList.remove('hidden');
        updateUserInfo();
        setupAdminUI();
        const isAdmin = state.currentUser && state.currentUser.role === 'admin';
        const defaultPage = isAdmin ? 'command-generation-page' : 'dashboard-page';
        await navigateToPage(defaultPage);
    };

    const updateUserInfo = () => {
        if (state.currentUser) {
            elements.userFullname.textContent = state.currentUser.fullName;
            elements.userPosition.textContent = state.currentUser.position;
        }
    };
    
    const setupAdminUI = () => {
        const isAdmin = state.currentUser && state.currentUser.role === 'admin';
        
        elements.adminNavManagement.classList.toggle('hidden', !isAdmin);
        elements.adminNavUsers.classList.toggle('hidden', !isAdmin);
        elements.adminNavCommand.classList.toggle('hidden', !isAdmin);

        elements.userNavDashboard.classList.toggle('hidden', isAdmin);
        elements.userNavForm.classList.toggle('hidden', isAdmin);
        elements.userNavMemo.classList.toggle('hidden', isAdmin);
    };

    const navigateToPage = async (targetId) => {
        elements.pageViews.forEach(page => page.classList.add('hidden'));
        elements.navButtons.forEach(button => button.classList.remove('active'));

        const targetPage = document.getElementById(targetId);
        const targetButton = document.querySelector(`.nav-button[data-target="${targetId}"]`);
        
        if (targetPage) targetPage.classList.remove('hidden');
        if (targetButton) targetButton.classList.add('active');

        switch (targetId) {
            case 'dashboard-page': await fetchUserRequests(); break;
            case 'form-page': resetRequestForm(); break;
            case 'memo-page': 
                await fetchUserRequests(); 
                await fetchSentMemos(); 
                populateMemoRequestDropdown();
                break;
            case 'profile-page': populateProfileForm(); break;
            case 'admin-users-page': await fetchAllUsers(); break;
            case 'admin-memos-page': await fetchAllMemos(); break;
            case 'command-generation-page': await fetchAllRequestsForCommand(); break;
            case 'stats-page': await fetchAndRenderStatistics(); break;
        }
    };

    // --- PAGE: DASHBOARD ---
    const fetchUserRequests = async () => {
        elements.requestsLoader.classList.remove('hidden');
        elements.requestsList.classList.add('hidden');
        elements.noRequestsMessage.classList.add('hidden');

        const result = await apiRequest('getUserRequests', { username: state.currentUser.username });

        elements.requestsLoader.classList.add('hidden');
        if (result.status === 'success' && result.data.length > 0) {
            state.userRequests = result.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderUserRequests(state.userRequests);
            elements.requestsList.classList.remove('hidden');
        } else {
            state.userRequests = [];
            elements.noRequestsMessage.classList.remove('hidden');
            elements.requestsList.innerHTML = '';
        }
    };
    
    const renderUserRequests = (requests) => {
        elements.requestsList.innerHTML = '';
        if (requests.length === 0) {
            elements.requestsList.innerHTML = `<p class="text-center text-gray-500 p-4">ไม่พบรายการที่ตรงกับการค้นหา</p>`;
            return;
        }
        requests.forEach(req => {
            const reqDiv = document.createElement('div');
            reqDiv.className = 'p-4 border rounded-lg mb-3 bg-gray-50 shadow-sm';
            const commandStatusColor = req.commandStatus === 'Approved' ? 'text-green-600' : 'text-yellow-600';
            const commandStatusText = req.commandStatus === 'Approved' ? 'อนุมัติแล้ว' : 'รออนุมัติ';

            reqDiv.innerHTML = `
                <div class="flex flex-wrap justify-between items-start gap-2">
                    <div>
                        <p class="font-bold text-lg">${req.purpose}</p>
                        <p class="text-sm text-gray-500"><strong>วันที่:</strong> ${formatThaiDate(req.startDate)} - ${formatThaiDate(req.endDate)}</p>
                        <p class="text-sm font-semibold ${commandStatusColor}"><strong>สถานะคำสั่ง:</strong> ${commandStatusText}</p>
                        <p class="text-xs text-gray-400 mt-1"><strong>เลขที่อ้างอิง:</strong> ${req.id}</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 items-center flex-shrink-0">
                        <a href="${req.pdfUrl}" target="_blank" class="btn btn-primary btn-sm">ดาวน์โหลดไฟล์ร่าง</a>
                        <button class="btn btn-primary btn-sm edit-request" data-id="${req.id}">แก้ไข</button>
                        <button class="btn btn-danger btn-sm delete-request" data-id="${req.id}">ลบ</button>
                    </div>
                </div>
            `;
            elements.requestsList.appendChild(reqDiv);
        });
    };
    
    // --- PAGE: PROFILE ---
    const populateProfileForm = () => {
        elements.profileUsername.value = state.currentUser.username;
        elements.profileFullname.value = state.currentUser.fullName;
        elements.profilePosition.value = state.currentUser.position;
        elements.profileDepartment.value = state.currentUser.department;
        elements.profileMessage.classList.add('hidden');
        
        elements.passwordForm.reset();
        elements.passwordMessage.classList.add('hidden');
        elements.passwordError.classList.add('hidden');
        elements.showPasswordToggle.checked = false;
        document.getElementById('profile-current-password').type = 'password';
        document.getElementById('profile-new-password').type = 'password';
        document.getElementById('profile-confirm-password').type = 'password';
    };
    
    const handleProfileUpdate = async (e) => {
        e.preventDefault();
        const payload = {
            originalUsername: state.currentUser.username,
            newUsername: elements.profileUsername.value.trim(),
            fullName: elements.profileFullname.value.trim(),
            position: elements.profilePosition.value.trim(),
            department: elements.profileDepartment.value.trim(),
        };

        const result = await apiRequest('updateUser', payload, {
            loader: elements.profileLoader, text: elements.profileButtonText, button: elements.saveProfileButton
        });

        if (result.status === 'success') {
            state.currentUser.username = payload.newUsername;
            state.currentUser.fullName = payload.fullName;
            state.currentUser.position = payload.position;
            state.currentUser.department = payload.department;
            localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
            updateUserInfo();
            elements.profileMessage.textContent = 'บันทึกข้อมูลสำเร็จแล้ว';
            elements.profileMessage.classList.remove('hidden');
        }
    };
    
    const handlePasswordUpdate = async (e) => {
        e.preventDefault();
        elements.passwordMessage.classList.add('hidden');
        elements.passwordError.classList.add('hidden');

        const currentPassword = document.getElementById('profile-current-password').value;
        const newPassword = document.getElementById('profile-new-password').value;
        const confirmPassword = document.getElementById('profile-confirm-password').value;

        if (!newPassword || newPassword !== confirmPassword) {
            elements.passwordError.textContent = 'รหัสผ่านใหม่และการยืนยันไม่ตรงกัน';
            elements.passwordError.classList.remove('hidden');
            return;
        }

        const payload = {
            username: state.currentUser.username,
            oldPassword: currentPassword,
            newPassword: newPassword,
        };

        const result = await apiRequest('updatePassword', payload, {
            loader: elements.passwordLoader,
            text: elements.passwordButtonText,
            button: elements.savePasswordButton
        });

        if (result.status === 'success') {
            elements.passwordMessage.textContent = 'เปลี่ยนรหัสผ่านสำเร็จแล้ว';
            elements.passwordMessage.classList.remove('hidden');
            elements.passwordForm.reset();
            elements.showPasswordToggle.checked = false;
            document.getElementById('profile-current-password').type = 'password';
            document.getElementById('profile-new-password').type = 'password';
            document.getElementById('profile-confirm-password').type = 'password';
        } else {
            elements.passwordError.textContent = result.message || 'เกิดข้อผิดพลาดในการเปลี่ยนรหัสผ่าน';
            elements.passwordError.classList.remove('hidden');
        }
    };
    
    // --- PAGE: ADMIN USERS ---
    const fetchAllUsers = async () => {
        elements.adminLoader.classList.remove('hidden');
        elements.adminUsersList.classList.add('hidden');
        const result = await apiRequest('getAllUsers');
        elements.adminLoader.classList.add('hidden');
        if (result.status === 'success') {
            state.allUsers = result.data;
            renderAllUsers(state.allUsers);
            elements.adminUsersList.classList.remove('hidden');
        }
    };

    const renderAllUsers = (users) => {
        const table = document.createElement('table');
        table.className = 'min-w-full bg-white divide-y divide-gray-200';
        table.innerHTML = `
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ตำแหน่ง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สิทธิ์</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${users.map(user => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${user.fullName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 edit-user" data-username="${user.username}">แก้ไข</button>
                            <button class="text-red-600 hover:text-red-900 ml-4 delete-user" data-username="${user.username}">ลบ</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        elements.adminUsersList.innerHTML = '';
        elements.adminUsersList.appendChild(table);
    };

    const handleAddUser = () => {
        elements.adminModalTitle.textContent = 'เพิ่มผู้ใช้ใหม่';
        elements.adminModalForm.reset();
        document.getElementById('modal-original-username').value = '';
        document.getElementById('modal-username').readOnly = false;
        elements.adminModal.style.display = 'flex';
    };

    const handleEditUser = (username) => {
        const user = state.allUsers.find(u => u.username === username);
        if (user) {
            elements.adminModalTitle.textContent = 'แก้ไขข้อมูลผู้ใช้';
            document.getElementById('modal-original-username').value = user.username;
            document.getElementById('modal-username').value = user.username;
            document.getElementById('modal-username').readOnly = true;
            document.getElementById('modal-password').value = '';
            document.getElementById('modal-fullname').value = user.fullName;
            document.getElementById('modal-position').value = user.position;
            document.getElementById('modal-department').value = user.department;
            document.getElementById('modal-role').value = user.role;
            elements.adminModal.style.display = 'flex';
        }
    };
    
    const handleDeleteUser = (username) => {
        if (username === state.currentUser.username) {
            showAlert('ผิดพลาด', 'คุณไม่สามารถลบบัญชีของตัวเองได้');
            return;
        }
        showConfirm('ยืนยันการลบ', `คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ "${username}"?`, async () => {
            const result = await apiRequest('deleteUser', { username });
            if (result.status === 'success') {
                showAlert('สำเร็จ', `ลบผู้ใช้ ${username} เรียบร้อยแล้ว`);
                await fetchAllUsers();
            }
        });
    };
    
    const handleSaveUser = async (e) => {
        e.preventDefault();
        const isEditing = !!document.getElementById('modal-original-username').value;
        const payload = {
            username: document.getElementById('modal-username').value.trim(),
            password: document.getElementById('modal-password').value.trim(),
            fullName: document.getElementById('modal-fullname').value.trim(),
            position: document.getElementById('modal-position').value.trim(),
            department: document.getElementById('modal-department').value.trim(),
            role: document.getElementById('modal-role').value
        };

        const action = isEditing ? 'updateUser' : 'addUser';
        const result = await apiRequest(action, payload, {
            loader: elements.adminModalLoader, text: elements.adminModalButtonText, button: elements.adminModalSaveButton
        });

        if (result.status === 'success') {
            showAlert('สำเร็จ', 'บันทึกข้อมูลผู้ใช้เรียบร้อยแล้ว');
            elements.adminModal.style.display = 'none';
            await fetchAllUsers();
        }
    };
    
    // --- HELPER for date formatting ---
    const formatThaiDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
    };
    const toISODateString = (date) => {
        if (!date) return '';
        return new Date(date).toISOString().split('T')[0];
    };

    // --- PAGE: REQUEST FORM ---
    const resetRequestForm = () => {
        elements.requestForm.reset();
        elements.requestForm.classList.remove('hidden');
        document.getElementById('form-request-id').value = '';
        document.getElementById('form-doc-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('form-requester-name').value = state.currentUser.fullName;
        document.getElementById('form-requester-position').value = state.currentUser.position;
        document.getElementById('form-department').value = state.currentUser.department;
        elements.formAttendeesList.innerHTML = '';
        elements.formResult.classList.add('hidden');
        elements.submitButtonText.textContent = "บันทึกและสร้างเอกสาร";

        const signerFieldset = document.getElementById('signer-fieldset');
        const headNameInput = document.getElementById('form-head-name');
        const departmentInput = document.getElementById('form-department');

        if (state.currentUser.position === 'ผู้อำนวยการโรงเรียน' || state.currentUser.position === 'รองผู้อำนวยการโรงเรียน') {
            signerFieldset.classList.add('hidden');
            departmentInput.required = false;
        } else {
            signerFieldset.classList.remove('hidden');
            departmentInput.required = true;
        }
    };

    const addAttendeeRow = (name = '', position = '') => {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 mb-2 items-center';
        div.innerHTML = `
            <input type="text" class="form-input md:col-span-1" placeholder="ชื่อ-นามสกุล" value="${name}" required>
            <input type="text" class="form-input md:col-span-1" placeholder="ตำแหน่ง" value="${position}" required>
            <button type="button" class="btn btn-danger btn-sm justify-self-start remove-attendee">ลบ</button>
        `;
        elements.formAttendeesList.appendChild(div);
    };
    
    const handleRequestSubmit = async (e) => {
        e.preventDefault();
        const expenseItems = Array.from(document.querySelectorAll('#partial-expense-options input[type="checkbox"]:checked'))
            .map(cb => {
                let detail = null;
                if(cb.id === 'expense_other_check') {
                    detail = document.getElementById('expense_other_text').value;
                }
                return { name: cb.value, detail: detail };
            });

        const attendees = Array.from(elements.formAttendeesList.children).map(row => {
            const inputs = row.querySelectorAll('input');
            return { name: inputs[0].value.trim(), position: inputs[1].value.trim() };
        });

        const payload = {
            id: document.getElementById('form-request-id').value,
            username: state.currentUser.username,
            docDate: document.getElementById('form-doc-date').value,
            requesterName: document.getElementById('form-requester-name').value,
            requesterPosition: document.getElementById('form-requester-position').value,
            location: document.getElementById('form-location').value,
            purpose: document.getElementById('form-purpose').value,
            startDate: document.getElementById('form-start-date').value,
            endDate: document.getElementById('form-end-date').value,
            attendees: attendees,
            expenseOption: document.querySelector('input[name="expense_option"]:checked').value,
            expenseItems: expenseItems,
            totalExpense: document.getElementById('form-total-expense').value || '0',
            vehicleOption: document.querySelector('input[name="vehicle_option"]:checked').value,
            licensePlate: document.getElementById('form-license-plate').value,
            department: document.getElementById('form-department').value,
            headName: document.getElementById('form-head-name').value,
        };

        const result = await apiRequest('createRequest', payload, {
            loader: elements.submitLoader, text: elements.submitButtonText, button: elements.submitRequestButton
        });

        if (result.status === 'success') {
            elements.requestForm.classList.add('hidden');
            elements.formResult.classList.remove('hidden');
            const isUpdate = !!payload.id;
            elements.formResultTitle.textContent = isUpdate ? 'อัปเดตข้อมูลสำเร็จ' : 'สร้างเอกสารสำเร็จ';
            elements.formResultMessage.textContent = `เลขที่อ้างอิงของคุณคือ: ${result.data.id}`;
            elements.formResultLink.href = result.data.pdfUrl;
            elements.goToMemoPageButton.dataset.newRequestId = result.data.id;
            showAlert('สำเร็จ!', `บันทึกข้อมูลและสร้าง PDF เรียบร้อยแล้ว`);
            await fetchUserRequests(); 
        }
    };
    
    // --- PAGE: MEMO ---
    const populateMemoRequestDropdown = () => {
        const select = document.getElementById('memo-ref-number');
        select.innerHTML = '<option value="">-- กรุณาเลือกร่างคำขอ --</option>';
        state.userRequests.forEach(req => {
            const option = document.createElement('option');
            option.value = req.id;
            option.textContent = `${req.id} (${req.purpose})`;
            select.appendChild(option);
        });
    };

    const fetchSentMemos = async () => {
        elements.memosLoader.classList.remove('hidden');
        elements.memosList.classList.add('hidden');
        elements.noMemosMessage.classList.add('hidden');
        const result = await apiRequest('getSentMemos', { username: state.currentUser.username });
        elements.memosLoader.classList.add('hidden');
        if (result.status === 'success' && result.data.length > 0) {
            state.sentMemos = result.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderSentMemos(state.sentMemos);
            elements.memosList.classList.remove('hidden');
        } else {
            elements.noMemosMessage.classList.remove('hidden');
            elements.memosList.innerHTML = '';
        }
    };

    const renderSentMemos = (memos) => {
        elements.memosList.innerHTML = memos.map(memo => {
            let buttonsHtml = '';
            if (memo.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน') {
                buttonsHtml = `
                    <div class="flex flex-col sm:flex-row gap-2">
                        ${memo.dispatchBookUrl ? `<a href="${memo.dispatchBookUrl}" target="_blank" class="btn btn-primary btn-sm">หนังสือส่ง</a>` : ''}
                        ${memo.completedMemoUrl ? `<a href="${memo.completedMemoUrl}" target="_blank" class="btn btn-success btn-sm">บันทึกฯ (ลงนาม)</a>` : ''}
                        ${memo.completedCommandUrl ? `<a href="${memo.completedCommandUrl}" target="_blank" class="btn bg-purple-600 text-white hover:bg-purple-700 btn-sm">คำสั่ง (ลงนาม)</a>` : ''}
                    </div>`;
            } else {
                 buttonsHtml = `<span class="text-sm text-gray-500">${memo.status}</span>`;
            }

            return `
                <div class="p-3 border rounded-lg bg-gray-50 flex flex-wrap justify-between items-center gap-2">
                    <div>
                        <p class="font-bold">${memo.refNumber}</p>
                        <p class="text-xs text-gray-400">${formatThaiDate(memo.timestamp)}</p>
                    </div>
                    <div>
                        ${buttonsHtml}
                    </div>
                </div>
            `;
        }).join('');
    };

    const handleMemoSubmit = async (e) => {
        e.preventDefault();
        
        const refNumber = document.getElementById('memo-ref-number').value;
        if (!refNumber) {
             showAlert('ผิดพลาด', 'กรุณาเลือกร่างคำขอ');
            return;
        }

        const memoType = document.querySelector('input[name="memo_type"]:checked').value;
        const file = elements.memoFile.files[0];
        
        if (memoType === 'no-reimburse' && !file) {
            showAlert('ผิดพลาด', 'กรุณาเลือกไฟล์ PDF ที่จะอัปโหลดสำหรับกรณี "ไม่เบิก"');
            return;
        }

        const base64Data = file ? await fileToBase64(file) : null;
        const payload = {
            refNumber: refNumber,
            username: state.currentUser.username,
            memoType: memoType,
            file: file ? {
                filename: file.name,
                mimeType: file.type,
                data: base64Data,
            } : null
        };

        const result = await apiRequest('uploadMemo', payload, {
            loader: elements.memoSubmitLoader, text: elements.memoSubmitButtonText, button: elements.submitMemoButton
        });

        if (result.status === 'success') {
            showAlert('สำเร็จ', 'ส่งบันทึกข้อความเรียบร้อยแล้ว');
            elements.memoForm.reset();
            elements.memoFilename.textContent = '';
            document.getElementById('memo-file-container').classList.remove('hidden');
            document.getElementById('memo-file').required = true;
            await fetchSentMemos();
        }
    };
    
    // --- ADMIN PAGES ---
    const fetchAllMemos = async () => {
        elements.adminMemosLoader.classList.remove('hidden');
        elements.adminMemosList.classList.add('hidden');
        elements.noAdminMemosMessage.classList.add('hidden');
        const result = await apiRequest('getAllMemos');
        elements.adminMemosLoader.classList.add('hidden');
        if (result.status === 'success' && result.data.length > 0) {
            state.allMemos = result.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderAllMemos(state.allMemos);
            elements.adminMemosList.classList.remove('hidden');
        } else {
            elements.noAdminMemosMessage.classList.remove('hidden');
            elements.adminMemosList.innerHTML = '';
        }
    };

    const renderAllMemos = (memos) => {
        const table = document.createElement('table');
        table.className = 'min-w-full bg-white divide-y divide-gray-200';
        table.innerHTML = `
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขบันทึก</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้ส่ง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ไฟล์ต้นฉบับ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ไฟล์ที่เสร็จสิ้น</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                ${memos.map(memo => {
                    const statusOptions = ['กำลังดำเนินการ', 'เสร็จสิ้น/รับไฟล์ไปใช้งาน', 'ตีกลับ/แก้ไข'].map(s =>
                        `<option value="${s}" ${memo.status === s ? 'selected' : ''}>${s}</option>`
                    ).join('');
                    return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${memo.refNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${memo.submittedBy}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${memo.fileURL ? `<a href="${memo.fileURL}" target="_blank" class="text-blue-600 hover:underline">ดูไฟล์</a>` : '<span class="text-gray-400">เบิก</span>'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${memo.dispatchBookUrl ? `<a href="${memo.dispatchBookUrl}" class="text-blue-600 block" target="_blank">หนังสือส่ง</a>` : ''}
                            ${memo.completedMemoUrl ? `<a href="${memo.completedMemoUrl}" class="text-green-600 block" target="_blank">บันทึกฯ</a>` : ''}
                            ${memo.completedCommandUrl ? `<a href="${memo.completedCommandUrl}" class="text-purple-600 block" target="_blank">คำสั่ง</a>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select class="form-input text-sm memo-status-select" data-id="${memo.id}" onchange="toggleFileUpload(this)">${statusOptions}</select>
                            <div class="upload-container mt-2 hidden" data-id="${memo.id}">
                                <label class="text-xs">บันทึกฯ (ลงนาม):</label>
                                <input type="file" class="form-input text-xs p-1 completed-memo-file" data-id="${memo.id}" accept="application/pdf">
                                <label class="text-xs mt-1">คำสั่ง (ลงนาม):</label>
                                <input type="file" class="form-input text-xs p-1 completed-command-file" data-id="${memo.id}" accept="application/pdf">
                                <label class="text-xs mt-1">หนังสือส่ง:</label>
                                <input type="file" class="form-input text-xs p-1 completed-dispatch-file" data-id="${memo.id}" accept="application/pdf">
                                <button class="btn btn-success btn-sm mt-2 w-full update-memo-status" data-id="${memo.id}">บันทึก</button>
                            </div>
                        </td>
                    </tr>
                `}).join('')}
            </tbody>
        `;
        elements.adminMemosList.innerHTML = '';
        elements.adminMemosList.appendChild(table);
    };
    
    const fetchAllRequestsForCommand = async () => {
        elements.commandRequestsLoader.classList.remove('hidden');
        elements.commandRequestsList.classList.add('hidden');
        elements.noCommandRequestsMessage.classList.add('hidden');
        const result = await apiRequest('getAllRequests');
        elements.commandRequestsLoader.classList.add('hidden');
        if (result.status === 'success' && result.data.length > 0) {
            state.allUserRequests = result.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            await renderAllRequestsForCommand(state.allUserRequests);
            elements.commandRequestsList.classList.remove('hidden');
        } else {
            elements.noCommandRequestsMessage.classList.remove('hidden');
        }
    };

    const renderAllRequestsForCommand = async (requests) => {
        const table = document.createElement('table');
        table.className = 'min-w-full bg-white divide-y divide-gray-200';

        let rowsHtml = '';
        for (const req of requests) {
            const attendeesResult = await apiRequest('getAttendeesForRequest', { requestId: req.id });
            const totalPeople = (attendeesResult.data ? attendeesResult.data.length : 0);
            const isApproved = req.commandStatus === 'Approved';
            
            rowsHtml += `
                 <tr>
                    <td class="px-6 py-4 text-sm text-gray-500">${req.id}</td>
                    <td class="px-6 py-4">${req.requesterName}</td>
                    <td class="px-6 py-4">${req.purpose}</td>
                    <td class="px-6 py-4">${formatThaiDate(req.startDate)} - ${formatThaiDate(req.endDate)}</td>
                    <td class="px-6 py-4 text-center">${totalPeople}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <a href="${req.commandPdfUrlSolo}" target="_blank" class="text-blue-600 hover:underline block">1 คน</a>
                        <a href="${req.commandPdfUrlGroupSmall}" target="_blank" class="text-blue-600 hover:underline block">2-5 คน</a>
                        <a href="${req.commandPdfUrlGroupLarge}" target="_blank" class="text-blue-600 hover:underline block">6+ คน</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${isApproved ? `<span class="text-green-600 font-bold">อนุมัติแล้ว</span> <a href="${req.commandPdfUrl}" target="_blank" class="text-blue-500 ml-2">ดูไฟล์</a>` : `
                        <div class="flex items-center gap-2">
                            <select class="form-input text-sm command-template-select" data-id="${req.id}">
                                <option value="">-- เลือกแบบฟอร์ม --</option>
                                <option value="solo">1 คน</option>
                                <option value="groupSmall">2-5 คน</option>
                                <option value="groupLarge">6+ คน</option>
                            </select>
                            <button class="btn btn-success btn-sm approve-command" data-id="${req.id}">อนุมัติ</button>
                        </div>
                        `}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${req.dispatchBookPdfUrl 
                            ? `<a href="${req.dispatchBookPdfUrl}" target="_blank" class="btn btn-success btn-sm">ดูหนังสือส่ง</a>` 
                            : `<button class="btn btn-primary btn-sm generate-dispatch" data-id="${req.id}">ออกหนังสือส่ง</button>`
                        }
                    </td>
                </tr>
            `;
        }

        table.innerHTML = `
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขอ้างอิง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้ขอ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วัตถุประสงค์</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนคน</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ตัวอย่างไฟล์คำสั่ง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการคำสั่ง</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หนังสือส่ง</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">${rowsHtml}</tbody>
        `;

        elements.commandRequestsList.innerHTML = '';
        elements.commandRequestsList.appendChild(table);
    };
    
    const fetchAndRenderStatistics = async () => {
        elements.statsLoader.classList.remove('hidden');
        elements.statsContent.classList.add('hidden');
        
        let requestsToProcess = [];
        if (state.currentUser.role === 'admin') {
            if (state.allUserRequests.length === 0) {
                const result = await apiRequest('getAllRequests');
                if (result.status === 'success') {
                    state.allUserRequests = result.data;
                } else {
                    elements.statsLoader.classList.add('hidden');
                    return;
                }
            }
            requestsToProcess = state.allUserRequests;
        } else {
             if (state.userRequests.length === 0) {
                 await fetchUserRequests();
             }
             requestsToProcess = state.userRequests;
        }
        
        processAndRenderStats(requestsToProcess);

        elements.statsLoader.classList.add('hidden');
        elements.statsContent.classList.remove('hidden');
    };

    const processAndRenderStats = (requests) => {
        elements.statsContent.innerHTML = '';

        const byRequester = requests.reduce((acc, req) => {
            acc[req.requesterName] = (acc[req.requesterName] || 0) + 1;
            return acc;
        }, {});
        renderStatsList(elements.statsContent, byRequester, 'ตามผู้ขอไปราชการ', 'requester');

        const byDepartment = requests.reduce((acc, req) => {
            const dept = req.department || 'ไม่ระบุกลุ่มสาระฯ';
            acc[dept] = (acc[dept] || 0) + 1;
            return acc;
        }, {});
        renderStatsList(elements.statsContent, byDepartment, 'ตามกลุ่มสาระการเรียนรู้', 'department');

        const byYear = requests.reduce((acc, req) => {
            const year = new Date(req.docDate).getFullYear() + 543;
            acc[year] = (acc[year] || 0) + 1;
            return acc;
        }, {});
        renderStatsList(elements.statsContent, byYear, 'ตามปี (พ.ศ.)', 'year');

        const byExpense = requests.reduce((acc, req) => {
            const key = req.expenseOption === 'partial' ? 'เบิกค่าใช้จ่าย' : 'ไม่เบิกค่าใช้จ่าย';
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, { 'เบิกค่าใช้จ่าย': 0, 'ไม่เบิกค่าใช้จ่าย': 0 });
         renderStatsList(elements.statsContent, byExpense, 'การเบิกค่าใช้จ่าย', 'expense');
    };
    
    const renderStatsList = (container, data, title, type) => {
        const sortedEntries = Object.entries(data).sort(([, a], [, b]) => b - a);

        let iconSvg = '';
        let iconColor = 'text-gray-500';
        if (title.includes('ผู้ขอ')) { iconColor = 'text-indigo-500'; iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 ${iconColor}"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`; }
        else if (title.includes('กลุ่มสาระ')) { iconColor = 'text-green-500'; iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 ${iconColor}"><path d="M22 10v6M2 10v6M12 2v20M20.59 4.41l-1.42 1.42M3.41 18.17l-1.42 1.42M20.59 19.59l-1.42-1.42M3.41 5.83l-1.42-1.42"/></svg>`; }
        else if (title.includes('ปี')) { iconColor = 'text-blue-500'; iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 ${iconColor}"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`; }
        else if (title.includes('เบิก')) { iconColor = 'text-yellow-500'; iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 ${iconColor}"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`; }

        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-xl shadow-lg border border-gray-200';
        card.innerHTML = `
            <div class="flex items-center gap-4 mb-4">
                ${iconSvg}
                <h3 class="font-bold text-xl text-gray-800">${title}</h3>
            </div>
            <div class="space-y-4"></div>`;

        const listContainer = card.querySelector('.space-y-4');
        const total = sortedEntries.reduce((sum, [, value]) => sum + value, 0);
        
        if (sortedEntries.length === 0 || total === 0) {
            listContainer.innerHTML = '<p class="text-sm text-gray-500">ไม่มีข้อมูล</p>';
        } else {
            for (const [key, value] of sortedEntries) {
                const percentage = (value / total) * 100;
                const itemButton = document.createElement('button');
                itemButton.className = 'w-full text-left p-2 rounded-lg hover:bg-gray-100 transition';
                itemButton.dataset.key = key;
                itemButton.dataset.type = type;

                itemButton.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-600">${key || 'ไม่ระบุ'}</span>
                        <span class="text-sm font-bold text-gray-800">${value} ครั้ง</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-gradient-to-r from-blue-400 to-indigo-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>`;
                listContainer.appendChild(itemButton);
            }
        }
        container.appendChild(card);
    };

    const showStatsDetail = (key, type) => {
        let filteredRequests = [];
        let title = '';
        let sourceData = state.currentUser.role === 'admin' ? state.allUserRequests : state.userRequests;

        switch(type) {
            case 'requester':
                title = `รายการของ: ${key}`;
                filteredRequests = sourceData.filter(req => req.requesterName === key);
                break;
            case 'department':
                 title = `รายการของกลุ่มสาระฯ: ${key || 'ไม่ระบุ'}`;
                filteredRequests = sourceData.filter(req => (req.department || 'ไม่ระบุ') === key);
                break;
            case 'year':
                title = `รายการในปี พ.ศ.: ${key}`;
                filteredRequests = sourceData.filter(req => (new Date(req.docDate).getFullYear() + 543).toString() === key);
                break;
            case 'expense':
                title = `รายการ (${key})`;
                const expenseType = key === 'เบิกค่าใช้จ่าย' ? 'partial' : 'no';
                filteredRequests = sourceData.filter(req => req.expenseOption === expenseType);
                break;
        }

        elements.statsDetailTitle.textContent = title;
        const listEl = elements.statsDetailList;
        listEl.innerHTML = '';

        if (filteredRequests.length === 0) {
            listEl.innerHTML = '<p class="text-center text-gray-500">ไม่พบรายการ</p>';
        } else {
            filteredRequests.forEach(req => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded-lg bg-gray-50';
                div.innerHTML = `
                    <p class="font-semibold">${req.purpose}</p>
                    <p class="text-sm text-gray-600">โดย: ${req.requesterName}</p>
                    <p class="text-xs text-gray-500">วันที่: ${formatThaiDate(req.startDate)} - ${formatThaiDate(req.endDate)} | ID: ${req.id}</p>
                `;
                listEl.appendChild(div);
            });
        }
        elements.statsDetailModal.style.display = 'flex';
    };
    
    const handleMemoStatusUpdate = async (memoId) => {
        const statusSelect = document.querySelector(`.memo-status-select[data-id="${memoId}"]`);
        const memoFileInput = document.querySelector(`.completed-memo-file[data-id="${memoId}"]`);
        const commandFileInput = document.querySelector(`.completed-command-file[data-id="${memoId}"]`);
        const dispatchFileInput = document.querySelector(`.completed-dispatch-file[data-id="${memoId}"]`);
        const updateButton = document.querySelector(`.update-memo-status[data-id="${memoId}"]`);

        const payload = { id: memoId, status: statusSelect.value };

        if (payload.status === 'เสร็จสิ้น/รับไฟล์ไปใช้งาน') {
            const memoFile = memoFileInput.files[0];
            const commandFile = commandFileInput.files[0];
            const dispatchFile = dispatchFileInput.files[0];
            if (memoFile) payload.completedMemoFile = { filename: memoFile.name, mimeType: memoFile.type, data: await fileToBase64(memoFile) };
            if (commandFile) payload.completedCommandFile = { filename: commandFile.name, mimeType: commandFile.type, data: await fileToBase64(commandFile) };
            if (dispatchFile) payload.dispatchBookFile = { filename: dispatchFile.name, mimeType: dispatchFile.type, data: await fileToBase64(dispatchFile) };
        }
        
        const result = await apiRequest('updateMemoStatus', payload, { button: updateButton });
        if (result.status === 'success') {
            showAlert('สำเร็จ', 'อัปเดตสถานะเรียบร้อยแล้ว');
            await fetchAllMemos();
        }
    };
    
    const handleApproveCommand = async (requestId) => {
        const templateSelect = document.querySelector(`.command-template-select[data-id="${requestId}"]`);
        const approveButton = document.querySelector(`.approve-command[data-id="${requestId}"]`);
        const templateType = templateSelect.value;

        if (!templateType) {
            showAlert('ผิดพลาด', 'กรุณาเลือกรูปแบบคำสั่งก่อนอนุมัติ');
            return;
        }

        const result = await apiRequest('approveCommand', { requestId, templateType }, {button: approveButton});
        if (result.status === 'success') {
            showAlert('สำเร็จ', 'อนุมัติคำสั่งเรียบร้อยแล้ว');
            await fetchAllRequestsForCommand();
        }
    };

    const handleGenerateDispatchBook = async (e) => {
        e.preventDefault();
        const payload = {
            requestId: document.getElementById('dispatch-request-id').value,
            dispatchMonth: document.getElementById('dispatch-month').value,
            dispatchYear: document.getElementById('dispatch-year').value,
            commandCount: document.getElementById('dispatch-command-count').value,
            memoCount: document.getElementById('dispatch-memo-count').value,
        };
        
        const result = await apiRequest('generateDispatchBook', payload, {
            loader: elements.dispatchModalLoader,
            text: elements.dispatchModalButtonText,
            button: elements.dispatchModalSaveButton
        });
        
        if (result.status === 'success') {
            showAlert('สำเร็จ', 'สร้างหนังสือส่งเรียบร้อยแล้ว');
            elements.dispatchModal.style.display = 'none';
            await fetchAllRequestsForCommand(); 
            await fetchUserRequests(); // Refresh user dashboard as well
        }
    };

    // --- INITIALIZATION ---
    const init = () => {
        addEventListeners();
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            state.currentUser = JSON.parse(storedUser);
            showMainApp();
        } else {
            showLoginScreen();
        }
    };
    
    // --- FULL EVENT LISTENERS SETUP ---
    const addEventListeners = () => {
        elements.loginForm.addEventListener('submit', handleLogin);
        elements.logoutButton.addEventListener('click', handleLogout);
        elements.navButtons.forEach(button => {
            button.addEventListener('click', (e) => navigateToPage(e.currentTarget.dataset.target));
        });
        elements.profileForm.addEventListener('submit', handleProfileUpdate);
        elements.passwordForm.addEventListener('submit', handlePasswordUpdate);
        elements.showPasswordToggle.addEventListener('change', () => {
            const isChecked = elements.showPasswordToggle.checked;
            document.getElementById('profile-current-password').type = isChecked ? 'text' : 'password';
            document.getElementById('profile-new-password').type = isChecked ? 'text' : 'password';
            document.getElementById('profile-confirm-password').type = isChecked ? 'text' : 'password';
        });
        elements.alertModalCloseButton.addEventListener('click', hideAlert);
        elements.confirmModalNoButton.addEventListener('click', hideConfirm);

        // Register Modal
        elements.showRegisterModalButton.addEventListener('click', () => {
            elements.registerModal.style.display = 'flex';
            elements.registerForm.reset();
            elements.registerError.classList.add('hidden');
        });
        elements.registerModalCloseButton.addEventListener('click', () => elements.registerModal.style.display = 'none');
        elements.registerForm.addEventListener('submit', handleRegister);
        
        // Admin: User Management
        elements.addUserButton.addEventListener('click', handleAddUser);
        elements.adminUsersList.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-user')) handleEditUser(e.target.dataset.username);
            if (e.target.classList.contains('delete-user')) handleDeleteUser(e.target.dataset.username);
        });
        elements.adminModalForm.addEventListener('submit', handleSaveUser);
        elements.adminModalCloseButton.addEventListener('click', () => elements.adminModal.style.display = 'none');
        elements.downloadUserTemplateButton.addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const ws_data = [ ["Username", "Password", "FullName", "Position", "Department", "Role"] ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Users");
            XLSX.writeFile(wb, "user_import_template.xlsx");
        });
        elements.importUsersButton.addEventListener('click', () => elements.userExcelInput.click());
        elements.userExcelInput.addEventListener('change', handleUserImport);


        // Request Form
        elements.requestForm.addEventListener('submit', handleRequestSubmit);
        elements.formAddAttendee.addEventListener('click', () => addAttendeeRow());
        elements.formAttendeesList.addEventListener('click', e => {
            if (e.target.classList.contains('remove-attendee')) e.target.closest('div').remove();
        });
        document.querySelectorAll('input[name="expense_option"]').forEach(r => r.addEventListener('change', e => {
            const show = e.target.value === 'partial';
            document.getElementById('partial-expense-options').classList.toggle('hidden', !show);
            document.getElementById('total-expense-container').classList.toggle('hidden', !show);
        }));
        document.querySelectorAll('input[name="vehicle_option"]').forEach(r => r.addEventListener('change', e => {
            document.getElementById('private-vehicle-details').classList.toggle('hidden', e.target.value !== 'private');
        }));
        
        // Dashboard
        elements.requestsList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if(!target) return;
            const id = target.dataset.id;
            if (target.classList.contains('delete-request')) {
                showConfirm('ยืนยันการลบ', `คุณแน่ใจหรือไม่ว่าต้องการลบคำขอเลขที่ ${id}?`, async () => {
                    const result = await apiRequest('deleteRequest', { id });
                    if(result.status === 'success') {
                        showAlert('สำเร็จ', 'ลบคำขอเรียบร้อยแล้ว');
                        fetchUserRequests();
                    }
                });
            } else if(target.classList.contains('edit-request')) {
                 const requestToEdit = state.userRequests.find(r => r.id === id);
                 const attendeesResult = await apiRequest('getAttendeesForRequest', { requestId: id });

                 if (requestToEdit && attendeesResult.status === 'success') {
                    await navigateToPage('form-page');
                    document.getElementById('form-request-id').value = requestToEdit.id;
                    document.getElementById('form-doc-date').value = toISODateString(requestToEdit.docDate);
                    document.getElementById('form-requester-name').value = requestToEdit.requesterName;
                    document.getElementById('form-requester-position').value = requestToEdit.requesterPosition;
                    document.getElementById('form-location').value = requestToEdit.location;
                    document.getElementById('form-purpose').value = requestToEdit.purpose;
                    document.getElementById('form-start-date').value = toISODateString(requestToEdit.startDate);
                    document.getElementById('form-end-date').value = toISODateString(requestToEdit.endDate);
                    document.getElementById('form-department').value = requestToEdit.department;
                    document.getElementById('form-head-name').value = requestToEdit.headName;
                    
                    document.querySelector(`input[name="expense_option"][value="${requestToEdit.expenseOption}"]`).click();
                    if(requestToEdit.expenseOption === 'partial') {
                        const expenseItems = JSON.parse(requestToEdit.expenseItems || '[]');
                        expenseItems.forEach(item => {
                            const checkbox = document.querySelector(`input[name="expense_item"][value="${item.name}"]`);
                            if (checkbox) checkbox.checked = true;
                            if (item.name === 'ค่าใช้จ่ายอื่นๆ') document.getElementById('expense_other_text').value = item.detail;
                        });
                        document.getElementById('form-total-expense').value = requestToEdit.totalExpense;
                    }

                    document.querySelector(`input[name="vehicle_option"][value="${requestToEdit.vehicleOption}"]`).click();
                    if(requestToEdit.vehicleOption === 'private') {
                        document.getElementById('form-license-plate').value = requestToEdit.licensePlate;
                    }

                    elements.formAttendeesList.innerHTML = '';
                    attendeesResult.data.forEach(att => addAttendeeRow(att.name, att.position));
                    elements.submitButtonText.textContent = "อัปเดตและสร้างเอกสารใหม่";
                 }
            }
        });

        elements.searchRequests.addEventListener('input', e => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = state.userRequests.filter(req => req.purpose.toLowerCase().includes(searchTerm) || req.location.toLowerCase().includes(searchTerm) || req.id.toLowerCase().includes(searchTerm));
            renderUserRequests(filtered);
        });
        
        // Memo Page
        elements.memoForm.addEventListener('submit', handleMemoSubmit);
        elements.memoFile.addEventListener('change', () => {
            elements.memoFilename.textContent = elements.memoFile.files.length > 0 ? elements.memoFile.files[0].name : '';
        });
         document.querySelectorAll('input[name="memo_type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isReimburse = e.target.value === 'reimburse';
                document.getElementById('memo-file-container').classList.toggle('hidden', isReimburse);
                document.getElementById('memo-file').required = !isReimburse;
            });
        });

        // Excel Import/Download
        elements.formDownloadTemplate.addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const ws_data = [ ["FullName", "Position"], ["นายตัวอย่าง มีสกุล", "ครู"] ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Attendees");
            XLSX.writeFile(wb, "attendee_template.xlsx");
        });
        elements.formImportExcel.addEventListener('click', () => elements.excelFileInput.click());
        elements.excelFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                elements.formAttendeesList.innerHTML = '';
                json.forEach(row => addAttendeeRow(row.FullName, row.Position));
            };
            reader.readAsArrayBuffer(file);
        });
        
        // Admin Memos Page
        elements.adminMemosList.addEventListener('click', e => {
            if (e.target.classList.contains('update-memo-status')) {
                const memoId = e.target.dataset.id;
                handleMemoStatusUpdate(memoId);
            }
        });

        // Admin Command Page & Dispatch Book
        elements.commandRequestsList.addEventListener('click', e => {
            if (e.target.classList.contains('approve-command')) {
                handleApproveCommand(e.target.dataset.id);
            }
            if (e.target.classList.contains('generate-dispatch')) {
                const requestId = e.target.dataset.id;
                document.getElementById('dispatch-request-id').value = requestId;
                
                const now = new Date();
                const thaiYear = now.getFullYear() + 543;
                const thaiMonth = now.toLocaleDateString('th-TH', { month: 'long' });
                document.getElementById('dispatch-year').value = thaiYear;
                document.getElementById('dispatch-month').value = thaiMonth;

                elements.dispatchModal.style.display = 'flex';
            }
        });
        elements.dispatchForm.addEventListener('submit', handleGenerateDispatchBook);
        elements.dispatchModalCloseButton.addEventListener('click', () => {
            elements.dispatchModal.style.display = 'none';
        });

        elements.goToMemoPageButton.addEventListener('click', async (e) => {
            const newRequestId = e.currentTarget.dataset.newRequestId;
            await navigateToPage('memo-page');
            if (newRequestId) {
                document.getElementById('memo-ref-number').value = newRequestId;
            }
        });
        
        // Stats Page
        elements.statsContent.addEventListener('click', (e) => {
            const target = e.target.closest('button[data-key]');
            if (target) {
                const { key, type } = target.dataset;
                showStatsDetail(key, type);
            }
        });
        elements.statsDetailCloseButton.addEventListener('click', () => {
            elements.statsDetailModal.style.display = 'none';
        });

    };
    
     const handleUserImport = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const usersToImport = XLSX.utils.sheet_to_json(worksheet);

                if (usersToImport.length === 0) {
                    showAlert('ผิดพลาด', 'ไฟล์ Excel ว่างเปล่าหรือไม่ถูกต้อง');
                    return;
                }
                
                const firstUser = usersToImport[0];
                if (!firstUser.Username || !firstUser.Password || !firstUser.FullName || !firstUser.Position || !firstUser.Department || !firstUser.Role) {
                     showAlert('ผิดพลาด', 'ไฟล์ Excel ไม่มีคอลัมน์ที่ถูกต้อง (Username, Password, FullName, Position, Department, Role)');
                     return;
                }

                showConfirm('ยืนยันการนำเข้า', `คุณต้องการนำเข้าผู้ใช้จำนวน ${usersToImport.length} คนหรือไม่?`, async () => {
                     const result = await apiRequest('importUsers', { users: usersToImport });
                     if (result.status === 'success') {
                         showAlert('สำเร็จ', result.message);
                         await fetchAllUsers(); // Refresh the list
                     }
                });

            } catch (error) {
                showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถอ่านไฟล์ Excel ได้: ' + error.message);
            } finally {
                e.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    };

    init();
});
</script>
</body>
</html>

