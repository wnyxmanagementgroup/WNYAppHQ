<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.3s; }
        .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 700; text-align: center; transition: all 0.3s; cursor: pointer; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover { background-color: #16a34a; }
        .btn-outline { background-color: transparent; color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-outline:hover { background-color: #eff6ff; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #6b7280; }
        .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; margin: auto; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* สไตล์สำหรับปุ่มอัปโหลด */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-upload-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload-btn {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .file-name {
            margin-left: 1rem;
            font-style: italic;
            color: #4b5563;
        }

        /* สไตล์สำหรับ Spinner */
        .spinner {
            display: none; /* ซ่อนไว้ก่อน */
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: fixed; /* ให้อยู่กลางจอ */
            top: 50%;
            left: 50%;
            z-index: 1000;
            margin-top: -25px; /* ครึ่งนึงของ height */
            margin-left: -25px; /* ครึ่งนึงของ width */
        }
        .overlay {
            display: none; /* ซ่อนไว้ก่อน */
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.3); /* พื้นหลังมัวๆ */
            z-index: 999;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loadingOverlay" class="overlay"></div>
    <div id="loadingSpinner" class="spinner"></div>

    <div id="app" class="max-w-7xl mx-auto">
        
        <div id="loginPage" class="page active max-w-md mx-auto mt-16 main-container p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">WNY App ไปราชการ</h2>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
                    <input type="text" id="username" name="username" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="password" name="password" class="form-input mt-1" required>
                </div>
                <div id="loginError" class="text-red-600 text-sm hidden">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง</div>
                <button type="submit" class="btn btn-primary w-full">เข้าสู่ระบบ</button>
            </form>
            <div class="text-center mt-4">
                <a href="#" id="showRegister" class="text-sm text-blue-600 hover:underline">ยังไม่มีบัญชี? ลงทะเบียนที่นี่</a>
            </div>
        </div>

        <div id="registerPage" class="page max-w-md mx-auto mt-16 main-container p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">ลงทะเบียน</h2>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (สำหรับ Login)</label>
                    <input type="text" id="regUsername" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="regPassword" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล (เต็ม)</label>
                    <input type="text" id="regFullName" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                    <input type="text" id="regPosition" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                    <input type="text" id="regDepartment" class="form-input mt-1" required>
                </div>
                <div id="registerError" class="text-red-600 text-sm hidden"></div>
                <div id="registerSuccess" class="text-green-600 text-sm hidden"></div>
                <button type="submit" class="btn btn-primary w-full">ลงทะเบียน</button>
            </form>
            <div class="text-center mt-4">
                <a href="#" id="showLogin" class="text-sm text-blue-600 hover:underline">มีบัญชีแล้ว? เข้าสู่ระบบที่นี่</a>
            </div>
        </div>

        <div id="mainPage" class="page main-container p-6 md:p-8 rounded-xl shadow-lg">
            <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ระบบบันทึกไปราชการ</h1>
                    <p id="welcomeUser" class="text-gray-600 mt-1"></p>
                </div>
                <nav class="flex items-center space-x-4 mt-4 md:mt-0">
                    <button id="profileBtn" class="btn btn-outline">โปรไฟล์</button>
                    <button id="logoutBtn" class="btn btn-secondary">ออกจากระบบ</button>
                </nav>
            </header>

            <div class="flex flex-wrap border-b border-gray-200 mb-6">
                <button class="main-tab tab active" data-page="homePage">หน้าหลัก</button>
                <button class="main-tab tab" data-page="createRequestPage">สร้างคำขอใหม่</button>
                <button class="main-tab tab" data-page="myRequestsPage">คำขอของฉัน</button>
                <button class="main-tab tab" data-page="memoPage">ส่งบันทึกสรุป</button>
                <button id="adminTab" class="main-tab tab hidden" data-page="adminPage">จัดการระบบ (Admin)</button>
            </div>

            <div id="mainContent">
                
                <div id="homePage" class="main-page-content active">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">แดชบอร์ดสรุป</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-blue-700">คำขอทั้งหมด (ของฉัน)</h3>
                            <p id="statMyTotalRequests" class="text-3xl font-bold text-blue-900 mt-2">0</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-green-700">เสร็จสิ้น (ของฉัน)</h3>
                            <p id="statMyCompletedRequests" class="text-3xl font-bold text-green-900 mt-2">0</p>
                        </div>
                        <div class="bg-yellow-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-yellow-700">กำลังดำเนินการ (ของฉัน)</h3>
                            <p id="statMyPendingRequests" class="text-3xl font-bold text-yellow-900 mt-2">0</p>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-indigo-700">บันทึกที่ส่งแล้ว (ของฉัน)</h3>
                            <p id="statMyMemos" class="text-3xl font-bold text-indigo-900 mt-2">0</p>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">สถานะคำขอของฉัน</h3>
                        <div class="bg-white p-4 rounded-lg shadow" style="max-width: 400px; margin: auto;">
                            <canvas id="myRequestsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="createRequestPage" class="main-page-content">
                    <h2 id="formTitle" class="text-2xl font-bold text-gray-800 mb-6">สร้างบันทึกข้อความขอไปราชการ</h2>
                    <form id="requestForm" class="space-y-6">
                        <input type="hidden" id="editRequestId">
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ชื่อผู้ขอ</label>
                                <input type="text" id="requesterName" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                                <input type="text" id="requesterPosition" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                                <input type="text" id="requesterDepartment" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">วันที่ออกเอกสาร</label>
                                <input type="date" id="docDate" class="form-input mt-1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ชื่อหัวหน้ากลุ่มสาระฯ/งาน</label>
                                <input type="text" id="headName" class="form-input mt-1" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">เรื่อง (วัตถุประสงค์)</label>
                                <textarea id="purpose" class="form-input mt-1" rows="3" required></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">สถานที่</label>
                                <textarea id="location" class="form-input mt-1" rows="3" required></textarea>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">วันที่เริ่มไปราชการ</label>
                                <input type="datetime-local" id="startDate" class="form-input mt-1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                                <input type="datetime-local" id="endDate" class="form-input mt-1" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">การเดินทาง</label>
                            <div class="mt-2 space-y-2 md:space-y-0 md:flex md:space-x-6">
                                <div class="flex items-center">
                                    <input type="radio" id="vehicle_gov" name="vehicleOption" value="gov" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="vehicle_gov" class="ml-2 block text-sm text-gray-900">รถยนต์ราชการ (ระบุทะเบียน)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="vehicle_private" name="vehicleOption" value="private" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="vehicle_private" class="ml-2 block text-sm text-gray-900">รถยนต์ส่วนตัว (ระบุทะเบียน)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="vehicle_public" name="vehicleOption" value="public" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <label for="vehicle_public" class="ml-2 block text-sm text-gray-900">รถโดยสารสาธารณะ</label>
                                </div>
                            </div>
                            <input type="text" id="licensePlate" class="form-input mt-2 w-full md:w-1/3" placeholder="ระบุเลขทะเบียน..." style="display: none;">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">ค่าใช้จ่าย</label>
                            <div class="mt-2 space-y-2 md:space-y-0 md:flex md:space-x-6">
                                <div class="flex items-center">
                                    <input type="radio" id="expense_yes" name="expenseOption" value="partial" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <label for="expense_yes" class="ml-2 block text-sm text-gray-900">เบิกค่าใช้จ่าย (บางส่วน/ทั้งหมด)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="expense_no" name="expenseOption" value="no" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="expense_no" class="ml-2 block text-sm text-gray-900">ไม่เบิกค่าใช้จ่าย</label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="expenseDetails" class="space-y-4 p-4 border border-gray-200 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700">รายการค่าใช้จ่ายที่ขอเบิก</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_allowance" name="expenseItem" value="ค่าเบี้ยเลี้ยง" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_allowance" class="ml-2 block text-sm text-gray-900">ค่าเบี้ยเลี้ยง</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_accommodation" name="expenseItem" value="ค่าที่พัก" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_accommodation" class="ml-2 block text-sm text-gray-900">ค่าที่พัก</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_transport" name="expenseItem" value="ค่าพาหนะ" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_transport" class="ml-2 block text-sm text-gray-900">ค่าพาหนะ</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_food" name="expenseItem" value="ค่าอาหาร" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_food" class="ml-2 block text-sm text-gray-900">ค่าอาหาร</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_fuel" name="expenseItem" value="ค่าน้ำมัน" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_fuel" class="ml-2 block text-sm text-gray-900">ค่าน้ำมัน</label>
                                </div>
                                <div class="flex items-center col-span-2 md:col-span-3">
                                    <input type="checkbox" id="expense_other" name="expenseItem" value="ค่าใช้จ่ายอื่นๆ" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_other" class="ml-2 block text-sm text-gray-900">อื่นๆ (ระบุ):</label>
                                    <input type="text" id="expense_other_text" class="form-input ml-2 flex-1" placeholder="ระบุรายละเอียด...">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">รวมเป็นเงิน (บาท)</label>
                                <input type="number" id="totalExpense" class="form-input mt-1 md:w-1/3" min="0" step="0.01" value="0">
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-medium text-gray-900">ผู้ติดตาม (ถ้ามี)</h3>
                            <div id="attendeesList" class="space-y-3 mt-2">
                                </div>
                            <button type="button" id="addAttendee" class="btn btn-outline mt-4">+ เพิ่มผู้ติดตาม</button>
                        </div>
                        
                        <div id="formError" class="text-red-600 text-sm hidden"></div>
                        <button type="submit" id="submitRequestBtn" class="btn btn-primary w-full md:w-auto">บันทึกและสร้าง PDF</button>
                    </form>
                </div>

                <div id="myRequestsPage" class="main-page-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">คำขอของฉัน</h2>
                    <div class="mb-4">
                        <input type="text" id="myRequestsSearch" class="form-input w-full md:w-1/2" placeholder="ค้นหาจากวัตถุประสงค์, สถานที่, หรือ ID...">
                    </div>
                    <div id="myRequestsContainer" class="table-responsive">
                        </div>
                    <div id="noMyRequestsMsg" class="text-gray-500 text-center py-8 hidden">
                        ไม่พบคำขอ
                    </div>
                </div>

                <div id="memoPage" class="main-page-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">ส่งบันทึกสรุปหลังไปราชการ</h2>
                    <form id="memoForm" class="space-y-6 max-w-lg mx-auto">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">เลือกคำขอ (ที่ยังไม่ได้ส่งสรุป)</label>
                            <select id="memoRefNumber" class="form-input mt-1" required>
                                <option value="">-- กรุณาเลือกคำขอ --</option>
                                </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ประเภทการส่ง</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input type="radio" id="memoTypeFile" name="memoType" value="file" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <label for="memoTypeFile" class="ml-2 block text-sm text-gray-900">แนบไฟล์สรุป (สำหรับ 'ไม่เบิก')</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="memoTypeReimburse" name="memoType" value="reimburse" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="memoTypeReimburse" class="ml-2 block text-sm text-gray-900">ส่งเพื่อเบิก (สำหรับ 'เบิก')</label>
                                </div>
                            </div>
                        </div>

                        <div id="memoFileUploadSection">
                            <label class="block text-sm font-medium text-gray-700">อัปโหลดไฟล์สรุป (PDF/JPG/PNG)</label>
                            <div class="mt-1 flex items-center">
                                <label class="file-upload-wrapper">
                                    <span class="file-upload-btn">เลือกไฟล์</span>
                                    <input type="file" id="memoFile" accept=".pdf,.jpg,.jpeg,.png">
                                </label>
                                <span id="memoFileName" class="file-name">ยังไม่ได้เลือกไฟล์</span>
                            </div>
                        </div>

                        <div id="memoError" class="text-red-600 text-sm hidden"></div>
                        <button type="submit" class="btn btn-primary w-full">ส่งบันทึกสรุป</button>
                    </form>
                    
                    <hr class="my-12">
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">บันทึกที่ฉันส่งแล้ว</h2>
                    <div id="myMemosContainer" class="table-responsive">
                        </div>
                    <div id="noMyMemosMsg" class="text-gray-500 text-center py-8 hidden">
                        ไม่พบข้อมูล
                    </div>
                </div>

                <div id="adminPage" class="main-page-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">จัดการระบบ (Admin)</h2>
                    
                    <div class="flex flex-wrap border-b border-gray-200 mb-6">
                        <button class="admin-tab tab active" data-page="adminRequests">จัดการคำขอทั้งหมด</button>
                        <button class="admin-tab tab" data-page="adminMemos">จัดการบันทึกสรุป</button>
                        <button class="admin-tab tab" data-page="adminUsers">จัดการผู้ใช้</button>
                        <button class="admin-tab tab" data-page="adminDashboard">สรุปภาพรวม</button>
                    </div>

                    <div id="adminRequests" class="admin-page-content active">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">คำขอทั้งหมด</h3>
                        <div class="mb-4">
                            <input type="text" id="adminRequestsSearch" class="form-input w-full md:w-1/2" placeholder="ค้นหาจากผู้ขอ, วัตถุประสงค์, สถานที่, หรือ ID...">
                        </div>
                        <div id="adminRequestsContainer" class="table-responsive">
                            </div>
                        <div id="noAdminRequestsMsg" class="text-gray-500 text-center py-8 hidden">
                            ไม่พบคำขอ
                        </div>
                    </div>

                    <div id="adminMemos" class="admin-page-content hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">บันทึกสรุปทั้งหมด</h3>
                        <div class="mb-4">
                            <input type="text" id="adminMemosSearch" class="form-input w-full md:w-1/2" placeholder="ค้นหาจากผู้ส่ง, ID คำขอ, หรือ ID บันทึก...">
                        </div>
                        <div id="adminMemosContainer" class="table-responsive">
                            </div>
                        <div id="noAdminMemosMsg" class="text-gray-500 text-center py-8 hidden">
                            ไม่พบข้อมูล
                        </div>
                    </div>

                    <div id="adminUsers" class="admin-page-content hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">จัดการผู้ใช้</h3>
                        <div class="mb-4 flex space-x-2">
                            <button id="showAddUserModal" class="btn btn-primary">เพิ่มผู้ใช้ใหม่</button>
                            <label class="file-upload-wrapper">
                                <span class="file-upload-btn btn-outline">นำเข้าผู้ใช้ (XLSX)</span>
                                <input type="file" id="importUsersFile" accept=".xlsx">
                            </label>
                        </div>
                        <div id="adminUsersContainer" class="table-responsive">
                            </div>
                    </div>

                    <div id="adminDashboard" class="admin-page-content hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">สรุปภาพรวมระบบ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-blue-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-blue-700">คำขอทั้งหมด (ในระบบ)</h3>
                                <p id="adminStatTotalRequests" class="text-3xl font-bold text-blue-900 mt-2">0</p>
                            </div>
                            <div class="bg-purple-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-purple-700">บันทึกสรุปทั้งหมด (ในระบบ)</h3>
                                <p id="adminStatTotalMemos" class="text-3xl font-bold text-purple-900 mt-2">0</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-green-700">ผู้ใช้ทั้งหมด</h3>
                                <p id="adminStatTotalUsers" class="text-3xl font-bold text-green-900 mt-2">0</p>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-gray-700">...</h3>
                                <p class="text-3xl font-bold text-gray-900 mt-2">0</p>
                            </div>
                        </div>
                        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-gray-800 mb-3 text-center">คำขอตามกลุ่มสาระฯ</h4>
                                <canvas id="requestsByDeptChart"></canvas>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-gray-800 mb-3 text-center">คำขอรายเดือน</h4>
                                <canvas id="requestsByMonthChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="mt-8 bg-white p-4 rounded-lg shadow">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">รายงาน</h3>
                            <div class="flex space-x-2">
                                <button class="btn btn-outline" onclick="showReportByExpenseType('no')">รายงาน (ไม่เบิก)</button>
                                <button class="btn btn-outline" onclick="showReportByExpenseType('partial')">รายงาน (เบิก)</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div> <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('profileModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">โปรไฟล์ของฉัน</h3>
            <form id="profileForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (Login)</label>
                    <input type="text" id="profileUsername" class="form-input mt-1 bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล</label>
                    <input type="text" id="profileFullName" class="form-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                    <input type="text" id="profilePosition" class="form-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                    <input type="text" id="profileDepartment" class="form-input mt-1">
                </div>
                <button type="submit" class="btn btn-primary w-full">บันทึกการเปลี่ยนแปลง</button>
            </form>
            <hr class="my-6">
            <h4 class="text-xl font-bold mb-4">เปลี่ยนรหัสผ่าน</h4>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่านปัจจุบัน</label>
                    <input type="password" id="oldPassword" class="form-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่านใหม่</label>
                    <input type="password" id="newPassword" class="form-input mt-1">
                </div>
                <div id="passwordError" class="text-red-600 text-sm hidden"></div>
                <div id="passwordSuccess" class="text-green-600 text-sm hidden"></div>
                <button type="submit" class="btn btn-secondary w-full">เปลี่ยนรหัสผ่าน</button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('addUserModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">เพิ่มผู้ใช้ใหม่</h3>
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (สำหรับ Login)</label>
                    <input type="text" id="adminRegUsername" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="adminRegPassword" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล (เต็ม)</label>
                    <input type="text" id="adminRegFullName" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                    <input type="text" id="adminRegPosition" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                    <input type="text" id="adminRegDepartment" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">บทบาท (role)</label>
                    <select id="adminRegRole" class="form-input mt-1">
                        <option value="user">user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div id="addUserError" class="text-red-600 text-sm hidden"></div>
                <button type="submit" class="btn btn-primary w-full">เพิ่มผู้ใช้</button>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-center">ยืนยันการลบ</h3>
            <p class="text-gray-600 text-center mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="btn btn-danger">ยืนยันการลบ</button>
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">ยกเลิก</button>
            </div>
        </div>
    </div>

    <div id="requestDetailsModal" class="modal">
        <div class="modal-content max-w-3xl">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('requestDetailsModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">รายละเอียดคำขอ</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>ID:</strong> <span id="detailId"></span></div>
                    <div><strong>วันที่เอกสาร:</strong> <span id="detailDocDate"></span></div>
                </div>
                <div><strong>ผู้ขอ:</strong> <span id="detailRequesterName"></span></div>
                <div><strong>ตำแหน่ง:</strong> <span id="detailPosition"></span></div>
                <div><strong>วัตถุประสงค์:</strong> <span id="detailPurpose"></span></div>
                <div><strong>สถานที่:</strong> <span id="detailLocation"></span></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>วันที่เริ่ม:</strong> <span id="detailStartDate"></span></div>
                    <div><strong>วันที่สิ้นสุด:</strong> <span id="detailEndDate"></span></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>การเดินทาง:</strong> <span id="detailVehicle"></span></div>
                    <div><strong>ทะเบียน:</strong> <span id="detailLicense"></span></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>ค่าใช้จ่าย:</strong> <span id="detailExpense"></span></div>
                    <div><strong>รวม (บาท):</strong> <span id="detailTotalExpense"></span></div>
                </div>
                <div><strong>รายการที่เบิก:</strong> <span id="detailExpenseItems"></span></div>
                <div><strong>ผู้ติดตาม:</strong> <div id="detailAttendees" class="mt-1 pl-4"></div></div>
                <hr class="my-4">
                <h4 class="text-lg font-bold">ไฟล์เอกสาร</h4>
                <div class="flex flex-wrap gap-4">
                    <a id="detailPdfLink" href="#" target="_blank" class="btn btn-primary">บันทึกข้อความ (PDF)</a>
                    <a id="detailCmdSoloLink" href="#" target="_blank" class="btn btn-outline">คำสั่ง (1 คน)</a>
                    <a id="detailCmdSmallLink" href="#" target="_blank" class="btn btn-outline">คำสั่ง (2-5 คน)</a>
                    <a id="detailCmdLargeLink" href="#" target="_blank" class="btn btn-outline">คำสั่ง (6+ คน)</a>
                    <a id="detailCmdFinalLink" href="#" target="_blank" class="btn btn-success hidden">คำสั่งที่อนุมัติ (PDF)</a>
                    <a id="detailDispatchLink" href="#" target="_blank" class="btn btn-success hidden">หนังสือส่งเขต (PDF)</a>
                </div>
            </div>
        </div>
    </div>

    <div id="memoDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('memoDetailsModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">รายละเอียดบันทึกสรุป</h3>
            <div class="space-y-3">
                <div><strong>ID บันทึก:</strong> <span id="memoDetailId"></span></div>
                <div><strong>ID คำขอ:</strong> <span id="memoDetailRefNumber"></span></div>
                <div><strong>ผู้ส่ง:</strong> <span id="memoDetailUsername"></span></div>
                <div><strong>วันที่ส่ง:</strong> <span id="memoDetailTimestamp"></span></div>
                <div><strong>สถานะ:</strong> <span id="memoDetailStatus" class="font-bold"></span></div>
                <div><strong>ไฟล์แนบ:</strong> <a id="memoDetailFileUrl" href="#" target="_blank" class="text-blue-600 hover:underline">เปิดไฟล์</a></div>
                <hr>
                <div><strong>ผู้อนุมัติ:</strong> <span id="memoDetailApprovedBy"></span></div>
                <div><strong>วันที่อนุมัติ:</strong> <span id="memoDetailApprovalDate"></span></div>
                <div><strong>หมายเหตุ:</strong> <span id="memoDetailRemarks"></span></div>
            </div>
        </div>
    </div>
    
    <div id="approveCommandModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('approveCommandModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">อนุมัติและเลือกแบบคำสั่ง</h3>
            <form id="approveCommandForm" class="space-y-4">
                <input type="hidden" id="approveCommandRequestId">
                <p>เลือกรูปแบบคำสั่งที่ถูกต้องสำหรับ ID: <span id="approveCommandIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">เลือกรูปแบบ</label>
                    <select id="commandTemplateType" class="form-input mt-1" required>
                        <option value="">-- เลือก --</option>
                        <option value="solo">1 คน (Solo)</option>
                        <option value="groupSmall">2-5 คน (Group Small)</option>
                        <option value="groupLarge">6+ คน (Group Large)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">อนุมัติคำสั่ง</button>
            </form>
        </div>
    </div>
    
    <div id="generateDispatchModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('generateDispatchModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">สร้างหนังสือส่งเขต</h3>
            <form id="generateDispatchForm" class="space-y-4">
                <input type="hidden" id="dispatchRequestId">
                <p>สำหรับ ID: <span id="dispatchIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">เดือน (เช่น มกราคม)</label>
                    <input type="text" id="dispatchMonth" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ปี (พ.ศ.)</label>
                    <input type="number" id="dispatchYear" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">จำนวนคำสั่ง (เรื่อง)</label>
                    <input type="number" id="dispatchCommandCount" class="form-input mt-1" value="0" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">จำนวนบันทึก (เรื่อง)</label>
                    <input type="number" id="dispatchMemoCount" class="form-input mt-1" value="0" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">สร้างหนังสือส่ง</button>
            </form>
        </div>
    </div>

    <div id="updateStatusCommandModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('updateStatusCommandModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">อัปเดตสถานะคำสั่ง</h3>
            <form id="updateStatusCommandForm" class="space-y-4">
                <input type="hidden" id="updateCommandRequestId">
                <p>สำหรับ ID: <span id="updateCommandIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">สถานะใหม่</label>
                    <input type="text" id="newCommandStatus" class="form-input mt-1" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">อัปเดตสถานะ</button>
            </form>
        </div>
    </div>
    
    <div id="updateMemoStatusModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('updateMemoStatusModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">อนุมัติบันทึกสรุป</h3>
            <form id="updateMemoStatusForm" class="space-y-4">
                <input type="hidden" id="updateMemoId">
                <p>สำหรับ Memo ID: <span id="updateMemoIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">สถานะ</label>
                    <select id="newMemoStatus" class="form-input mt-1" required>
                        <option value="อนุมัติ">อนุมัติ</option>
                        <option value="ตีกลับ">ตีกลับ</option>
                        <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                    </select>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">หมายเหตุ (ถ้ามี)</label>
                    <textarea id="memoRemarks" class="form-input mt-1" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">บันทึก</button>
            </form>
        </div>
    </div>
    
    <div id="reportModal" class="modal">
        <div class="modal-content max-w-4xl">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('reportModal')">&times;</span>
            <h3 id="reportTitle" class="text-2xl font-bold mb-6">รายงาน</h3>
            <div id="reportContent" class="table-responsive">
                </div>
        </div>
    </div>


    <script>
        // --- CONFIG ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby49W-vB5SgCgA-D5yDYYY0f3b0eCqg_Yf_v5d5e_r5f5g5h5j5k5l5/exec'; // <--- !!! ใส่ URL ของ Web App ที่ Deploy แล้วที่นี่

        // --- STATE ---
        let currentUser = null;
        let allRequestsCache = [];
        let allMemosCache = [];
        let allUsersCache = [];
        let myRequestsCache = [];
        let myMemosCache = [];
        let myRequestsChartInstance = null;
        let requestsByDeptChartInstance = null;
        let requestsByMonthChartInstance = null;

        // --- SPINNER ---
        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('loadingOverlay').style.display = 'block';
        }
        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // --- APP INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in from session storage
            const- savedUser = sessionStorage.getItem('wnyUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showPage('mainPage');
                initializeApp();
            } else {
                showPage('loginPage');
            }

            // --- EVENT LISTENERS ---
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('showRegister').addEventListener('click', (e) => { e.preventDefault(); showPage('registerPage'); });
            document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); showPage('loginPage'); });
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            document.getElementById('profileBtn').addEventListener('click', openProfileModal);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordUpdate);

            // Main Nav
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const pageId = e.target.getAttribute('data-page');
                    showMainPageContent(pageId);
                });
            });

            // Admin Nav
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const pageId = e.target.getAttribute('data-page');
                    showAdminPageContent(pageId);
                });
            });
            
            // Request Form
            document.getElementById('requestForm').addEventListener('submit', handleSubmitRequest);
            document.getElementById('addAttendee').addEventListener('click', addAttendeeRow);
            document.querySelectorAll('input[name="vehicleOption"]').forEach(radio => {
                radio.addEventListener('change', toggleLicensePlate);
            });
            document.querySelectorAll('input[name="expenseOption"]').forEach(radio => {
                radio.addEventListener('change', toggleExpenseDetails);
            });
            
            // Memo Form
            document.getElementById('memoForm').addEventListener('submit', handleSubmitMemo);
            document.getElementById('memoFile').addEventListener('change', (e) => {
                const fileName = e.target.files[0] ? e.target.files[0].name : 'ยังไม่ได้เลือกไฟล์';
                document.getElementById('memoFileName').textContent = fileName;
            });
            document.querySelectorAll('input[name="memoType"]').forEach(radio => {
                radio.addEventListener('change', toggleMemoUploadSection);
            });
            
            // Search
            document.getElementById('myRequestsSearch').addEventListener('input', (e) => renderMyRequestsList(myRequestsCache, myMemosCache, e.target.value));
            document.getElementById('adminRequestsSearch').addEventListener('input', (e) => renderRequestsList(allRequestsCache, allMemosCache, e.target.value));
            document.getElementById('adminMemosSearch').addEventListener('input', (e) => renderMemosList(allMemosCache, e.target.value));

            // Admin Modals
            document.getElementById('showAddUserModal').addEventListener('click', () => openModal('addUserModal'));
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('importUsersFile').addEventListener('change', handleImportUsers);
            document.getElementById('approveCommandForm').addEventListener('submit', handleApproveCommand);
            document.getElementById('generateDispatchForm').addEventListener('submit', handleGenerateDispatch);
            document.getElementById('updateStatusCommandForm').addEventListener('submit', handleUpdateStatusCommand);
            document.getElementById('updateMemoStatusForm').addEventListener('submit', handleUpdateMemoStatus);
        });

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }
        function showMainPageContent(pageId) {
            document.querySelectorAll('.main-page-content').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-page') === pageId);
            });
            // Refresh data when switching to certain tabs
            if (pageId === 'myRequestsPage') loadMyRequests();
            if (pageId === 'memoPage') loadMemoData();
            if (pageId === 'homePage') loadDashboardData();
        }
        function showAdminPageContent(pageId) {
            document.querySelectorAll('.admin-page-content').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-page') === pageId);
            });
            // Refresh data when switching admin tabs
            if (pageId === 'adminRequests') loadAllRequests();
            if (pageId === 'adminMemos') loadAllMemos();
            if (pageId === 'adminUsers') loadAllUsers();
            if (pageId === 'adminDashboard') loadAdminDashboard();
        }

        // --- MODAL CONTROLS ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        // Close modal on outside click
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // --- API CALL FUNCTION ---
        async function gasApiCall(action, payload) {
            showSpinner();
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-t' },
                    body: JSON.stringify({ action, payload })
                });
                const result = await response.json();
                hideSpinner();
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                return result;
            } catch (error) {
                hideSpinner();
                console.error('GAS API Error:', action, error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
                throw error;
            }
        }
        
        async function gasApiGet(action, params = {}) {
            showSpinner();
            try {
                const url = new URL(GAS_URL);
                url.searchParams.append('action', action);
                for (const key in params) {
                    url.searchParams.append(key, params[key]);
                }
                const response = await fetch(url, { method: 'GET' });
                const result = await response.json();
                hideSpinner();
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                return result.data;
            } catch (error) {
                hideSpinner();
                console.error('GAS API GET Error:', action, error);
                alert(`เกิดข้อผิดพลาด: ${error.message}`);
                throw error;
            }
        }

        // --- AUTHENTICATION ---
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            try {
                const result = await gasApiCall('verifyCredentials', { username, password });
                if (result.status === 'success') {
                    currentUser = result.user;
                    sessionStorage.setItem('wnyUser', JSON.stringify(currentUser));
                    loginError.classList.add('hidden');
                    initializeApp();
                } else {
                    loginError.classList.remove('hidden');
                    loginError.textContent = result.message;
                }
            } catch (error) {
                loginError.classList.remove('hidden');
                loginError.textContent = error.message;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const fullName = document.getElementById('regFullName').value;
            const position = document.getElementById('regPosition').value;
            const department = document.getElementById('regDepartment').value;
            const registerError = document.getElementById('registerError');
            const registerSuccess = document.getElementById('registerSuccess');

            try {
                const result = await gasApiCall('registerUser', { username, password, fullName, position, department, role: 'user' });
                if (result.status === 'success') {
                    registerError.classList.add('hidden');
                    registerSuccess.classList.remove('hidden');
                    registerSuccess.textContent = 'ลงทะเบียนสำเร็จ! กรุณากลับไปหน้าเข้าสู่ระบบ';
                    document.getElementById('registerForm').reset();
                } else {
                    registerSuccess.classList.add('hidden');
                    registerError.classList.remove('hidden');
                    registerError.textContent = result.message;
                }
            } catch (error) {
                registerSuccess.classList.add('hidden');
                registerError.classList.remove('hidden');
                registerError.textContent = error.message;
            }
        }
        
        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('wnyUser');
            showPage('loginPage');
            document.getElementById('adminTab').classList.add('hidden');
        }

        // --- APP INITIALIZATION ---
        function initializeApp() {
            showPage('mainPage');
            showMainPageContent('homePage');
            document.getElementById('welcomeUser').textContent = `ยินดีต้อนรับ, ${currentUser.fullName} (${currentUser.position})`;
            if (currentUser.role === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            }
            loadDashboardData();
        }

        // --- DASHBOARD ---
        async function loadDashboardData() {
            // Load user-specific data
            try {
                const [requests, memos] = await Promise.all([
                    gasApiGet('getUserRequests', { username: currentUser.username }),
                    gasApiGet('getSentMemos', { username: currentUser.username })
                ]);
                
                myRequestsCache = requests;
                myMemosCache = memos;

                const completedStatuses = ['เสร็จสิ้น', 'อนุมัติ', 'เสร็จสิ้นรอออกคำสั่งไปราชการ'];
                const completedCount = requests.filter(r => completedStatuses.includes(r.status) || completedStatuses.includes(r.commandStatus)).length;
                const pendingCount = requests.length - completedCount;

                document.getElementById('statMyTotalRequests').textContent = requests.length;
                document.getElementById('statMyCompletedRequests').textContent = completedCount;
                document.getElementById('statMyPendingRequests').textContent = pendingCount;
                document.getElementById('statMyMemos').textContent = memos.length;
                
                renderMyRequestsChart(pendingCount, completedCount);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        function renderMyRequestsChart(pending, completed) {
            const ctx = document.getElementById('myRequestsChart').getContext('2d');
            if (myRequestsChartInstance) {
                myRequestsChartInstance.destroy();
            }
            myRequestsChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['กำลังดำเนินการ', 'เสร็จสิ้น'],
                    datasets: [{
                        data: [pending, completed],
                        backgroundColor: ['#f59e0b', '#22c55e'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
        }
        
        async function loadAdminDashboard() {
            try {
                const [requests, memos, users] = await Promise.all([
                    gasApiGet('getAllRequests'),
                    gasApiGet('getAllMemos'),
                    gasApiGet('getAllUsers')
                ]);
                
                allRequestsCache = requests;
                allMemosCache = memos;
                allUsersCache = users;
                
                document.getElementById('adminStatTotalRequests').textContent = requests.length;
                document.getElementById('adminStatTotalMemos').textContent = memos.length;
                document.getElementById('adminStatTotalUsers').textContent = users.length;
                
                renderAdminCharts(requests, users);

            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }
        
        function renderAdminCharts(requests, users) {
            // Chart 1: Requests by Department
            const deptCounts = requests.reduce((acc, req) => {
                const dept = req.department || 'ไม่ระบุ';
                acc[dept] = (acc[dept] || 0) + 1;
                return acc;
            }, {});
            const deptCtx = document.getElementById('requestsByDeptChart').getContext('2d');
            if (requestsByDeptChartInstance) {
                requestsByDeptChartInstance.destroy();
            }
            requestsByDeptChartInstance = new Chart(deptCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(deptCounts),
                    datasets: [{
                        label: 'จำนวนคำขอ',
                        data: Object.values(deptCounts),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    }]
                },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
            });

            // Chart 2: Requests by Month
            const monthCounts = requests.reduce((acc, req) => {
                try {
                    const month = new Date(req.docDate).getMonth(); // 0-11
                    acc[month] = (acc[month] || 0) + 1;
                } catch(e) {}
                return acc;
            }, new Array(12).fill(0));
            
            const monthLabels = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const monthCtx = document.getElementById('requestsByMonthChart').getContext('2d');
            if (requestsByMonthChartInstance) {
                requestsByMonthChartInstance.destroy();
            }
            requestsByMonthChartInstance = new Chart(monthCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'จำนวนคำขอ',
                        data: monthCounts,
                        borderColor: 'rgba(22, 163, 74, 0.7)',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        // --- PROFILE MANAGEMENT ---
        function openProfileModal() {
            document.getElementById('profileUsername').value = currentUser.username;
            document.getElementById('profileFullName').value = currentUser.fullName;
            document.getElementById('profilePosition').value = currentUser.position;
            document.getElementById('profileDepartment').value = currentUser.department;
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordSuccess').classList.add('hidden');
            openModal('profileModal');
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const payload = {
                username: currentUser.username,
                fullName: document.getElementById('profileFullName').value,
                position: document.getElementById('profilePosition').value,
                department: document.getElementById('profileDepartment').value,
            };
            try {
                const result = await gasApiCall('updateUserProfile', payload);
                if (result.status === 'success') {
                    // Update local user object
                    currentUser.fullName = payload.fullName;
                    currentUser.position = payload.position;
                    currentUser.department = payload.department;
                    sessionStorage.setItem('wnyUser', JSON.stringify(currentUser));
                    // Update UI
                    document.getElementById('welcomeUser').textContent = `ยินดีต้อนรับ, ${currentUser.fullName} (${currentUser.position})`;
                    alert('อัปเดตข้อมูลสำเร็จ');
                    closeModal('profileModal');
                }
            } catch (error) {
                alert(`อัปเดตล้มเหลว: ${error.message}`);
            }
        }
        
        async function handlePasswordUpdate(e) {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const passwordError = document.getElementById('passwordError');
            const passwordSuccess = document.getElementById('passwordSuccess');
            
            if (!oldPassword || !newPassword) {
                passwordError.textContent = 'กรุณากรอกรหัสผ่านปัจจุบันและรหัสผ่านใหม่';
                passwordError.classList.remove('hidden');
                return;
            }
            
            const payload = {
                username: currentUser.username,
                oldPassword: oldPassword,
                newPassword: newPassword
            };

            try {
                const result = await gasApiCall('updatePassword', payload);
                if (result.status === 'success') {
                    passwordError.classList.add('hidden');
                    passwordSuccess.classList.remove('hidden');
                    passwordSuccess.textContent = 'เปลี่ยนรหัสผ่านสำเร็จ';
                    document.getElementById('passwordForm').reset();
                } else {
                    passwordSuccess.classList.add('hidden');
                    passwordError.classList.remove('hidden');
                    passwordError.textContent = result.message;
                }
            } catch (error) {
                passwordSuccess.classList.add('hidden');
                passwordError.classList.remove('hidden');
                passwordError.textContent = error.message;
            }
        }

        // --- REQUEST FORM ---
        function resetRequestForm() {
            document.getElementById('requestForm').reset();
            document.getElementById('attendeesList').innerHTML = '';
            document.getElementById('expenseDetails').style.display = 'block';
            document.getElementById('licensePlate').style.display = 'none';
            document.getElementById('formTitle').textContent = 'สร้างบันทึกข้อความขอไปราชการ';
            document.getElementById('editRequestId').value = '';
            // Set default values from profile
            document.getElementById('requesterName').value = currentUser.fullName;
            document.getElementById('requesterPosition').value = currentUser.position;
            document.getElementById('requesterDepartment').value = currentUser.department;
            // Set default date
            document.getElementById('docDate').valueAsDate = new Date();
        }
        
        function addAttendeeRow(name = '', position = '') {
            const list = document.getElementById('attendeesList');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center';
            row.innerHTML = `
                <input type="text" class="form-input md:col-span-1" placeholder="ชื่อ-นามสกุล ผู้ติดตาม" value="${name}" required>
                <input type="text" class="form-input md:col-span-1" placeholder="ตำแหน่ง" value="${position}" required>
                <button type="button" class="btn btn-danger btn-sm md:col-span-1" onclick="this.parentElement.remove()">ลบ</button>
            `;
            list.appendChild(row);
        }

        function toggleLicensePlate(e) {
            const plateInput = document.getElementById('licensePlate');
            if (e.target.value === 'gov' || e.target.value === 'private') {
                plateInput.style.display = 'block';
                plateInput.required = true;
            } else {
                plateInput.style.display = 'none';
                plateInput.required = false;
            }
        }
        
        function toggleExpenseDetails(e) {
            const details = document.getElementById('expenseDetails');
            if (e.target.value === 'no') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
            }
        }
        
        async function handleSubmitRequest(e) {
            e.preventDefault();
            const formError = document.getElementById('formError');
            formError.classList.add('hidden');

            // Collect attendees
            const attendees = [];
            document.querySelectorAll('#attendeesList > div').forEach(row => {
                const inputs = row.querySelectorAll('input');
                attendees.push({
                    name: inputs[0].value,
                    position: inputs[1].value
                });
            });

            // Collect expense items
            const expenseItems = [];
            if (document.querySelector('input[name="expenseOption"]:checked').value === 'partial') {
                document.querySelectorAll('input[name="expenseItem"]:checked').forEach(item => {
                    let detail = '';
                    if (item.value === 'ค่าใช้จ่ายอื่นๆ') {
                        detail = document.getElementById('expense_other_text').value;
                    }
                    expenseItems.push({ name: item.value, detail: detail });
                });
            }
            
            const payload = {
                id: document.getElementById('editRequestId').value || null, // For updates
                username: currentUser.username,
                requesterName: document.getElementById('requesterName').value,
                requesterPosition: document.getElementById('requesterPosition').value,
                department: document.getElementById('requesterDepartment').value,
                docDate: document.getElementById('docDate').value,
                headName: document.getElementById('headName').value,
                purpose: document.getElementById('purpose').value,
                location: document.getElementById('location').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                vehicleOption: document.querySelector('input[name="vehicleOption"]:checked').value,
                licensePlate: document.getElementById('licensePlate').value,
                expenseOption: document.querySelector('input[name="expenseOption"]:checked').value,
                expenseItems: expenseItems,
                totalExpense: document.getElementById('totalExpense').value,
                attendees: attendees
            };

            // Validation
            if (!payload.docDate || !payload.headName || !payload.purpose || !payload.location || !payload.startDate || !payload.endDate) {
                formError.textContent = 'กรุณากรอกข้อมูลที่จำเป็น (*) ให้ครบถ้วน';
                formError.classList.remove('hidden');
                return;
            }

            try {
                const result = await gasApiCall('createRequest', payload);
                if (result.status === 'success') {
                    alert('บันทึกคำขอสำเร็จ!');
                    // Open the PDF in a new tab
                    if (result.data && result.data.pdfUrl) {
                        window.open(result.data.pdfUrl, '_blank');
                    }
                    resetRequestForm();
                    showMainPageContent('myRequestsPage');
                }
            } catch (error) {
                formError.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                formError.classList.remove('hidden');
            }
        }
        
        // --- MY REQUESTS PAGE ---
        async function loadMyRequests() {
            try {
                const [requests, memos] = await Promise.all([
                    gasApiGet('getUserRequests', { username: currentUser.username }),
                    gasApiGet('getSentMemos', { username: currentUser.username })
                ]);
                myRequestsCache = requests;
                myMemosCache = memos;
                renderMyRequestsList(myRequestsCache, myMemosCache, document.getElementById('myRequestsSearch').value);
            } catch (error) {
                console.error('Error loading my requests:', error);
            }
        }
        
        function renderMyRequestsList(requests, memos, searchTerm = '') {
            const container = document.getElementById('myRequestsContainer');
            const noDataMsg = document.getElementById('noMyMemosMsg');
            container.innerHTML = '';
            
            let filteredRequests = requests;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                filteredRequests = requests.filter(req =>
                    req.purpose?.toLowerCase().includes(lowerCaseSearch) ||
                    req.location?.toLowerCase().includes(lowerCaseSearch) ||
                    req.requestId?.toLowerCase().includes(lowerCaseSearch) // <-- FIXED: req.id to req.requestId
                );
            }
            
            if (filteredRequests.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');
            
            const table = createTableHtml([
                'ID คำขอ', 'เรื่อง', 'วันที่ไป', 'สถานะบันทึก', 'สถานะคำสั่ง', 'การดำเนินการ'
            ]);
            const tbody = table.querySelector('tbody');

            filteredRequests.sort((a, b) => new Date(b.docDate) - new Date(a.docDate));
            
            filteredRequests.forEach(req => {
                const hasMemo = memos.some(m => m.refNumber === req.requestId);
                const memoStatus = hasMemo ? 'ส่งแล้ว' : 'ยังไม่ส่ง';
                const commandStatus = req.commandStatus || 'N/A';
                
                // --- FIXED: req.id to req.requestId ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${req.requestId}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${req.purpose}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatDate(req.startDate)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm ${hasMemo ? 'text-green-600' : 'text-yellow-600'}">${memoStatus}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${commandStatus}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-2">
                            <button class="btn btn-outline btn-sm" onclick="viewRequestDetails('${req.requestId}')">ดูรายละเอียด</button>
                            <button class="btn btn-secondary btn-sm" onclick="editRequest('${req.requestId}')">แก้ไข</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }
        
        function editRequest(requestId) {
            // --- FIXED: r.id to r.requestId ---
            const req = myRequestsCache.find(r => r.requestId === requestId);
            if (!req) return;
            
            resetRequestForm();
            
            document.getElementById('formTitle').textContent = 'แก้ไขบันทึกข้อความ';
            document.getElementById('editRequestId').value = req.requestId;
            
            document.getElementById('requesterName').value = req.requesterName;
            document.getElementById('requesterPosition').value = req.requesterPosition;
            document.getElementById('requesterDepartment').value = req.department;
            document.getElementById('docDate').value = formatDate(req.docDate, true);
            document.getElementById('headName').value = req.headName;
            document.getElementById('purpose').value = req.purpose;
            document.getElementById('location').value = req.location;
            document.getElementById('startDate').value = formatDateTime(req.startDate);
            document.getElementById('endDate').value = formatDateTime(req.endDate);
            
            document.querySelector(`input[name="vehicleOption"][value="${req.vehicleOption}"]`).checked = true;
            const plateInput = document.getElementById('licensePlate');
            if (req.vehicleOption === 'gov' || req.vehicleOption === 'private') {
                plateInput.value = req.licensePlate;
                plateInput.style.display = 'block';
            } else {
                plateInput.style.display = 'none';
            }
            
            document.querySelector(`input[name="expenseOption"][value="${req.expenseOption}"]`).checked = true;
            const expenseDetails = document.getElementById('expenseDetails');
            if (req.expenseOption === 'no') {
                expenseDetails.style.display = 'none';
            } else {
                expenseDetails.style.display = 'block';
                document.getElementById('totalExpense').value = req.totalExpense;
                
                // Clear all checkboxes first
                document.querySelectorAll('input[name="expenseItem"]').forEach(chk => chk.checked = false);
                document.getElementById('expense_other_text').value = '';

                try {
                    const items = JSON.parse(req.expenseItems);
                    items.forEach(item => {
                        if (item.name === 'ค่าเบี้ยเลี้ยง') document.getElementById('expense_allowance').checked = true;
                        else if (item.name === 'ค่าที่พัก') document.getElementById('expense_accommodation').checked = true;
                        else if (item.name === 'ค่าพาหนะ') document.getElementById('expense_transport').checked = true;
                        else if (item.name === 'ค่าอาหาร') document.getElementById('expense_food').checked = true;
                        else if (item.name === 'ค่าน้ำมัน') document.getElementById('expense_fuel').checked = true;
                        else if (item.name === 'ค่าใช้จ่ายอื่นๆ') {
                            document.getElementById('expense_other').checked = true;
                            document.getElementById('expense_other_text').value = item.detail || '';
                        }
                    });
                } catch (e) { console.error('Error parsing expenseItems:', e)}
            }
            
            // Load attendees
            gasApiGet('getAttendeesForRequest', { requestId: req.requestId }).then(attendees => {
                document.getElementById('attendeesList').innerHTML = '';
                attendees.forEach(att => addAttendeeRow(att.name, att.position));
            });

            showMainPageContent('createRequestPage');
        }

        // --- MEMO PAGE ---
        async function loadMemoData() {
            // Load requests that don't have a memo yet for the dropdown
            try {
                // We need all user requests, even completed ones
                const allMyRequests = await gasApiGet('getUserRequests', { username: currentUser.username });
                const myMemos = await gasApiGet('getSentMemos', { username: currentUser.username });
                
                myMemosCache = myMemos;
                renderMyMemosList(myMemos);
                
                const memoRequestIds = myMemos.map(m => m.refNumber);
                // Filter requests that haven't had a memo submitted
                // --- FIXED: r.id to r.requestId ---
                const pendingRequests = allMyRequests.filter(r => !memoRequestIds.includes(r.requestId)); 

                const select = document.getElementById('memoRefNumber');
                select.innerHTML = '<option value="">-- กรุณาเลือกคำขอ --</option>';
                pendingRequests.forEach(req => {
                    // --- FIXED: req.id to req.requestId ---
                    const option = new Option(`${req.requestId} - ${req.purpose}`, req.requestId);
                    select.add(option);
                });
                
            } catch (error) {
                console.error('Error loading memo data:', error);
            }
        }
        
        function toggleMemoUploadSection(e) {
            const uploadSection = document.getElementById('memoFileUploadSection');
            if (e.target.value === 'file') {
                uploadSection.style.display = 'block';
            } else {
                uploadSection.style.display = 'none';
            }
        }
        
        async function handleSubmitMemo(e) {
            e.preventDefault();
            const memoError = document.getElementById('memoError');
            memoError.classList.add('hidden');
            
            const refNumber = document.getElementById('memoRefNumber').value;
            const memoType = document.querySelector('input[name="memoType"]:checked').value;
            const fileInput = document.getElementById('memoFile');
            
            if (!refNumber) {
                memoError.textContent = 'กรุณาเลือกคำขอที่ต้องการส่งสรุป';
                memoError.classList.remove('hidden');
                return;
            }

            const payload = {
                refNumber: refNumber,
                username: currentUser.username,
                memoType: memoType,
                file: null
            };

            if (memoType === 'file') {
                if (fileInput.files.length === 0) {
                    memoError.textContent = 'กรุณาแนบไฟล์สรุป';
                    memoError.classList.remove('hidden');
                    return;
                }
                
                try {
                    const file = fileInput.files[0];
                    const base64 = await fileToBase64(file);
                    payload.file = {
                        filename: file.name,
                        mimeType: file.type,
                        data: base64
                    };
                } catch (err) {
                    memoError.textContent = `เกิดข้อผิดพลาดในการอ่านไฟล์: ${err.message}`;
                    memoError.classList.remove('hidden');
                    return;
                }
            }
            
            try {
                const result = await gasApiCall('uploadMemo', payload);
                if (result.status === 'success') {
                    alert('ส่งบันทึกสรุปสำเร็จ!');
                    document.getElementById('memoForm').reset();
                    document.getElementById('memoFileName').textContent = 'ยังไม่ได้เลือกไฟล์';
                    loadMemoData(); // Refresh list and dropdown
                }
            } catch (error) {
                memoError.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                memoError.classList.remove('hidden');
            }
        }
        
        function renderMyMemosList(memos, searchTerm = '') {
            const container = document.getElementById('myMemosContainer');
            const noDataMsg = document.getElementById('noMyMemosMsg');
            container.innerHTML = '';
            
            let filteredMemos = memos;
            
            if (filteredMemos.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');
            
            const table = createTableHtml([
                'ID บันทึก', 'ID คำขอ', 'วันที่ส่ง', 'สถานะ', 'ไฟล์แนบ', 'การดำเนินการ'
            ]);
            const tbody = table.querySelector('tbody');

            filteredMemos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            filteredMemos.forEach(m => {
                const fileLink = m.fileUrl ? `<a href="${m.fileUrl}" target="_blank" class="text-blue-600 hover:underline">เปิดไฟล์</a>` : 'ไม่มี';
                // --- FIXED: m.id to m.memoId ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${m.memoId}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${m.refNumber}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatDate(m.timestamp)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${m.status === 'อนุมัติ' ? 'text-green-600' : 'text-yellow-600'}">${m.status}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${fileLink}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button class="btn btn-outline btn-sm" onclick="viewMemoDetails('${m.memoId}')">ดูรายละเอียด</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- ADMIN: ALL REQUESTS ---
        async function loadAllRequests() {
            try {
                const [requests, memos] = await Promise.all([
                    gasApiGet('getAllRequests'),
                    gasApiGet('getAllMemos')
                ]);
                allRequestsCache = requests;
                allMemosCache = memos;
                renderRequestsList(allRequestsCache, allMemosCache, document.getElementById('adminRequestsSearch').value);
            } catch (error) {
                console.error('Error loading all requests:', error);
            }
        }
        
        function renderRequestsList(requests, memos, searchTerm = '') {
            const container = document.getElementById('adminRequestsContainer');
            const noDataMsg = document.getElementById('noAdminRequestsMsg');
            container.innerHTML = '';
            
            let filteredRequests = requests;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                filteredRequests = requests.filter(req =>
                    req.purpose?.toLowerCase().includes(lowerCaseSearch) ||
                    req.location?.toLowerCase().includes(lowerCaseSearch) ||
                    req.requesterName?.toLowerCase().includes(lowerCaseSearch) ||
                    req.requestId?.toLowerCase().includes(lowerCaseSearch) // <-- FIXED: req.id to req.requestId
                );
            }
            
            if (filteredRequests.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');
            
            const table = createTableHtml([
                'ID คำขอ', 'ผู้ขอ', 'เรื่อง', 'วันที่ไป', 'สถานะบันทึก', 'สถานะคำสั่ง', 'การดำเนินการ'
            ]);
            const tbody = table.querySelector('tbody');

            filteredRequests.sort((a, b) => new Date(b.docDate) - new Date(a.docDate));
            
            filteredRequests.forEach(req => {
                // --- FIXED: req.id to req.requestId ---
                const hasMemo = memos.some(m => m.refNumber === req.requestId);
                const memoStatus = hasMemo ? 'ส่งแล้ว' : 'ยังไม่ส่ง';
                const commandStatus = req.commandStatus || 'N/A';
                
                const row = `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${req.requestId}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${req.requesterName}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${req.purpose}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatDate(req.startDate)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm ${hasMemo ? 'text-green-600' : 'text-yellow-600'}">${memoStatus}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold ${commandStatus.includes('เสร็จสิ้น') ? 'text-green-600' : 'text-yellow-700'}">${commandStatus}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-y-1 md:space-y-0 md:space-x-1">
                            <button class="btn btn-outline btn-sm w-full md:w-auto" onclick="viewRequestDetails('${req.requestId}')">ดูไฟล์</button>
                            <button class="btn btn-primary btn-sm w-full md:w-auto" onclick="openApproveCommandModal(${JSON.stringify(req)})">อนุมัติคำสั่ง</button>
                            <button class="btn btn-success btn-sm w-full md:w-auto" onclick="openGenerateDispatchModal(${JSON.stringify(req)})">ส่งเขต</button>
                            <button class="btn btn-secondary btn-sm w-full md:w-auto" onclick="openUpdateStatusCommandModal(${JSON.stringify(req)})">แก้สถานะ</button>
                            <button class="btn btn-danger btn-sm w-full md:w-auto" onclick="openDeleteModal(${JSON.stringify(req)}, 'request')">ลบ</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- ADMIN: ALL MEMOS ---
        async function loadAllMemos() {
            try {
                const memos = await gasApiGet('getAllMemos');
                allMemosCache = memos;
                renderMemosList(allMemosCache, document.getElementById('adminMemosSearch').value);
            } catch (error) {
                console.error('Error loading all memos:', error);
            }
        }
        
        function renderMemosList(memos, searchTerm = '') {
            const container = document.getElementById('adminMemosContainer');
            const noDataMsg = document.getElementById('noAdminMemosMsg');
            container.innerHTML = '';
            
            let filteredMemos = memos;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                filteredMemos = memos.filter(m =>
                    m.memoId?.toLowerCase().includes(lowerCaseSearch) || // <-- FIXED: m.id to m.memoId
                    m.refNumber?.toLowerCase().includes(lowerCaseSearch) ||
                    m.username?.toLowerCase().includes(lowerCaseSearch)
                );
            }
            
            if (filteredMemos.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');
            
            const table = createTableHtml([
                'ID บันทึก', 'ผู้ส่ง', 'ID คำขอ', 'วันที่ส่ง', 'สถานะ', 'ไฟล์แนบ', 'การดำเนินการ'
            ]);
            const tbody = table.querySelector('tbody');

            filteredMemos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            filteredMemos.forEach(m => {
                const fileLink = m.fileUrl ? `<a href="${m.fileUrl}" target="_blank" class="text-blue-600 hover:underline">เปิดไฟล์</a>` : 'ไม่มี';
                // --- FIXED: m.id to m.memoId ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${m.memoId}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${m.username}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${m.refNumber}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatDate(m.timestamp)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${m.status === 'อนุมัติ' ? 'text-green-600' : 'text-yellow-600'}">${m.status}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${fileLink}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-2">
                            <button class="btn btn-outline btn-sm" onclick="viewMemoDetails('${m.memoId}')">ดูรายละเอียด</button>
                            <button class="btn btn-primary btn-sm" onclick="openUpdateMemoStatusModal(${JSON.stringify(m)})">จัดการ</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- ADMIN: USER MANAGEMENT ---
        async function loadAllUsers() {
            try {
                const users = await gasApiGet('getAllUsers');
                allUsersCache = users;
                renderUsersList(allUsersCache);
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }
        
        function renderUsersList(users) {
            const container = document.getElementById('adminUsersContainer');
            container.innerHTML = '';
            
            const table = createTableHtml([
                'Username', 'Full Name', 'Position', 'Department', 'Role', 'Actions'
            ]);
            const tbody = table.querySelector('tbody');
            
            users.forEach(user => {
                const row = `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${user.username}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${user.fullName}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${user.position}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${user.department}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${user.role}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button class="btn btn-danger btn-sm" onclick="handleDeleteUser('${user.username}')">ลบ</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }
        
        async function handleAddUser(e) {
            e.preventDefault();
            const addUserError = document.getElementById('addUserError');
            const payload = {
                username: document.getElementById('adminRegUsername').value,
                password: document.getElementById('adminRegPassword').value,
                fullName: document.getElementById('adminRegFullName').value,
                position: document.getElementById('adminRegPosition').value,
                department: document.getElementById('adminRegDepartment').value,
                role: document.getElementById('adminRegRole').value,
            };
            
            try {
                const result = await gasApiCall('addUser', payload);
                if (result.status === 'success') {
                    alert('เพิ่มผู้ใช้สำเร็จ');
                    addUserError.classList.add('hidden');
                    document.getElementById('addUserForm').reset();
                    closeModal('addUserModal');
                    loadAllUsers(); // Refresh user list
                } else {
                    addUserError.textContent = result.message;
                    addUserError.classList.remove('hidden');
                }
            } catch (error) {
                addUserError.textContent = error.message;
                addUserError.classList.remove('hidden');
            }
        }
        
        async function handleDeleteUser(username) {
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ ${username}? การกระทำนี้ไม่สามารถย้อนกลับได้`)) {
                return;
            }
            try {
                const result = await gasApiCall('deleteUser', { username: username });
                if (result.status === 'success') {
                    alert('ลบผู้ใช้สำเร็จ');
                    loadAllUsers(); // Refresh user list
                }
            } catch (error) {
                alert(`ลบผู้ใช้ล้มเหลว: ${error.message}`);
            }
        }
        
        function handleImportUsers(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const users = XLSX.utils.sheet_to_json(firstSheet);
                
                if (users.length === 0) {
                    alert('ไม่พบข้อมูลในไฟล์ XLSX');
                    return;
                }
                
                try {
                    const result = await gasApiCall('importUsers', { users: users });
                    alert(result.message);
                    loadAllUsers(); // Refresh list
                } catch (error) {
                    alert(`นำเข้าล้มเหลว: ${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- MODAL ACTIONS ---
        function viewRequestDetails(requestId) {
            // --- FIXED: r.id to r.requestId ---
            const req = allRequestsCache.find(r => r.requestId === requestId) || myRequestsCache.find(r => r.requestId === requestId);
            if (!req) return;
            
            // --- FIXED: req.id to req.requestId ---
            document.getElementById('detailId').textContent = req.requestId;
            document.getElementById('detailDocDate').textContent = formatDate(req.docDate);
            document.getElementById('detailRequesterName').textContent = req.requesterName;
            document.getElementById('detailPosition').textContent = req.requesterPosition;
            document.getElementById('detailPurpose').textContent = req.purpose;
            document.getElementById('detailLocation').textContent = req.location;
            document.getElementById('detailStartDate').textContent = formatDateTime(req.startDate);
            document.getElementById('detailEndDate').textContent = formatDateTime(req.endDate);
            
            const vehicleMap = { 'gov': 'รถยนต์ราชการ', 'private': 'รถยนต์ส่วนตัว', 'public': 'รถโดยสารสาธารณะ' };
            document.getElementById('detailVehicle').textContent = vehicleMap[req.vehicleOption] || 'N/A';
            document.getElementById('detailLicense').textContent = req.licensePlate || '-';
            
            document.getElementById('detailExpense').textContent = req.expenseOption === 'no' ? 'ไม่เบิก' : 'เบิก';
            document.getElementById('detailTotalExpense').textContent = req.totalExpense;
            
            let itemsText = 'ไม่มี';
            if (req.expenseOption !== 'no') {
                try {
                    const items = JSON.parse(req.expenseItems);
                    itemsText = items.map(item => item.name + (item.detail ? ` (${item.detail})` : '')).join(', ') || 'ไม่มี';
                } catch (e) { itemsText = 'ข้อมูลไม่ถูกต้อง'; }
            }
            document.getElementById('detailExpenseItems').textContent = itemsText;
            
            // Fetch and display attendees
            const attendeesContainer = document.getElementById('detailAttendees');
            attendeesContainer.innerHTML = 'กำลังโหลด...';
            gasApiGet('getAttendeesForRequest', { requestId: req.requestId }).then(attendees => {
                if (attendees.length === 0) {
                    attendeesContainer.innerHTML = 'ไม่มีผู้ติดตาม';
                } else {
                    attendeesContainer.innerHTML = attendees.map((att, i) => `<div>${i+1}. ${att.name} (${att.position})</div>`).join('');
                }
            });
            
            // PDF Links
            document.getElementById('detailPdfLink').href = req.pdfUrl || '#';
            document.getElementById('detailCmdSoloLink').href = req.commandPdfUrlSolo || '#';
            document.getElementById('detailCmdSmallLink').href = req.commandPdfUrlGroupSmall || '#';
            document.getElementById('detailCmdLargeLink').href = req.commandPdfUrlGroupLarge || '#';
            
            const finalCmdLink = document.getElementById('detailCmdFinalLink');
            if (req.commandPdfUrl) {
                finalCmdLink.href = req.commandPdfUrl;
                finalCmdLink.classList.remove('hidden');
            } else {
                finalCmdLink.classList.add('hidden');
            }
            
            const dispatchLink = document.getElementById('detailDispatchLink');
            if (req.dispatchBookPdfUrl) {
                dispatchLink.href = req.dispatchBookPdfUrl;
                dispatchLink.classList.remove('hidden');
            } else {
                dispatchLink.classList.add('hidden');
            }
            
            openModal('requestDetailsModal');
        }
        
        function viewMemoDetails(memoId) {
            // --- FIXED: m.id to m.memoId ---
            const memo = allMemosCache.find(m => m.memoId === memoId) || myMemosCache.find(m => m.memoId === memoId);
            if (!memo) return;
            
            // --- FIXED: memo.id to memo.memoId ---
            document.getElementById('memoDetailId').textContent = memo.memoId;
            document.getElementById('memoDetailRefNumber').textContent = memo.refNumber;
            document.getElementById('memoDetailUsername').textContent = memo.username;
            document.getElementById('memoDetailTimestamp').textContent = formatDateTime(memo.timestamp);
            document.getElementById('memoDetailStatus').textContent = memo.status;
            
            const fileLink = document.getElementById('memoDetailFileUrl');
            if (memo.fileUrl) {
                fileLink.href = memo.fileUrl;
                fileLink.style.display = 'inline';
            } else {
                fileLink.style.display = 'none';
                fileLink.textContent = 'ไม่มีไฟล์แนบ';
            }
            
            document.getElementById('memoDetailApprovedBy').textContent = memo.approvedBy || '-';
            document.getElementById('memoDetailApprovalDate').textContent = memo.approvalDate ? formatDateTime(memo.approvalDate) : '-';
            document.getElementById('memoDetailRemarks').textContent = memo.remarks || '-';
            
            openModal('memoDetailsModal');
        }
        
        async function deleteRequest(requestId) {
            try {
                const result = await gasApiCall('deleteRequest', { id: requestId });
                if (result.status === 'success') {
                    alert('ลบคำขอสำเร็จ');
                    closeModal('deleteModal');
                    // Refresh all relevant lists
                    loadAllRequests();
                    loadMyRequests();
                }
            } catch (error) {
                alert(`ลบคำขอล้มเหลว: ${error.message}`);
            }
        }
        
        function openApproveCommandModal(request) {
            // --- FIXED: request.id to request.requestId ---
            document.getElementById('approveCommandRequestId').value = request.requestId;
            document.getElementById('approveCommandIdLabel').textContent = request.requestId;
            openModal('approveCommandModal');
        }
        
        async function handleApproveCommand(e) {
            e.preventDefault();
            const payload = {
                // --- FIXED: .value to .value (from request.id) ---
                requestId: document.getElementById('approveCommandRequestId').value,
                templateType: document.getElementById('commandTemplateType').value
            };
            
            if (!payload.templateType) {
                alert('กรุณาเลือกรูปแบบคำสั่ง');
                return;
            }
            
            try {
                const result = await gasApiCall('approveCommand', payload);
                if (result.status === 'success') {
                    alert(result.message);
                    closeModal('approveCommandModal');
                    loadAllRequests(); // Refresh list
                }
            } catch (error) {
                alert(`อนุมัติล้มเหลว: ${error.message}`);
            }
        }
        
        function openGenerateDispatchModal(request) {
            // --- FIXED: request.id to request.requestId ---
            document.getElementById('dispatchRequestId').value = request.requestId;
            document.getElementById('dispatchIdLabel').textContent = request.requestId;
            
            // Set default year
            const currentBuddhistYear = new Date().getFullYear() + 543;
            document.getElementById('dispatchYear').value = currentBuddhistYear;
            
            // Set default month
            const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
            const currentMonth = new Date().getMonth();
            document.getElementById('dispatchMonth').value = thaiMonths[currentMonth];
            
            openModal('generateDispatchModal');
        }
        
        async function handleGenerateDispatch(e) {
            e.preventDefault();
            const payload = {
                // --- FIXED: .value to .value (from request.id) ---
                requestId: document.getElementById('dispatchRequestId').value,
                dispatchMonth: document.getElementById('dispatchMonth').value,
                dispatchYear: document.getElementById('dispatchYear').value,
                commandCount: document.getElementById('dispatchCommandCount').value,
                memoCount: document.getElementById('dispatchMemoCount').value
            };
            
            try {
                const result = await gasApiCall('generateDispatchBook', payload);
                if (result.status === 'success') {
                    alert(result.message);
                    if (result.url) {
                        window.open(result.url, '_blank');
                    }
                    closeModal('generateDispatchModal');
                    loadAllRequests(); // Refresh list
                }
            } catch (error) {
                alert(`สร้างหนังสือส่งล้มเหลว: ${error.message}`);
            }
        }
        
        function openUpdateStatusCommandModal(request) {
            // --- FIXED: request.id to request.requestId ---
            document.getElementById('updateCommandRequestId').value = request.requestId;
            document.getElementById('updateCommandIdLabel').textContent = request.requestId;
            document.getElementById('newCommandStatus').value = request.commandStatus || '';
            openModal('updateStatusCommandModal');
        }
        
        async function handleUpdateStatusCommand(e) {
            e.preventDefault();
            const payload = {
                // --- FIXED: .value to .value (from request.id) ---
                requestId: document.getElementById('updateCommandRequestId').value,
                status: document.getElementById('newCommandStatus').value
            };
            
            try {
                const result = await gasApiCall('updateRequestStatusCommand', payload);
                if (result.status === 'success') {
                    alert(result.message);
                    closeModal('updateStatusCommandModal');
                    loadAllRequests(); // Refresh list
                }
            } catch (error) {
                alert(`อัปเดตสถานะล้มเหลว: ${error.message}`);
            }
        }
        
        function openUpdateMemoStatusModal(memo) {
            // --- FIXED: memo.id to memo.memoId ---
            document.getElementById('updateMemoId').value = memo.memoId;
            document.getElementById('updateMemoIdLabel').textContent = memo.memoId;
            document.getElementById('newMemoStatus').value = memo.status;
            document.getElementById('memoRemarks').value = memo.remarks || '';
            openModal('updateMemoStatusModal');
        }
        
        async function handleUpdateMemoStatus(e) {
            e.preventDefault();
            const payload = {
                // --- FIXED: .value to .value (from memo.id) ---
                memoId: document.getElementById('updateMemoId').value,
                newStatus: document.getElementById('newMemoStatus').value,
                remarks: document.getElementById('memoRemarks').value,
                adminUsername: currentUser.username
            };
            
            try {
                const result = await gasApiCall('updateMemoStatus', payload);
                if (result.status === 'success') {
                    alert(result.message);
                    closeModal('updateMemoStatusModal');
                    loadAllMemos(); // Refresh memo list
                    loadAllRequests(); // Status might have changed in requests
                }
            } catch (error) {
                alert(`อัปเดตสถานะ Memo ล้มเหลว: ${error.message}`);
            }
        }

        // --- UTILITY FUNCTIONS ---
        function createTableHtml(headers) {
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 shadow-sm border border-gray-200';
            let thead = '<tr>';
            headers.forEach(h => {
                thead += `<th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">${h}</th>`;
            });
            thead += '</tr>';
            table.innerHTML = `<thead class="bg-gray-50">${thead}</thead><tbody class="bg-white divide-y divide-gray-200"></tbody>`;
            return table;
        }

        function formatDate(dateString, forInput = false) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (forInput) {
                    // YYYY-MM-DD
                    return date.toISOString().split('T')[0];
                }
                // DD/MM/YYYY
                return date.toLocaleDateString('th-TH', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function formatDateTime(dateString) {
             if (!dateString) return '';
            try {
                const date = new Date(dateString);
                // For datetime-local input (YYYY-MM-DDTHH:mm)
                const YYYY = date.getFullYear();
                const MM = String(date.getMonth() + 1).padStart(2, '0');
                const DD = String(date.getDate()).padStart(2, '0');
                const HH = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                
                // ตรวจสอบว่าเวลาเป็น 00:00 หรือไม่ (อาจเกิดจาก timezone)
                if (HH === '00' && mm === '00' && date.getTimezoneOffset() !== 0) {
                    // ถ้าใช่ ให้ลองปรับ timezone offset
                    const adjustedDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
                     const adj_HH = String(adjustedDate.getHours()).padStart(2, '0');
                     const adj_mm = String(adjustedDate.getMinutes()).padStart(2, '0');
                     return `${YYYY}-${MM}-${DD}T${adj_HH}:${adj_mm}`;
                }
                
                return `${YYYY}-${MM}-${DD}T${HH}:${mm}`;
            } catch (e) {
                return '';
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        // --- REPORTS ---
        function showReportByExpenseType(expenseType) {
            const modal = document.getElementById('reportModal');
            const title = document.getElementById('reportTitle');
            const content = document.getElementById('reportContent');
            
            title.textContent = `รายงานคำขอ (ประเภท: ${expenseType === 'no' ? 'ไม่เบิก' : 'เบิก'})`;
            
            let filteredRequests = [];
            if (expenseType === 'all') {
                filteredRequests = allRequestsCache;
            } else {
                filteredRequests = allRequestsCache.filter(r => r.expenseOption === expenseType);
            }

            // build table
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Purpose</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            filteredRequests.forEach(req => {
                const row = tbody.insertRow();
                // --- FIXED: req.id to req.requestId ---
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${req.requestId}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${req.purpose}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${new Date(req.docDate).toLocaleString('th-TH')}</td>
                `;
            });

            content.innerHTML = '';
            content.appendChild(table);
            modal.style.display = 'flex';
        }

    </script>

</body>
</html>
