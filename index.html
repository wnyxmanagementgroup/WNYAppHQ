<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.3s; }
        .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 700; text-align: center; transition: all 0.3s; cursor: pointer; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #22c55e; color: white; }
        .btn-success:hover { background-color: #16a34a; }
        .btn-outline { background-color: transparent; color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-outline:hover { background-color: #eff6ff; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #6b7280; }
        .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; margin: auto; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* สไตล์สำหรับปุ่มอัปโหลด */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-upload-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload-btn {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .file-name {
            margin-left: 1rem;
            font-style: italic;
            color: #4b5563;
        }

        /* สไตล์สำหรับ Spinner */
        .spinner {
            display: none; /* ซ่อนไว้ก่อน */
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: fixed; /* ให้อยู่กลางจอ */
            top: 50%;
            left: 50%;
            z-index: 1000;
            margin-top: -25px; /* ครึ่งนึงของ height */
            margin-left: -25px; /* ครึ่งนึงของ width */
        }
        .overlay {
            display: none; /* ซ่อนไว้ก่อน */
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.3); /* พื้นหลังมัวๆ */
            z-index: 999;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loadingOverlay" class="overlay"></div>
    <div id="loadingSpinner" class="spinner"></div>

    <div id="app" class="max-w-7xl mx-auto">

        <div id="loginPage" class="page active max-w-md mx-auto mt-16 main-container p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">WNY App ไปราชการ</h2>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
                    <input type="text" id="username" name="username" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="password" name="password" class="form-input mt-1" required>
                </div>
                <div id="loginError" class="text-red-600 text-sm hidden">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง</div>
                <button type="submit" class="btn btn-primary w-full">เข้าสู่ระบบ</button>
            </form>
            <div class="text-center mt-4">
                <a href="#" id="showRegister" class="text-sm text-blue-600 hover:underline">ยังไม่มีบัญชี? ลงทะเบียนที่นี่</a>
            </div>
        </div>

        <div id="registerPage" class="page max-w-md mx-auto mt-16 main-container p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">ลงทะเบียน</h2>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (สำหรับ Login)</label>
                    <input type="text" id="regUsername" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="regPassword" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล (เต็ม)</label>
                    <input type="text" id="regFullName" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                    <input type="text" id="regPosition" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                    <input type="text" id="regDepartment" class="form-input mt-1" required>
                </div>
                <div id="registerError" class="text-red-600 text-sm hidden"></div>
                <div id="registerSuccess" class="text-green-600 text-sm hidden"></div>
                <button type="submit" class="btn btn-primary w-full">ลงทะเบียน</button>
            </form>
            <div class="text-center mt-4">
                <a href="#" id="showLogin" class="text-sm text-blue-600 hover:underline">มีบัญชีแล้ว? เข้าสู่ระบบที่นี่</a>
            </div>
        </div>

        <div id="mainPage" class="page main-container p-6 md:p-8 rounded-xl shadow-lg">
            <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ระบบบันทึกไปราชการ</h1>
                    <p id="welcomeUser" class="text-gray-600 mt-1"></p>
                </div>
                <nav class="flex items-center space-x-4 mt-4 md:mt-0">
                    <button id="profileBtn" class="btn btn-outline">โปรไฟล์</button>
                    <button id="logoutBtn" class="btn btn-secondary">ออกจากระบบ</button>
                </nav>
            </header>

            <div class="flex flex-wrap border-b border-gray-200 mb-6">
                <button class="main-tab tab active" data-page="homePage">หน้าหลัก</button>
                <button class="main-tab tab" data-page="createRequestPage">สร้างคำขอใหม่</button>
                <button class="main-tab tab" data-page="myRequestsPage">คำขอของฉัน</button>
                <button class="main-tab tab" data-page="memoPage">ส่งบันทึกสรุป</button>
                <button id="adminTab" class="main-tab tab hidden" data-page="adminPage">จัดการระบบ (Admin)</button>
            </div>

            <div id="mainContent">

                <div id="homePage" class="main-page-content active">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">แดชบอร์ดสรุป</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-blue-700">คำขอทั้งหมด (ของฉัน)</h3>
                            <p id="statMyTotalRequests" class="text-3xl font-bold text-blue-900 mt-2">0</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-green-700">เสร็จสิ้น (ของฉัน)</h3>
                            <p id="statMyCompletedRequests" class="text-3xl font-bold text-green-900 mt-2">0</p>
                        </div>
                        <div class="bg-yellow-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-yellow-700">กำลังดำเนินการ (ของฉัน)</h3>
                            <p id="statMyPendingRequests" class="text-3xl font-bold text-yellow-900 mt-2">0</p>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-lg shadow">
                            <h3 class="text-sm font-medium text-indigo-700">บันทึกที่ส่งแล้ว (ของฉัน)</h3>
                            <p id="statMyMemos" class="text-3xl font-bold text-indigo-900 mt-2">0</p>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">สถานะคำขอของฉัน</h3>
                        <div class="bg-white p-4 rounded-lg shadow" style="max-width: 400px; margin: auto;">
                            <canvas id="myRequestsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="createRequestPage" class="main-page-content">
                    <h2 id="formTitle" class="text-2xl font-bold text-gray-800 mb-6">สร้างบันทึกข้อความขอไปราชการ</h2>
                    <form id="requestForm" class="space-y-6">
                        <input type="hidden" id="editRequestId">

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ชื่อผู้ขอ</label>
                                <input type="text" id="requesterName" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                                <input type="text" id="requesterPosition" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                                <input type="text" id="requesterDepartment" class="form-input mt-1 bg-gray-100" readonly>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">วันที่ออกเอกสาร</label>
                                <input type="date" id="docDate" class="form-input mt-1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ชื่อหัวหน้ากลุ่มสาระฯ/งาน</label>
                                <input type="text" id="headName" class="form-input mt-1" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">เรื่อง (วัตถุประสงค์)</label>
                                <textarea id="purpose" class="form-input mt-1" rows="3" required></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">สถานที่</label>
                                <textarea id="location" class="form-input mt-1" rows="3" required></textarea>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">วันที่เริ่มไปราชการ</label>
                                <input type="datetime-local" id="startDate" class="form-input mt-1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                                <input type="datetime-local" id="endDate" class="form-input mt-1" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">การเดินทาง</label>
                            <div class="mt-2 space-y-2 md:space-y-0 md:flex md:space-x-6">
                                <div class="flex items-center">
                                    <input type="radio" id="vehicle_gov" name="vehicleOption" value="gov" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="vehicle_gov" class="ml-2 block text-sm text-gray-900">รถยนต์ราชการ (ระบุทะเบียน)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="vehicle_private" name="vehicleOption" value="private" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="vehicle_private" class="ml-2 block text-sm text-gray-900">รถยนต์ส่วนตัว (ระบุทะเบียน)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="vehicle_public" name="vehicleOption" value="public" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <label for="vehicle_public" class="ml-2 block text-sm text-gray-900">รถโดยสารสาธารณะ</label>
                                </div>
                            </div>
                            <input type="text" id="licensePlate" class="form-input mt-2 w-full md:w-1/3" placeholder="ระบุเลขทะเบียน..." style="display: none;">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">ค่าใช้จ่าย</label>
                            <div class="mt-2 space-y-2 md:space-y-0 md:flex md:space-x-6">
                                <div class="flex items-center">
                                    <input type="radio" id="expense_yes" name="expenseOption" value="partial" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <label for="expense_yes" class="ml-2 block text-sm text-gray-900">เบิกค่าใช้จ่าย (บางส่วน/ทั้งหมด)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="expense_no" name="expenseOption" value="no" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="expense_no" class="ml-2 block text-sm text-gray-900">ไม่เบิกค่าใช้จ่าย</label>
                                </div>
                            </div>
                        </div>

                        <div id="expenseDetails" class="space-y-4 p-4 border border-gray-200 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700">รายการค่าใช้จ่ายที่ขอเบิก</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_allowance" name="expenseItem" value="ค่าเบี้ยเลี้ยง" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_allowance" class="ml-2 block text-sm text-gray-900">ค่าเบี้ยเลี้ยง</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_accommodation" name="expenseItem" value="ค่าที่พัก" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_accommodation" class="ml-2 block text-sm text-gray-900">ค่าที่พัก</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_transport" name="expenseItem" value="ค่าพาหนะ" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_transport" class="ml-2 block text-sm text-gray-900">ค่าพาหนะ</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_food" name="expenseItem" value="ค่าอาหาร" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_food" class="ml-2 block text-sm text-gray-900">ค่าอาหาร</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="expense_fuel" name="expenseItem" value="ค่าน้ำมัน" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_fuel" class="ml-2 block text-sm text-gray-900">ค่าน้ำมัน</label>
                                </div>
                                <div class="flex items-center col-span-2 md:col-span-3">
                                    <input type="checkbox" id="expense_other" name="expenseItem" value="ค่าใช้จ่ายอื่นๆ" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="expense_other" class="ml-2 block text-sm text-gray-900">อื่นๆ (ระบุ):</label>
                                    <input type="text" id="expense_other_text" class="form-input ml-2 flex-1" placeholder="ระบุรายละเอียด...">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">รวมเป็นเงิน (บาท)</label>
                                <input type="number" id="totalExpense" class="form-input mt-1 md:w-1/3" min="0" step="0.01" value="0">
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-medium text-gray-900">ผู้ติดตาม (ถ้ามี)</h3>
                            <div id="attendeesList" class="space-y-3 mt-2">
                                </div>
                            <button type="button" id="addAttendee" class="btn btn-outline mt-4">+ เพิ่มผู้ติดตาม</button>
                        </div>

                        <div id="formError" class="text-red-600 text-sm hidden"></div>
                        <button type="submit" id="submitRequestBtn" class="btn btn-primary w-full md:w-auto">บันทึกและสร้าง PDF</button>
                    </form>
                </div>

                <div id="myRequestsPage" class="main-page-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">คำขอของฉัน</h2>
                    <div class="mb-4">
                        <input type="text" id="myRequestsSearch" class="form-input w-full md:w-1/2" placeholder="ค้นหาจากวัตถุประสงค์, สถานที่, หรือ ID...">
                    </div>
                    <div id="myRequestsContainer" class="table-responsive">
                        </div>
                    <div id="noMyRequestsMsg" class="text-gray-500 text-center py-8 hidden">
                        ไม่พบคำขอ
                    </div>
                </div>

                <div id="memoPage" class="main-page-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">ส่งบันทึกสรุปหลังไปราชการ</h2>
                    <form id="memoForm" class="space-y-6 max-w-lg mx-auto">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">เลือกคำขอ (ที่ยังไม่ได้ส่งสรุป)</label>
                            <select id="memoRefNumber" class="form-input mt-1" required>
                                <option value="">-- กรุณาเลือกคำขอ --</option>
                                </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">ประเภทการส่ง</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center">
                                    <input type="radio" id="memoTypeFile" name="memoType" value="file" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <label for="memoTypeFile" class="ml-2 block text-sm text-gray-900">แนบไฟล์สรุป (สำหรับ 'ไม่เบิก')</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="memoTypeReimburse" name="memoType" value="reimburse" class="h-4 w-4 text-blue-600 border-gray-300">
                                    <label for="memoTypeReimburse" class="ml-2 block text-sm text-gray-900">ส่งเพื่อเบิก (สำหรับ 'เบิก')</label>
                                </div>
                            </div>
                        </div>

                        <div id="memoFileUploadSection">
                            <label class="block text-sm font-medium text-gray-700">อัปโหลดไฟล์สรุป (PDF/JPG/PNG)</label>
                            <div class="mt-1 flex items-center">
                                <label class="file-upload-wrapper">
                                    <span class="file-upload-btn">เลือกไฟล์</span>
                                    <input type="file" id="memoFile" accept=".pdf,.jpg,.jpeg,.png">
                                </label>
                                <span id="memoFileName" class="file-name">ยังไม่ได้เลือกไฟล์</span>
                            </div>
                        </div>

                        <div id="memoError" class="text-red-600 text-sm hidden"></div>
                        <button type="submit" class="btn btn-primary w-full">ส่งบันทึกสรุป</button>
                    </form>

                    <hr class="my-12">

                    <h2 class="text-2xl font-bold text-gray-800 mb-6">บันทึกที่ฉันส่งแล้ว</h2>
                    <div id="myMemosContainer" class="table-responsive">
                        </div>
                    <div id="noMyMemosMsg" class="text-gray-500 text-center py-8 hidden">
                        ไม่พบข้อมูล
                    </div>
                </div>

                <div id="adminPage" class="main-page-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">จัดการระบบ (Admin)</h2>

                    <div class="flex flex-wrap border-b border-gray-200 mb-6">
                        <button class="admin-tab tab active" data-page="adminRequests">จัดการคำขอทั้งหมด</button>
                        <button class="admin-tab tab" data-page="adminMemos">จัดการบันทึกสรุป</button>
                        <button class="admin-tab tab" data-page="adminUsers">จัดการผู้ใช้</button>
                        <button class="admin-tab tab" data-page="adminDashboard">สรุปภาพรวม</button>
                    </div>

                    <div id="adminRequests" class="admin-page-content active">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">คำขอทั้งหมด</h3>
                        <div class="mb-4">
                            <input type="text" id="adminRequestsSearch" class="form-input w-full md:w-1/2" placeholder="ค้นหาจากผู้ขอ, วัตถุประสงค์, สถานที่, หรือ ID...">
                        </div>
                        <div id="adminRequestsContainer" class="table-responsive">
                            </div>
                        <div id="noAdminRequestsMsg" class="text-gray-500 text-center py-8 hidden">
                            ไม่พบคำขอ
                        </div>
                    </div>

                    <div id="adminMemos" class="admin-page-content hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">บันทึกสรุปทั้งหมด</h3>
                        <div class="mb-4">
                            <input type="text" id="adminMemosSearch" class="form-input w-full md:w-1/2" placeholder="ค้นหาจากผู้ส่ง, ID คำขอ, หรือ ID บันทึก...">
                        </div>
                        <div id="adminMemosContainer" class="table-responsive">
                            </div>
                        <div id="noAdminMemosMsg" class="text-gray-500 text-center py-8 hidden">
                            ไม่พบข้อมูล
                        </div>
                    </div>

                    <div id="adminUsers" class="admin-page-content hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">จัดการผู้ใช้</h3>
                        <div class="mb-4 flex space-x-2">
                            <button id="showAddUserModal" class="btn btn-primary">เพิ่มผู้ใช้ใหม่</button>
                            <label class="file-upload-wrapper">
                                <span class="file-upload-btn btn-outline">นำเข้าผู้ใช้ (XLSX)</span>
                                <input type="file" id="importUsersFile" accept=".xlsx">
                            </label>
                        </div>
                        <div id="adminUsersContainer" class="table-responsive">
                            </div>
                    </div>

                    <div id="adminDashboard" class="admin-page-content hidden">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">สรุปภาพรวมระบบ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-blue-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-blue-700">คำขอทั้งหมด (ในระบบ)</h3>
                                <p id="adminStatTotalRequests" class="text-3xl font-bold text-blue-900 mt-2">0</p>
                            </div>
                            <div class="bg-purple-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-purple-700">บันทึกสรุปทั้งหมด (ในระบบ)</h3>
                                <p id="adminStatTotalMemos" class="text-3xl font-bold text-purple-900 mt-2">0</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-green-700">ผู้ใช้ทั้งหมด</h3>
                                <p id="adminStatTotalUsers" class="text-3xl font-bold text-green-900 mt-2">0</p>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg shadow">
                                <h3 class="text-sm font-medium text-gray-700">...</h3>
                                <p class="text-3xl font-bold text-gray-900 mt-2">0</p>
                            </div>
                        </div>
                        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-gray-800 mb-3 text-center">คำขอตามกลุ่มสาระฯ</h4>
                                <canvas id="requestsByDeptChart"></canvas>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h4 class="text-lg font-bold text-gray-800 mb-3 text-center">คำขอรายเดือน</h4>
                                <canvas id="requestsByMonthChart"></canvas>
                            </div>
                        </div>

                        <div class="mt-8 bg-white p-4 rounded-lg shadow">
                            <h3 class="text-xl font-bold text-gray-700 mb-4">รายงาน</h3>
                            <div class="flex space-x-2">
                                <button class="btn btn-outline" onclick="showReportByExpenseType('no')">รายงาน (ไม่เบิก)</button>
                                <button class="btn btn-outline" onclick="showReportByExpenseType('partial')">รายงาน (เบิก)</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div> <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('profileModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">โปรไฟล์ของฉัน</h3>
            <form id="profileForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (Login)</label>
                    <input type="text" id="profileUsername" class="form-input mt-1 bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล</label>
                    <input type="text" id="profileFullName" class="form-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                    <input type="text" id="profilePosition" class="form-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                    <input type="text" id="profileDepartment" class="form-input mt-1">
                </div>
                <button type="submit" class="btn btn-primary w-full">บันทึกการเปลี่ยนแปลง</button>
            </form>
            <hr class="my-6">
            <h4 class="text-xl font-bold mb-4">เปลี่ยนรหัสผ่าน</h4>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่านปัจจุบัน</label>
                    <input type="password" id="oldPassword" class="form-input mt-1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่านใหม่</label>
                    <input type="password" id="newPassword" class="form-input mt-1">
                </div>
                <div id="passwordError" class="text-red-600 text-sm hidden"></div>
                <div id="passwordSuccess" class="text-green-600 text-sm hidden"></div>
                <button type="submit" class="btn btn-secondary w-full">เปลี่ยนรหัสผ่าน</button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('addUserModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">เพิ่มผู้ใช้ใหม่</h3>
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (สำหรับ Login)</label>
                    <input type="text" id="adminRegUsername" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="adminRegPassword" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล (เต็ม)</label>
                    <input type="text" id="adminRegFullName" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                    <input type="text" id="adminRegPosition" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">กลุ่มสาระฯ/งาน</label>
                    <input type="text" id="adminRegDepartment" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">บทบาท (role)</label>
                    <select id="adminRegRole" class="form-input mt-1">
                        <option value="user">user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div id="addUserError" class="text-red-600 text-sm hidden"></div>
                <button type="submit" class="btn btn-primary w-full">เพิ่มผู้ใช้</button>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-center">ยืนยันการลบ</h3>
            <p id="deleteConfirmText" class="text-gray-600 text-center mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="btn btn-danger">ยืนยันการลบ</button>
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">ยกเลิก</button>
            </div>
        </div>
    </div>


    <div id="requestDetailsModal" class="modal">
        <div class="modal-content max-w-3xl">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('requestDetailsModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">รายละเอียดคำขอ</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>ID:</strong> <span id="detailId"></span></div>
                    <div><strong>วันที่เอกสาร:</strong> <span id="detailDocDate"></span></div>
                </div>
                <div><strong>ผู้ขอ:</strong> <span id="detailRequesterName"></span></div>
                <div><strong>ตำแหน่ง:</strong> <span id="detailPosition"></span></div>
                <div><strong>วัตถุประสงค์:</strong> <span id="detailPurpose"></span></div>
                <div><strong>สถานที่:</strong> <span id="detailLocation"></span></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>วันที่เริ่ม:</strong> <span id="detailStartDate"></span></div>
                    <div><strong>วันที่สิ้นสุด:</strong> <span id="detailEndDate"></span></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>การเดินทาง:</strong> <span id="detailVehicle"></span></div>
                    <div><strong>ทะเบียน:</strong> <span id="detailLicense"></span></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>ค่าใช้จ่าย:</strong> <span id="detailExpense"></span></div>
                    <div><strong>รวม (บาท):</strong> <span id="detailTotalExpense"></span></div>
                </div>
                <div><strong>รายการที่เบิก:</strong> <span id="detailExpenseItems"></span></div>
                <div><strong>ผู้ติดตาม:</strong> <ul id="detailAttendees" class="mt-1 pl-4 list-disc list-inside"></ul></div>
                <hr class="my-4">
                <h4 class="text-lg font-bold">ไฟล์เอกสาร</h4>
                <div class="flex flex-wrap gap-4">
                    <a id="detailPdfLink" href="#" target="_blank" class="btn btn-primary">บันทึกข้อความ (PDF)</a>
                    <a id="detailCmdSoloLink" href="#" target="_blank" class="btn btn-outline">คำสั่ง (1 คน)</a>
                    <a id="detailCmdSmallLink" href="#" target="_blank" class="btn btn-outline">คำสั่ง (2-5 คน)</a>
                    <a id="detailCmdLargeLink" href="#" target="_blank" class="btn btn-outline">คำสั่ง (6+ คน)</a>
                    <a id="detailCmdFinalLink" href="#" target="_blank" class="btn btn-success hidden">คำสั่งที่อนุมัติ (PDF)</a>
                    <a id="detailDispatchLink" href="#" target="_blank" class="btn btn-success hidden">หนังสือส่งเขต (PDF)</a>
                </div>
            </div>
        </div>
    </div>

    <div id="memoDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('memoDetailsModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">รายละเอียดบันทึกสรุป</h3>
            <div class="space-y-3">
                <div><strong>ID บันทึก:</strong> <span id="memoDetailId"></span></div>
                <div><strong>ID คำขอ:</strong> <span id="memoDetailRefNumber"></span></div>
                <div><strong>ผู้ส่ง:</strong> <span id="memoDetailUsername"></span></div>
                <div><strong>วันที่ส่ง:</strong> <span id="memoDetailTimestamp"></span></div>
                <div><strong>สถานะ:</strong> <span id="memoDetailStatus" class="font-bold"></span></div>
                <div id="memoDetailFileLinkContainer"><strong>ไฟล์แนบ:</strong> <a id="memoDetailFileUrl" href="#" target="_blank" class="text-blue-600 hover:underline">เปิดไฟล์</a><span id="memoDetailNoFile" class="text-gray-500 ml-2 hidden">ไม่มีไฟล์แนบ</span></div>
                <hr>
                <div><strong>ผู้อนุมัติ:</strong> <span id="memoDetailApprovedBy"></span></div>
                <div><strong>วันที่อนุมัติ:</strong> <span id="memoDetailApprovalDate"></span></div>
                <div><strong>หมายเหตุ:</strong> <span id="memoDetailRemarks"></span></div>
            </div>
        </div>
    </div>

    <div id="approveCommandModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('approveCommandModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">อนุมัติและเลือกแบบคำสั่ง</h3>
            <form id="approveCommandForm" class="space-y-4">
                <input type="hidden" id="approveCommandRequestId">
                <p>เลือกรูปแบบคำสั่งที่ถูกต้องสำหรับ ID: <span id="approveCommandIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">เลือกรูปแบบ</label>
                    <select id="commandTemplateType" class="form-input mt-1" required>
                        <option value="">-- เลือก --</option>
                        <option value="solo">1 คน (Solo)</option>
                        <option value="groupSmall">2-5 คน (Group Small)</option>
                        <option value="groupLarge">6+ คน (Group Large)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-full">อนุมัติคำสั่ง</button>
            </form>
        </div>
    </div>

    <div id="generateDispatchModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('generateDispatchModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">สร้างหนังสือส่งเขต</h3>
            <form id="generateDispatchForm" class="space-y-4">
                <input type="hidden" id="dispatchRequestId">
                <p>สำหรับ ID: <span id="dispatchIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">เดือน (เช่น มกราคม)</label>
                    <input type="text" id="dispatchMonth" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ปี (พ.ศ.)</label>
                    <input type="number" id="dispatchYear" class="form-input mt-1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">จำนวนคำสั่ง (เรื่อง)</label>
                    <input type="number" id="dispatchCommandCount" class="form-input mt-1" value="0" min="0" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">จำนวนบันทึก (เรื่อง)</label>
                    <input type="number" id="dispatchMemoCount" class="form-input mt-1" value="0" min="0" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">สร้างหนังสือส่ง</button>
            </form>
        </div>
    </div>

    <div id="updateStatusCommandModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('updateStatusCommandModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">อัปเดตสถานะคำสั่ง</h3>
            <form id="updateStatusCommandForm" class="space-y-4">
                <input type="hidden" id="updateCommandRequestId">
                <p>สำหรับ ID: <span id="updateCommandIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">สถานะใหม่</label>
                    <input type="text" id="newCommandStatus" class="form-input mt-1" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">อัปเดตสถานะ</button>
            </form>
        </div>
    </div>

    <div id="updateMemoStatusModal" class="modal">
        <div class="modal-content">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('updateMemoStatusModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6">อนุมัติบันทึกสรุป</h3>
            <form id="updateMemoStatusForm" class="space-y-4">
                <input type="hidden" id="updateMemoId">
                <p>สำหรับ Memo ID: <span id="updateMemoIdLabel" class="font-bold"></span></p>
                <div>
                    <label class="block text-sm font-medium text-gray-700">สถานะ</label>
                    <select id="newMemoStatus" class="form-input mt-1" required>
                        <option value="อนุมัติ">อนุมัติ</option>
                        <option value="ตีกลับ">ตีกลับ</option>
                        <option value="กำลังดำเนินการ">กำลังดำเนินการ</option>
                    </select>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">หมายเหตุ (ถ้ามี)</label>
                    <textarea id="memoRemarks" class="form-input mt-1" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-full">บันทึก</button>
            </form>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content max-w-4xl">
            <span class="close-btn absolute top-4 right-6 text-2xl text-gray-500 cursor-pointer" onclick="closeModal('reportModal')">&times;</span>
            <h3 id="reportTitle" class="text-2xl font-bold mb-6">รายงาน</h3>
            <div id="reportContent" class="table-responsive">
                </div>
        </div>
    </div>


    <script>
        // --- CONFIG ---
        // !!! สำคัญ: ใส่ URL ที่ถูกต้องที่ได้จากการ Deploy ล่าสุด (Web app, Anyone) ที่นี่ !!!
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwAffzAbmctzVuPZ9JUv-O08AI2dbcKc46Z-RzZzBScxr9IRMYF171KvlVuuMLysnmyUg/exec';

        // --- STATE ---
        let currentUser = null;
        let allRequestsCache = [];
        let allMemosCache = [];
        let allUsersCache = [];
        let myRequestsCache = [];
        let myMemosCache = [];
        let myRequestsChartInstance = null;
        let requestsByDeptChartInstance = null;
        let requestsByMonthChartInstance = null;

        // --- SPINNER ---
        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('loadingOverlay').style.display = 'block';
        }
        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // --- APP INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = sessionStorage.getItem('wnyUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // --- เพิ่มการตรวจสอบ Property ที่จำเป็น (ใช้ PascalCase) ---
                    if (currentUser && currentUser.FullName && currentUser.Role && currentUser.Username) {
                        showPage('mainPage');
                        initializeApp();
                    } else {
                        console.error("User data from session storage is incomplete:", currentUser);
                        sessionStorage.removeItem('wnyUser');
                        showPage('loginPage');
                    }
                } catch (e) {
                     console.error("Error parsing user data from session storage:", e);
                     sessionStorage.removeItem('wnyUser');
                     showPage('loginPage');
                }
            } else {
                showPage('loginPage');
            }

            // --- EVENT LISTENERS ---
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('showRegister').addEventListener('click', (e) => { e.preventDefault(); showPage('registerPage'); });
            document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); showPage('loginPage'); });
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            document.getElementById('profileBtn').addEventListener('click', openProfileModal);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordUpdate);

            // Main Nav
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const pageId = e.target.dataset.page; // Use dataset
                    if (pageId) showMainPageContent(pageId);
                });
            });

            // Admin Nav
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const pageId = e.target.dataset.page; // Use dataset
                    if (pageId) showAdminPageContent(pageId);
                });
            });

            // Request Form
            document.getElementById('requestForm').addEventListener('submit', handleSubmitRequest);
            document.getElementById('addAttendee').addEventListener('click', addAttendeeRow);
            document.querySelectorAll('input[name="vehicleOption"]').forEach(radio => {
                radio.addEventListener('change', toggleLicensePlate);
            });
            document.querySelectorAll('input[name="expenseOption"]').forEach(radio => {
                radio.addEventListener('change', toggleExpenseDetails);
            });

            // Memo Form
            document.getElementById('memoForm').addEventListener('submit', handleSubmitMemo);
            document.getElementById('memoFile').addEventListener('change', (e) => {
                const fileName = e.target.files[0] ? e.target.files[0].name : 'ยังไม่ได้เลือกไฟล์';
                document.getElementById('memoFileName').textContent = fileName;
            });
            document.querySelectorAll('input[name="memoType"]').forEach(radio => {
                radio.addEventListener('change', toggleMemoUploadSection);
            });

            // Search
            document.getElementById('myRequestsSearch').addEventListener('input', (e) => renderMyRequestsList(myRequestsCache, myMemosCache, e.target.value));
            document.getElementById('adminRequestsSearch').addEventListener('input', (e) => renderRequestsList(allRequestsCache, allMemosCache, e.target.value));
            document.getElementById('adminMemosSearch').addEventListener('input', (e) => renderMemosList(allMemosCache, e.target.value));

            // Admin Modals
            document.getElementById('showAddUserModal').addEventListener('click', () => openModal('addUserModal'));
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('importUsersFile').addEventListener('change', handleImportUsers);
            document.getElementById('approveCommandForm').addEventListener('submit', handleApproveCommand);
            document.getElementById('generateDispatchForm').addEventListener('submit', handleGenerateDispatch);
            // --- ผูก Event Listener ที่ถูกต้อง ---
            document.getElementById('updateStatusCommandForm').addEventListener('submit', handleUpdateStatusCommand);
            document.getElementById('updateMemoStatusForm').addEventListener('submit', handleUpdateMemoStatus);
        });

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
            else console.error(`showPage: Page ID '${pageId}' not found.`);
        }
        function showMainPageContent(pageId) {
            document.querySelectorAll('.main-page-content').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
            else console.error(`showMainPageContent: Content ID '${pageId}' not found.`);

            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.page === pageId);
            });
            // Refresh data when switching to certain tabs
            if (pageId === 'myRequestsPage') loadMyRequests();
            else if (pageId === 'memoPage') loadMemoData();
            else if (pageId === 'homePage') loadDashboardData();
        }
        function showAdminPageContent(pageId) {
             document.querySelectorAll('.admin-page-content').forEach(page => page.classList.add('hidden')); // Keep using hidden for sub-admin pages
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.remove('hidden');
            else console.error(`showAdminPageContent: Admin Content ID '${pageId}' not found.`);

            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.page === pageId);
            });
            // Refresh data when switching admin tabs
            if (pageId === 'adminRequests') loadAllRequests();
            else if (pageId === 'adminMemos') loadAllMemos();
            else if (pageId === 'adminUsers') loadAllUsers();
            else if (pageId === 'adminDashboard') loadAdminDashboard();
        }

        // --- MODAL CONTROLS ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'flex';
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }
        // Close modal on outside click
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // --- API CALL FUNCTION ---
        async function gasApiCall(action, payload) {
            showSpinner();
            console.log(`Sending Action: ${action}`, payload);
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    // mode: 'no-cors', // Avoid no-cors unless absolutely necessary
                    redirect: 'follow',
                    // Let browser set Content-Type for stringified JSON body
                    // headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, payload })
                });
                hideSpinner();

                if (!response.ok) {
                    let errorText = `HTTP error ${response.status}`;
                    try { const errBody = await response.text(); errorText += `: ${errBody}`; } catch (e) {}
                    throw new Error(errorText);
                }

                const result = await response.json();
                console.log(`Received Response for ${action}:`, result);
                if (result.status === 'error') {
                    throw new Error(result.message || 'Unknown server error');
                }
                return result;
            } catch (error) {
                hideSpinner();
                console.error('GAS API Call Error:', action, error);
                alert(`เกิดข้อผิดพลาด (${action}): ${error.message}`);
                throw error;
            }
        }

        async function gasApiGet(action, params = {}) {
            showSpinner();
            console.log(`Sending GET Action: ${action}`, params);
            try {
                const url = new URL(GAS_URL);
                url.searchParams.append('action', action);
                for (const key in params) {
                    if (params.hasOwnProperty(key)) {
                        url.searchParams.append(key, params[key]);
                    }
                }
                const response = await fetch(url, { method: 'GET' });
                hideSpinner();

                if (!response.ok) {
                    let errorText = `HTTP error ${response.status}`;
                    try { const errBody = await response.text(); errorText += `: ${errBody}`; } catch (e) {}
                    throw new Error(errorText);
                }

                const result = await response.json();
                console.log(`Received GET Response for ${action}:`, result);
                if (result.status === 'error') {
                    throw new Error(result.message || 'Unknown server error');
                }
                // Check if data exists before returning
                return result.data || []; // Return data or empty array if data is missing
            } catch (error) {
                hideSpinner();
                console.error('GAS API GET Error:', action, error);
                alert(`เกิดข้อผิดพลาดในการดึงข้อมูล (${action}): ${error.message}`);
                throw error; // Re-throw
            }
        }


        // --- AUTHENTICATION ---
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            loginError.classList.add('hidden');

            try {
                const result = await gasApiCall('verifyCredentials', { username, password });
                // --- ใช้ PascalCase ---
                if (result.status === 'success' && result.user && result.user.FullName && result.user.Role && result.user.Username) {
                    currentUser = result.user;
                    sessionStorage.setItem('wnyUser', JSON.stringify(currentUser));
                    initializeApp();
                } else {
                    const message = result.message || 'ข้อมูลผู้ใช้ไม่สมบูรณ์';
                    loginError.textContent = message;
                    loginError.classList.remove('hidden');
                    console.error("Login failed or user data incomplete:", result);
                }
            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            }
        }


        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const fullName = document.getElementById('regFullName').value;
            const position = document.getElementById('regPosition').value;
            const department = document.getElementById('regDepartment').value;
            const registerError = document.getElementById('registerError');
            const registerSuccess = document.getElementById('registerSuccess');
            registerError.classList.add('hidden');
            registerSuccess.classList.add('hidden');

            try {
                // Send PascalCase keys expected by GAS registerUser
                const result = await gasApiCall('registerUser', {
                     username, password, fullName, position, department, role: 'user'
                });
                if (result.status === 'success') {
                    registerSuccess.textContent = 'ลงทะเบียนสำเร็จ! กรุณากลับไปหน้าเข้าสู่ระบบ';
                    registerSuccess.classList.remove('hidden');
                    document.getElementById('registerForm').reset();
                } else {
                    registerError.textContent = result.message || 'การลงทะเบียนล้มเหลว';
                    registerError.classList.remove('hidden');
                }
            } catch (error) {
                registerError.textContent = error.message;
                registerError.classList.remove('hidden');
            }
        }

        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('wnyUser');
            document.getElementById('welcomeUser').textContent = '';
            if (myRequestsChartInstance) { myRequestsChartInstance.destroy(); myRequestsChartInstance = null; }
            if (requestsByDeptChartInstance) { requestsByDeptChartInstance.destroy(); requestsByDeptChartInstance = null; }
            if (requestsByMonthChartInstance) { requestsByMonthChartInstance.destroy(); requestsByMonthChartInstance = null; }
            // Clear caches
            allRequestsCache = []; allMemosCache = []; allUsersCache = []; myRequestsCache = []; myMemosCache = [];
            // Reset UI
            showPage('loginPage');
            document.getElementById('adminTab').classList.add('hidden');
        }

        // --- APP INITIALIZATION ---
        function initializeApp() {
            if (!currentUser) {
                console.error("Initialization error: currentUser is null.");
                handleLogout(); return;
            }
            showPage('mainPage');
            showMainPageContent('homePage');
            // --- Use PascalCase ---
            document.getElementById('welcomeUser').textContent = `ยินดีต้อนรับ, ${currentUser.FullName} (${currentUser.Position || 'N/A'})`;
            if (currentUser.Role === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            } else {
                 document.getElementById('adminTab').classList.add('hidden');
            }
            loadDashboardData();
        }


        // --- DASHBOARD ---
        async function loadDashboardData() {
            if (!currentUser || !currentUser.Username) return;
            try {
                // Fetch using current username (PascalCase)
                const [requests, memos] = await Promise.all([
                    gasApiGet('getUserRequests', { username: currentUser.Username }),
                    gasApiGet('getSentMemos', { username: currentUser.Username })
                ]);

                myRequestsCache = Array.isArray(requests) ? requests : [];
                myMemosCache = Array.isArray(memos) ? memos : [];

                // --- Use PascalCase ---
                const completedStatuses = ['เสร็จสิ้น', 'อนุมัติ', 'เสร็จสิ้นรอออกคำสั่งไปราชการ'];
                // Check both Status and CommandStatus (PascalCase)
                const completedCount = myRequestsCache.filter(r =>
                    (r.Status && completedStatuses.includes(r.Status)) ||
                    (r.CommandStatus && completedStatuses.includes(r.CommandStatus))
                ).length;
                const pendingCount = myRequestsCache.length - completedCount;

                document.getElementById('statMyTotalRequests').textContent = myRequestsCache.length;
                document.getElementById('statMyCompletedRequests').textContent = completedCount;
                document.getElementById('statMyPendingRequests').textContent = pendingCount;
                document.getElementById('statMyMemos').textContent = myMemosCache.length;

                renderMyRequestsChart(pendingCount, completedCount);

            } catch (error) {
                console.error('Error loading user dashboard data:', error);
            }
        }

        // --- (renderMyRequestsChart - OK) ---
        function renderMyRequestsChart(pending, completed) {
            const ctx = document.getElementById('myRequestsChart').getContext('2d');
            if (myRequestsChartInstance) {
                myRequestsChartInstance.destroy();
            }
            myRequestsChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['กำลังดำเนินการ', 'เสร็จสิ้น'],
                    datasets: [{
                        data: [pending, completed],
                        backgroundColor: ['#f59e0b', '#22c55e'],
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: false } } }
            });
        }


        async function loadAdminDashboard() {
            try {
                const [requests, memos, users] = await Promise.all([
                    gasApiGet('getAllRequests'),
                    gasApiGet('getAllMemos'),
                    gasApiGet('getAllUsers')
                ]);

                allRequestsCache = Array.isArray(requests) ? requests : [];
                allMemosCache = Array.isArray(memos) ? memos : [];
                allUsersCache = Array.isArray(users) ? users : [];

                document.getElementById('adminStatTotalRequests').textContent = allRequestsCache.length;
                document.getElementById('adminStatTotalMemos').textContent = allMemosCache.length;
                document.getElementById('adminStatTotalUsers').textContent = allUsersCache.length;

                renderAdminCharts(allRequestsCache, allUsersCache);

            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        // --- (renderAdminCharts - Use PascalCase) ---
        function renderAdminCharts(requests, users) {
            // Chart 1: Requests by Department
            const deptCounts = requests.reduce((acc, req) => {
                // --- Use PascalCase ---
                const dept = req.Department || 'ไม่ระบุ';
                acc[dept] = (acc[dept] || 0) + 1;
                return acc;
            }, {});
            const deptCtx = document.getElementById('requestsByDeptChart').getContext('2d');
            if (requestsByDeptChartInstance) requestsByDeptChartInstance.destroy();
            requestsByDeptChartInstance = new Chart(deptCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(deptCounts),
                    datasets: [{ label: 'จำนวนคำขอ', data: Object.values(deptCounts), backgroundColor: 'rgba(59, 130, 246, 0.7)' }]
                },
                options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
            });

            // Chart 2: Requests by Month
            const monthCounts = new Array(12).fill(0);
            requests.forEach(req => {
                try {
                    // --- Use PascalCase ---
                    if (req.DocDate) {
                        const month = new Date(req.DocDate).getMonth(); // 0-11
                        if (month >= 0 && month <= 11) monthCounts[month]++;
                    }
                } catch(e) {}
            });

            const monthLabels = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const monthCtx = document.getElementById('requestsByMonthChart').getContext('2d');
            if (requestsByMonthChartInstance) requestsByMonthChartInstance.destroy();
            requestsByMonthChartInstance = new Chart(monthCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{ label: 'จำนวนคำขอ', data: monthCounts, borderColor: 'rgba(22, 163, 74, 0.7)', backgroundColor: 'rgba(22, 163, 74, 0.1)', fill: true, tension: 0.1 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }


        // --- PROFILE MANAGEMENT ---
        function openProfileModal() {
            if (!currentUser) return;
            // --- Use PascalCase ---
            document.getElementById('profileUsername').value = currentUser.Username;
            document.getElementById('profileFullName').value = currentUser.FullName;
            document.getElementById('profilePosition').value = currentUser.Position;
            document.getElementById('profileDepartment').value = currentUser.Department;
            document.getElementById('passwordForm').reset();
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordSuccess').classList.add('hidden');
            openModal('profileModal');
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            if (!currentUser) return;
            const payload = {
                // --- Use PascalCase ---
                username: currentUser.Username,
                fullName: document.getElementById('profileFullName').value,
                position: document.getElementById('profilePosition').value,
                department: document.getElementById('profileDepartment').value,
            };
            try {
                const result = await gasApiCall('updateUserProfile', payload);
                if (result.status === 'success') {
                    // --- Update local user (PascalCase) ---
                    currentUser.FullName = payload.fullName;
                    currentUser.Position = payload.position;
                    currentUser.Department = payload.department;
                    sessionStorage.setItem('wnyUser', JSON.stringify(currentUser));
                    // --- Update UI (PascalCase) ---
                    document.getElementById('welcomeUser').textContent = `ยินดีต้อนรับ, ${currentUser.FullName} (${currentUser.Position || 'N/A'})`;
                    alert('อัปเดตข้อมูลสำเร็จ');
                    closeModal('profileModal');
                } else {
                    alert(`อัปเดตล้มเหลว: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`อัปเดตโปรไฟล์ล้มเหลว: ${error.message}`);
            }
        }

        async function handlePasswordUpdate(e) {
            e.preventDefault();
            if (!currentUser) return;
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const passwordError = document.getElementById('passwordError');
            const passwordSuccess = document.getElementById('passwordSuccess');
            passwordError.classList.add('hidden');
            passwordSuccess.classList.add('hidden');

            if (!oldPassword || !newPassword) {
                passwordError.textContent = 'กรุณากรอกรหัสผ่านปัจจุบันและรหัสผ่านใหม่';
                passwordError.classList.remove('hidden');
                return;
            }

            const payload = {
                username: currentUser.Username, // Use PascalCase
                oldPassword: oldPassword,
                newPassword: newPassword
            };

            try {
                const result = await gasApiCall('updatePassword', payload);
                if (result.status === 'success') {
                    passwordSuccess.textContent = 'เปลี่ยนรหัสผ่านสำเร็จ';
                    passwordSuccess.classList.remove('hidden');
                    document.getElementById('passwordForm').reset();
                } else {
                    passwordError.textContent = result.message || 'เปลี่ยนรหัสผ่านล้มเหลว';
                    passwordError.classList.remove('hidden');
                }
            } catch (error) {
                passwordError.textContent = error.message;
                passwordError.classList.remove('hidden');
            }
        }


        // --- REQUEST FORM ---
        function resetRequestForm() {
            document.getElementById('requestForm').reset();
            document.getElementById('attendeesList').innerHTML = '';
            document.getElementById('expenseDetails').style.display = 'block';
            document.getElementById('licensePlate').style.display = 'none';
            document.getElementById('formTitle').textContent = 'สร้างบันทึกข้อความขอไปราชการ';
            document.getElementById('editRequestId').value = '';
            document.getElementById('formError').classList.add('hidden');

            // --- Set defaults from currentUser (PascalCase) ---
            if (currentUser) {
                document.getElementById('requesterName').value = currentUser.FullName || '';
                document.getElementById('requesterPosition').value = currentUser.Position || '';
                document.getElementById('requesterDepartment').value = currentUser.Department || '';
            }
            try { document.getElementById('docDate').valueAsDate = new Date(); } catch(e) {}
            document.getElementById('vehicle_public').checked = true;
            document.getElementById('expense_yes').checked = true;
        }

        function addAttendeeRow(name = '', position = '') {
            const list = document.getElementById('attendeesList');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center attendee-row';
            row.innerHTML = `
                <input type="text" class="form-input md:col-span-1 attendee-name" placeholder="ชื่อ-นามสกุล ผู้ติดตาม" value="${name || ''}" required>
                <input type="text" class="form-input md:col-span-1 attendee-position" placeholder="ตำแหน่ง" value="${position || ''}" required>
                <button type="button" class="btn btn-danger btn-sm md:col-span-1" onclick="this.parentElement.remove()">ลบ</button>
            `;
            list.appendChild(row);
        }

        // --- (toggleLicensePlate - OK) ---
        function toggleLicensePlate(e) { /* ... */ }

        // --- (toggleExpenseDetails - OK) ---
        function toggleExpenseDetails(e) { /* ... */ }


        async function handleSubmitRequest(e) {
            e.preventDefault();
            const formError = document.getElementById('formError');
            formError.classList.add('hidden');
            if (!currentUser) { /* ... handle error ... */ return; }

            const attendees = [];
            document.querySelectorAll('#attendeesList .attendee-row').forEach(row => { /* ... collect attendees ... */ });

            const expenseItems = [];
            const expenseOption = document.querySelector('input[name="expenseOption"]:checked').value;
            let totalExpense = 0;
            if (expenseOption === 'partial') { /* ... collect expense items ... */ }

            // --- Prepare payload (Use PascalCase) ---
            const payload = {
                id: document.getElementById('editRequestId').value || null,
                username: currentUser.Username, // Use PascalCase key
                requesterName: document.getElementById('requesterName').value,
                requesterPosition: document.getElementById('requesterPosition').value,
                department: document.getElementById('requesterDepartment').value,
                docDate: document.getElementById('docDate').value,
                headName: document.getElementById('headName').value,
                purpose: document.getElementById('purpose').value,
                location: document.getElementById('location').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                vehicleOption: document.querySelector('input[name="vehicleOption"]:checked').value,
                licensePlate: document.getElementById('licensePlate').value,
                expenseOption: expenseOption,
                expenseItems: expenseItems,
                totalExpense: totalExpense,
                attendees: attendees
            };

            // Basic Validation
            if (!payload.docDate || !payload.headName || !payload.purpose || !payload.location || !payload.startDate || !payload.endDate) { /* ... */ return; }
            if ((payload.vehicleOption === 'gov' || payload.vehicleOption === 'private') && !payload.licensePlate) { /* ... */ return; }

            try {
                const result = await gasApiCall('createRequest', payload); // Action is correct
                if (result.status === 'success') {
                    alert('บันทึกคำขอสำเร็จ!');
                    if (result.data && result.data.pdfUrl) window.open(result.data.pdfUrl, '_blank');
                    resetRequestForm();
                    showMainPageContent('myRequestsPage');
                } else { /* ... show error ... */ }
            } catch (error) { /* ... show error ... */ }
        }

        // --- MY REQUESTS PAGE ---
        async function loadMyRequests() {
            if (!currentUser || !currentUser.Username) return;
            try {
                // --- Use PascalCase ---
                const [requests, memos] = await Promise.all([
                    gasApiGet('getUserRequests', { username: currentUser.Username }),
                    gasApiGet('getSentMemos', { username: currentUser.Username })
                ]);
                myRequestsCache = Array.isArray(requests) ? requests : [];
                myMemosCache = Array.isArray(memos) ? memos : [];
                renderMyRequestsList(myRequestsCache, myMemosCache, document.getElementById('myRequestsSearch').value);
            } catch (error) { /* ... handle error ... */ }
        }

        // --- (renderMyRequestsList - Use PascalCase) ---
        function renderMyRequestsList(requests, memos, searchTerm = '') {
            const container = document.getElementById('myRequestsContainer');
            const noDataMsg = document.getElementById('noMyRequestsMsg');
            container.innerHTML = '';

            let filteredRequests = requests;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                // --- Use PascalCase ---
                filteredRequests = requests.filter(req =>
                    req.Purpose?.toLowerCase().includes(lowerCaseSearch) ||
                    req.Location?.toLowerCase().includes(lowerCaseSearch) ||
                    req.RequestId?.toLowerCase().includes(lowerCaseSearch) // Correct key
                );
            }

            if (!filteredRequests || filteredRequests.length === 0) {
                noDataMsg.classList.remove('hidden'); return;
            }
            noDataMsg.classList.add('hidden');

            const table = createTableHtml(['ID คำขอ', 'เรื่อง', 'วันที่ไป', 'สถานะบันทึก', 'สถานะคำสั่ง', 'การดำเนินการ']);
            const tbody = table.querySelector('tbody');

            // --- Use PascalCase ---
            filteredRequests.sort((a, b) => new Date(b.DocDate) - new Date(a.DocDate));

            filteredRequests.forEach(req => {
                // --- Use PascalCase ---
                const hasMemo = memos.some(m => m.RefNumber === req.RequestId); // Correct keys
                const memoStatus = hasMemo ? 'ส่งแล้ว' : 'ยังไม่ส่ง';
                const commandStatus = req.CommandStatus || 'N/A'; // Correct key

                // --- Use PascalCase ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 ...">${req.RequestId || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${req.Purpose || ''}</td>
                        <td class="px-4 py-3 ...">${formatDate(req.StartDate)}</td>
                        <td class="px-4 py-3 ... ${hasMemo ? 'text-green-600 font-medium' : 'text-yellow-600'}">${memoStatus}</td>
                        <td class="px-4 py-3 ... ${commandStatus.includes('เสร็จสิ้น') ? 'text-green-600' : (commandStatus === 'กำลังดำเนินการ' ? 'text-yellow-700' : 'text-gray-600')}">${commandStatus}</td>
                        <td class="px-4 py-3 ...">
                            <button class="btn btn-outline btn-sm" onclick="viewRequestDetails('${req.RequestId}')">ดูรายละเอียด</button>
                            <button class="btn btn-secondary btn-sm" onclick="editRequest('${req.RequestId}')" ${hasMemo ? 'disabled title="ส่งบันทึกแล้ว"' : ''}>แก้ไข</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- (editRequest - Use PascalCase) ---
        function editRequest(requestId) {
            // --- Use PascalCase ---
            const req = myRequestsCache.find(r => r.RequestId === requestId);
            if (!req) { /* ... handle error ... */ return; }
            if (myMemosCache.some(m => m.RefNumber === req.RequestId)) { /* ... handle error ... */ return; }

            resetRequestForm();
            document.getElementById('formTitle').textContent = 'แก้ไขบันทึกข้อความ';
            // --- Use PascalCase ---
            document.getElementById('editRequestId').value = req.RequestId; // Set hidden ID

            document.getElementById('requesterName').value = req.RequesterName;
            document.getElementById('requesterPosition').value = req.RequesterPosition;
            document.getElementById('requesterDepartment').value = req.Department;
            document.getElementById('docDate').value = formatDate(req.DocDate, true);
            document.getElementById('headName').value = req.HeadName;
            document.getElementById('purpose').value = req.Purpose;
            document.getElementById('location').value = req.Location;
            document.getElementById('startDate').value = formatDateTime(req.StartDate);
            document.getElementById('endDate').value = formatDateTime(req.EndDate);

            // Vehicle Option
            const vehicleOptionInput = document.querySelector(`input[name="vehicleOption"][value="${req.VehicleOption}"]`);
            if (vehicleOptionInput) vehicleOptionInput.checked = true;
            toggleLicensePlate({ target: vehicleOptionInput || {} });
            if (req.VehicleOption === 'gov' || req.VehicleOption === 'private') {
                document.getElementById('licensePlate').value = req.LicensePlate || '';
            }

            // Expense Option
            const expenseOptionInput = document.querySelector(`input[name="expenseOption"][value="${req.ExpenseOption}"]`);
            if (expenseOptionInput) expenseOptionInput.checked = true;
            toggleExpenseDetails({ target: expenseOptionInput || {} });
            if (req.ExpenseOption === 'partial') {
                document.getElementById('totalExpense').value = req.TotalExpense || '0';
                document.querySelectorAll('input[name="expenseItem"]').forEach(chk => chk.checked = false);
                document.getElementById('expense_other_text').value = '';
                try {
                    let items = [];
                    if (typeof req.ExpenseItems === 'string') items = JSON.parse(req.ExpenseItems);
                    else if (Array.isArray(req.ExpenseItems)) items = req.ExpenseItems;
                    items.forEach(item => { /* ... set checkboxes ... */ });
                } catch (e) { console.error('Error parsing ExpenseItems for edit:', e); }
            }

            // Load attendees
            document.getElementById('attendeesList').innerHTML = '';
            // --- Use PascalCase ---
            gasApiGet('getAttendeesForRequest', { requestId: req.RequestId }).then(attendees => {
                if (Array.isArray(attendees)) {
                    attendees.forEach(att => addAttendeeRow(att.name, att.position));
                }
            }).catch(err => console.error("Failed to load attendees for edit:", err));

            showMainPageContent('createRequestPage');
        }


        // --- MEMO PAGE ---
        async function loadMemoData() {
            if (!currentUser || !currentUser.Username) return;
            try {
                // --- Use PascalCase ---
                const allMyRequests = await gasApiGet('getUserRequests', { username: currentUser.Username });
                const myMemos = await gasApiGet('getSentMemos', { username: currentUser.Username });

                myMemosCache = Array.isArray(myMemos) ? myMemos : [];
                renderMyMemosList(myMemos); // Render submitted memos

                const submittedMemoRequestIds = new Set(myMemos.map(m => m.RefNumber)); // Use RefNumber
                // --- Use PascalCase ---
                const pendingRequests = allMyRequests.filter(r => r.RequestId && !submittedMemoRequestIds.has(r.RequestId)); // Use RequestId

                const select = document.getElementById('memoRefNumber');
                select.innerHTML = '<option value="">-- กรุณาเลือกคำขอ --</option>';
                pendingRequests.sort((a,b) => new Date(b.DocDate) - new Date(a.DocDate));
                pendingRequests.forEach(req => {
                    // --- Use PascalCase ---
                    const option = new Option(`${req.RequestId} - ${req.Purpose}`, req.RequestId); // Use RequestId
                    select.add(option);
                });

            } catch (error) { /* ... handle error ... */ }
        }

        // --- (toggleMemoUploadSection - OK) ---
        function toggleMemoUploadSection(e) { /* ... */ }


        async function handleSubmitMemo(e) {
            e.preventDefault();
            const memoError = document.getElementById('memoError');
            memoError.classList.add('hidden');
            if (!currentUser) { /* ... handle error ... */ return; }

            const refNumber = document.getElementById('memoRefNumber').value;
            const memoType = document.querySelector('input[name="memoType"]:checked').value;
            const fileInput = document.getElementById('memoFile');

            if (!refNumber) { /* ... handle error ... */ return; }

            // --- Prepare payload (Use PascalCase) ---
            const payload = {
                refNumber: refNumber, // Corresponds to RequestId
                username: currentUser.Username, // PascalCase
                memoType: memoType,
                file: null
            };

            if (memoType === 'file') {
                if (fileInput.files.length === 0) { /* ... handle error ... */ return; }
                try {
                    const file = fileInput.files[0];
                    if (file.size > 10 * 1024 * 1024) throw new Error("ขนาดไฟล์เกิน 10MB");
                    const base64 = await fileToBase64(file);
                    payload.file = { filename: file.name, mimeType: file.type || 'application/octet-stream', data: base64 };
                } catch (err) { /* ... handle error ... */ return; }
            }

            try {
                const result = await gasApiCall('uploadMemo', payload); // Action is correct
                if (result.status === 'success') {
                    alert('ส่งบันทึกสรุปสำเร็จ!');
                    document.getElementById('memoForm').reset();
                    document.getElementById('memoFileName').textContent = 'ยังไม่ได้เลือกไฟล์';
                    document.getElementById('memoTypeFile').checked = true;
                    toggleMemoUploadSection({target: document.getElementById('memoTypeFile')});
                    // --- Force refresh ---
                    await loadMemoData();
                    // Determine active request list and refresh it
                    if (document.getElementById('myRequestsPage').classList.contains('active')) {
                       await loadMyRequests();
                    } else if (document.getElementById('adminRequests') && document.getElementById('adminRequests').classList.contains('active')) { // Check if adminRequests exists and is active
                       await loadAllRequests();
                    }

                } else { /* ... show error ... */ }
            } catch (error) { /* ... show error ... */ }
        }

        // --- (renderMyMemosList - Use PascalCase) ---
        function renderMyMemosList(memos, searchTerm = '') {
            const container = document.getElementById('myMemosContainer');
            const noDataMsg = document.getElementById('noMyMemosMsg');
            container.innerHTML = '';

            let filteredMemos = memos;
             if (searchTerm) {
                 const lowerCaseSearch = searchTerm.toLowerCase();
                 // --- Use PascalCase ---
                 filteredMemos = memos.filter(m =>
                     m.MemoId?.toLowerCase().includes(lowerCaseSearch) || // Correct key
                     m.RefNumber?.toLowerCase().includes(lowerCaseSearch)
                 );
             }

            if (!filteredMemos || filteredMemos.length === 0) {
                noDataMsg.classList.remove('hidden'); return;
            }
            noDataMsg.classList.add('hidden');

            const table = createTableHtml(['ID บันทึก', 'ID คำขอ', 'วันที่ส่ง', 'สถานะ', 'ไฟล์แนบ', 'การดำเนินการ']);
            const tbody = table.querySelector('tbody');

            // --- Use PascalCase ---
            filteredMemos.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            filteredMemos.forEach(m => {
                // --- Use PascalCase ---
                const fileLink = m.FileUrl ? `<a href="${m.FileUrl}" target="_blank" class="text-blue-600 hover:underline">เปิดไฟล์</a>` : 'ไม่มี';
                const statusClass = m.Status === 'อนุมัติ' ? 'text-green-600' : (m.Status === 'ตีกลับ' ? 'text-red-600' : 'text-yellow-600');

                // --- Use PascalCase ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 ...">${m.MemoId || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${m.RefNumber || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${formatDate(m.Timestamp)}</td>
                        <td class="px-4 py-3 ... ${statusClass}">${m.Status || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${fileLink}</td>
                        <td class="px-4 py-3 ...">
                            <button class="btn btn-outline btn-sm" onclick="viewMemoDetails('${m.MemoId}')">ดูรายละเอียด</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- ADMIN: ALL REQUESTS ---
        async function loadAllRequests() {
            try {
                const [requests, memos] = await Promise.all([
                    gasApiGet('getAllRequests'),
                    gasApiGet('getAllMemos')
                ]);
                allRequestsCache = Array.isArray(requests) ? requests : [];
                allMemosCache = Array.isArray(memos) ? memos : [];
                renderRequestsList(allRequestsCache, allMemosCache, document.getElementById('adminRequestsSearch').value);
            } catch (error) { /* ... handle error ... */ }
        }

        // --- (renderRequestsList - Use PascalCase) ---
        function renderRequestsList(requests, memos, searchTerm = '') {
            const container = document.getElementById('adminRequestsContainer');
            const noDataMsg = document.getElementById('noAdminRequestsMsg');
            container.innerHTML = '';

            let filteredRequests = requests;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                // --- Use PascalCase ---
                filteredRequests = requests.filter(req =>
                    req.Purpose?.toLowerCase().includes(lowerCaseSearch) ||
                    req.Location?.toLowerCase().includes(lowerCaseSearch) ||
                    req.RequesterName?.toLowerCase().includes(lowerCaseSearch) ||
                    req.RequestId?.toLowerCase().includes(lowerCaseSearch) // Correct key
                );
            }

            if (!filteredRequests || filteredRequests.length === 0) {
                noDataMsg.classList.remove('hidden'); return;
            }
            noDataMsg.classList.add('hidden');

            const table = createTableHtml(['ID คำขอ', 'ผู้ขอ', 'เรื่อง', 'วันที่ไป', 'สถานะบันทึก', 'สถานะคำสั่ง', 'การดำเนินการ']);
            const tbody = table.querySelector('tbody');

            // --- Use PascalCase ---
            filteredRequests.sort((a, b) => new Date(b.DocDate) - new Date(a.DocDate));

            filteredRequests.forEach(req => {
                // --- Use PascalCase ---
                const hasMemo = memos.some(m => m.RefNumber === req.RequestId); // Correct keys
                const memoStatus = hasMemo ? 'ส่งแล้ว' : 'ยังไม่ส่ง';
                const commandStatus = req.CommandStatus || 'N/A'; // Correct key

                const escapedReq = JSON.stringify(req).replace(/"/g, '&quot;');

                // --- Use PascalCase ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 ...">${req.RequestId || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${req.RequesterName || ''}</td>
                        <td class="px-4 py-3 ...">${req.Purpose || ''}</td>
                        <td class="px-4 py-3 ...">${formatDate(req.StartDate)}</td>
                        <td class="px-4 py-3 ... ${hasMemo ? 'text-green-600 font-medium' : 'text-yellow-600'}">${memoStatus}</td>
                        <td class="px-4 py-3 ... ${commandStatus.includes('เสร็จสิ้น') ? 'text-green-600' : (commandStatus === 'กำลังดำเนินการ' ? 'text-yellow-700' : 'text-gray-600')}">${commandStatus}</td>
                        <td class="px-4 py-3 ...">
                            <button class="btn btn-outline btn-sm ..." onclick="viewRequestDetails('${req.RequestId}')">ดูไฟล์</button>
                            <button class="btn btn-primary btn-sm ..." onclick='openApproveCommandModal(${escapedReq})'>อนุมัติคำสั่ง</button>
                            <button class="btn btn-success btn-sm ..." onclick='openGenerateDispatchModal(${escapedReq})'>ส่งเขต</button>
                            <button class="btn btn-secondary btn-sm ..." onclick='openUpdateStatusCommandModal(${escapedReq})'>แก้สถานะ</button>
                            <button class="btn btn-danger btn-sm ..." onclick='openDeleteModal(${escapedReq}, "request")'>ลบ</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- ADMIN: ALL MEMOS ---
        async function loadAllMemos() {
            try {
                const memos = await gasApiGet('getAllMemos');
                allMemosCache = Array.isArray(memos) ? memos : [];
                renderMemosList(allMemosCache, document.getElementById('adminMemosSearch').value);
            } catch (error) { /* ... handle error ... */ }
        }

        // --- (renderMemosList - Use PascalCase) ---
        function renderMemosList(memos, searchTerm = '') {
            const container = document.getElementById('adminMemosContainer');
            const noDataMsg = document.getElementById('noAdminMemosMsg');
            container.innerHTML = '';

            let filteredMemos = memos;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                // --- Use PascalCase ---
                filteredMemos = memos.filter(m =>
                    m.MemoId?.toLowerCase().includes(lowerCaseSearch) || // Correct Key
                    m.RefNumber?.toLowerCase().includes(lowerCaseSearch) ||
                    m.Username?.toLowerCase().includes(lowerCaseSearch)
                );
            }

            if (!filteredMemos || filteredMemos.length === 0) {
                noDataMsg.classList.remove('hidden'); return;
            }
            noDataMsg.classList.add('hidden');

            const table = createTableHtml(['ID บันทึก', 'ผู้ส่ง', 'ID คำขอ', 'วันที่ส่ง', 'สถานะ', 'ไฟล์แนบ', 'การดำเนินการ']);
            const tbody = table.querySelector('tbody');

            // --- Use PascalCase ---
            filteredMemos.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

            filteredMemos.forEach(m => {
                // --- Use PascalCase ---
                const fileLink = m.FileUrl ? `<a href="${m.FileUrl}" target="_blank" class="text-blue-600 hover:underline">เปิดไฟล์</a>` : 'ไม่มี';
                const statusClass = m.Status === 'อนุมัติ' ? 'text-green-600' : (m.Status === 'ตีกลับ' ? 'text-red-600' : 'text-yellow-600');
                const escapedMemo = JSON.stringify(m).replace(/"/g, '&quot;');

                // --- Use PascalCase ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 ...">${m.MemoId || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${m.Username || ''}</td>
                        <td class="px-4 py-3 ...">${m.RefNumber || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${formatDate(m.Timestamp)}</td>
                        <td class="px-4 py-3 ... ${statusClass}">${m.Status || 'N/A'}</td>
                        <td class="px-4 py-3 ...">${fileLink}</td>
                        <td class="px-4 py-3 ...">
                            <button class="btn btn-outline btn-sm" onclick="viewMemoDetails('${m.MemoId}')">ดูรายละเอียด</button>
                            <button class="btn btn-primary btn-sm" onclick='openUpdateMemoStatusModal(${escapedMemo})'>จัดการ</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- ADMIN: USER MANAGEMENT ---
        async function loadAllUsers() {
            try {
                const users = await gasApiGet('getAllUsers');
                allUsersCache = Array.isArray(users) ? users : [];
                renderUsersList(allUsersCache);
            } catch (error) { /* ... handle error ... */ }
        }

        // --- (renderUsersList - Use PascalCase) ---
        function renderUsersList(users) {
            const container = document.getElementById('adminUsersContainer');
            container.innerHTML = '';
            if (!users || users.length === 0) { /* ... handle no users ... */ return; }

            const table = createTableHtml(['Username', 'Full Name', 'Position', 'Department', 'Role', 'Actions']);
            const tbody = table.querySelector('tbody');

            users.forEach(user => {
                 // --- Use PascalCase ---
                const row = `
                    <tr>
                        <td class="px-4 py-3 ...">${user.Username || ''}</td>
                        <td class="px-4 py-3 ...">${user.FullName || ''}</td>
                        <td class="px-4 py-3 ...">${user.Position || ''}</td>
                        <td class="px-4 py-3 ...">${user.Department || ''}</td>
                        <td class="px-4 py-3 ...">${user.Role || 'user'}</td>
                        <td class="px-4 py-3 ...">
                            <button class="btn btn-danger btn-sm" onclick="handleDeleteUser('${user.Username}')" ${currentUser && currentUser.Username === user.Username ? 'disabled title="ไม่สามารถลบตัวเองได้"' : ''}>ลบ</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            container.appendChild(table);
        }

        // --- (handleAddUser - Use PascalCase for payload) ---
        async function handleAddUser(e) { /* ... Use PascalCase for payload keys ... */ }

        // --- (handleDeleteUser - Use PascalCase for payload) ---
        async function handleDeleteUser(username) { /* ... Use PascalCase for payload key ... */ }

        // --- (handleImportUsers - OK, assumes XLSX uses PascalCase) ---
        function handleImportUsers(event) { /* ... */ }


        // --- MODAL ACTIONS ---

        // --- (viewRequestDetails - Use PascalCase) ---
        function viewRequestDetails(requestId) {
            // --- Use PascalCase ---
            const req = allRequestsCache.find(r => r.RequestId === requestId) || myRequestsCache.find(r => r.RequestId === requestId);
            if (!req) { /* ... handle error ... */ return; }

            // --- Use PascalCase for all req. properties ---
            document.getElementById('detailId').textContent = req.RequestId;
            document.getElementById('detailDocDate').textContent = formatDate(req.DocDate);
            document.getElementById('detailRequesterName').textContent = req.RequesterName;
            document.getElementById('detailPosition').textContent = req.RequesterPosition;
            document.getElementById('detailPurpose').textContent = req.Purpose;
            document.getElementById('detailLocation').textContent = req.Location;
            document.getElementById('detailStartDate').textContent = formatDateTime(req.StartDate);
            document.getElementById('detailEndDate').textContent = formatDateTime(req.EndDate);

            const vehicleMap = { /* ... */ };
            document.getElementById('detailVehicle').textContent = vehicleMap[req.VehicleOption] || req.VehicleOption || 'N/A';
            document.getElementById('detailLicense').textContent = req.LicensePlate || '-';

            document.getElementById('detailExpense').textContent = req.ExpenseOption === 'no' ? 'ไม่เบิก' : 'เบิก';
            document.getElementById('detailTotalExpense').textContent = formatThaiCurrency(req.TotalExpense) || '๐.๐๐';

            let itemsText = 'ไม่มี';
            if (req.ExpenseOption !== 'no') {
                try {
                    let items = [];
                    if (typeof req.ExpenseItems === 'string') items = JSON.parse(req.ExpenseItems);
                    else if (Array.isArray(req.ExpenseItems)) items = req.ExpenseItems;
                    itemsText = items.map(item => item.name + (item.detail ? ` (${item.detail})` : '')).join(', ') || 'ไม่มี';
                } catch (e) { itemsText = '(ข้อมูลรายการไม่ถูกต้อง)'; }
            }
            document.getElementById('detailExpenseItems').textContent = itemsText;

            // Attendees
            const attendeesContainer = document.getElementById('detailAttendees');
            attendeesContainer.innerHTML = '<li>กำลังโหลด...</li>';
            // --- Use PascalCase ---
            gasApiGet('getAttendeesForRequest', { requestId: req.RequestId }).then(attendees => {
                if (!Array.isArray(attendees) || attendees.length === 0) {
                    attendeesContainer.innerHTML = '<li>ไม่มีผู้ติดตาม</li>';
                } else {
                    attendeesContainer.innerHTML = attendees.map((att, i) => `<li>${i+1}. ${att.name || ''} (${att.position || ''})</li>`).join('');
                }
            }).catch(err => { /* ... */ });

            // --- PDF Links (Use PascalCase) ---
            document.getElementById('detailPdfLink').href = req.PdfUrl || '#';
            document.getElementById('detailCmdSoloLink').href = req.CommandPdfUrlSolo || '#';
            document.getElementById('detailCmdSmallLink').href = req.CommandPdfUrlGroupSmall || '#';
            document.getElementById('detailCmdLargeLink').href = req.CommandPdfUrlGroupLarge || '#';

            const finalCmdLink = document.getElementById('detailCmdFinalLink');
            if (req.CommandPdfUrl) { /* ... */ } else { /* ... */ }

            const dispatchLink = document.getElementById('detailDispatchLink');
            if (req.DispatchBookPdfUrl) { /* ... */ } else { /* ... */ }

            openModal('requestDetailsModal');
        }

        // --- (viewMemoDetails - Use PascalCase) ---
        function viewMemoDetails(memoId) {
             // --- Use PascalCase ---
            const memo = allMemosCache.find(m => m.MemoId === memoId) || myMemosCache.find(m => m.MemoId === memoId);
            if (!memo) { /* ... handle error ... */ return; }

             // --- Use PascalCase ---
            document.getElementById('memoDetailId').textContent = memo.MemoId;
            document.getElementById('memoDetailRefNumber').textContent = memo.RefNumber;
            document.getElementById('memoDetailUsername').textContent = memo.Username;
            document.getElementById('memoDetailTimestamp').textContent = formatDateTime(memo.Timestamp);
            document.getElementById('memoDetailStatus').textContent = memo.Status;

            const fileLinkContainer = document.getElementById('memoDetailFileLinkContainer');
            const fileLink = document.getElementById('memoDetailFileUrl');
            const noFileSpan = document.getElementById('memoDetailNoFile');
            if (memo.FileUrl) { // Use PascalCase
                fileLink.href = memo.FileUrl;
                fileLink.style.display = 'inline';
                noFileSpan.style.display = 'none';
            } else {
                fileLink.style.display = 'none';
                noFileSpan.style.display = 'inline';
            }

            document.getElementById('memoDetailApprovedBy').textContent = memo.ApprovedBy || '-'; // PascalCase
            document.getElementById('memoDetailApprovalDate').textContent = memo.ApprovalDate ? formatDateTime(memo.ApprovalDate) : '-'; // PascalCase
            document.getElementById('memoDetailRemarks').textContent = memo.Remarks || '-'; // PascalCase

            openModal('memoDetailsModal');
        }

        // --- (confirmAndDeleteRequest - Use PascalCase) ---
        function confirmAndDeleteRequest(requestId) {
            if (!requestId) return;
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = async () => {
                try {
                    // --- Use PascalCase ---
                    const result = await gasApiCall('deleteRequest', { id: requestId }); // GAS expects 'id' here
                    if (result.status === 'success') { /* ... */ } else { /* ... */ }
                } catch (error) { /* ... */ }
            };
            // Modal text already set by openDeleteModal
            openModal('deleteModal');
        }
        // --- (openDeleteModal - Use PascalCase) ---
        function openDeleteModal(item, type) {
             if (!item) return;
             // --- Use PascalCase ---
             const idToDelete = type === 'request' ? item.RequestId : (type === 'memo' ? item.MemoId : null);
             const itemDescription = type === 'request' ? `คำขอ ID ${idToDelete}` : `บันทึก ID ${idToDelete}`;

             if (!idToDelete) { /* ... */ return; }

             const modalText = document.getElementById('deleteConfirmText');
             if(modalText) modalText.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบ ${itemDescription}?`;

            const confirmBtn = document.getElementById('confirmDeleteBtn');
             if (type === 'request') {
                  confirmBtn.onclick = () => confirmAndDeleteRequest(idToDelete);
             } else if (type === 'memo') { /* ... Implement memo delete ... */ }
              else { confirmBtn.onclick = null; }

             openModal('deleteModal');
        }

        // --- (openApproveCommandModal - Use PascalCase) ---
        function openApproveCommandModal(request) {
            if (!request || !request.RequestId) return;
            // --- Use PascalCase ---
            document.getElementById('approveCommandRequestId').value = request.RequestId;
            document.getElementById('approveCommandIdLabel').textContent = request.RequestId;
            document.getElementById('commandTemplateType').value = '';
            openModal('approveCommandModal');
        }

        // --- (handleApproveCommand - Use PascalCase) ---
        async function handleApproveCommand(e) {
            e.preventDefault();
            const payload = {
                // --- Use PascalCase ---
                requestId: document.getElementById('approveCommandRequestId').value,
                templateType: document.getElementById('commandTemplateType').value
            };
            if (!payload.templateType) { /* ... */ return; }
            try {
                const result = await gasApiCall('approveCommand', payload);
                if (result.status === 'success') { /* ... */ } else { /* ... */ }
            } catch (error) { /* ... */ }
        }

        // --- (openGenerateDispatchModal - Use PascalCase) ---
        function openGenerateDispatchModal(request) {
             if (!request || !request.RequestId) return;
            // --- Use PascalCase ---
            document.getElementById('dispatchRequestId').value = request.RequestId;
            document.getElementById('dispatchIdLabel').textContent = request.RequestId;
            // ... (set defaults) ...
            openModal('generateDispatchModal');
        }

        // --- (handleGenerateDispatch - Use PascalCase) ---
        async function handleGenerateDispatch(e) {
            e.preventDefault();
            const payload = {
                // --- Use PascalCase ---
                requestId: document.getElementById('dispatchRequestId').value,
                dispatchMonth: document.getElementById('dispatchMonth').value,
                dispatchYear: document.getElementById('dispatchYear').value,
                commandCount: document.getElementById('dispatchCommandCount').value,
                memoCount: document.getElementById('dispatchMemoCount').value
            };
            if (!payload.dispatchMonth || !payload.dispatchYear) { /* ... */ return; }
            try {
                const result = await gasApiCall('generateDispatchBook', payload);
                if (result.status === 'success') { /* ... */ } else { /* ... */ }
            } catch (error) { /* ... */ }
        }

        // --- (openUpdateStatusCommandModal - Use PascalCase) ---
        function openUpdateStatusCommandModal(request) {
            if (!request || !request.RequestId) return;
            // --- Use PascalCase ---
            document.getElementById('updateCommandRequestId').value = request.RequestId; // Set value here
            document.getElementById('updateCommandIdLabel').textContent = request.RequestId;
            document.getElementById('newCommandStatus').value = request.CommandStatus || ''; // Use PascalCase
            openModal('updateStatusCommandModal');
        }

        /**
         * === (โค้ดแก้ไข - จุดที่เรียก Action ผิด และส่ง Payload ถูกต้อง) ===
         */
        async function handleUpdateStatusCommand(e) {
            e.preventDefault();
            const payload = {
                // --- Use PascalCase Key for Request ID ---
                requestId: document.getElementById('updateCommandRequestId').value,
                status: document.getElementById('newCommandStatus').value
            };

            // --- Validate Payload ---
            if (!payload.requestId) {
                 alert("เกิดข้อผิดพลาด: ไม่พบ Request ID ที่จะอัปเดต");
                 console.error("handleUpdateStatusCommand: requestId is missing from hidden input.");
                 return;
            }
            if (!payload.status) {
                 alert("กรุณากรอกสถานะใหม่");
                 return;
            }
            // --- End Validation ---

            try {
                 // ***** ใช้ Action ที่ถูกต้อง: 'updateRequestStatusCommand' *****
                 console.log("Calling updateRequestStatusCommand with payload:", payload); // Log before call
                 const result = await gasApiCall('updateRequestStatusCommand', payload);

                 if (result.status === 'success') {
                    alert(result.message || 'อัปเดตสถานะสำเร็จ');
                    closeModal('updateStatusCommandModal');
                    await loadAllRequests(); // Refresh list immediately
                 } else {
                     alert(`อัปเดตสถานะล้มเหลว: ${result.message || 'Unknown server error'}`);
                 }
            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการอัปเดตสถานะ: ${error.message}`);
                console.error("Error in handleUpdateStatusCommand:", error);
            }
        }


        // --- (openUpdateMemoStatusModal - Use PascalCase) ---
        function openUpdateMemoStatusModal(memo) {
            if (!memo || !memo.MemoId) return;
            // --- Use PascalCase ---
            document.getElementById('updateMemoId').value = memo.MemoId; // Set hidden input
            document.getElementById('updateMemoIdLabel').textContent = memo.MemoId;
            document.getElementById('newMemoStatus').value = memo.Status || 'กำลังดำเนินการ';
            document.getElementById('memoRemarks').value = memo.Remarks || '';
            openModal('updateMemoStatusModal');
        }

        // --- (handleUpdateMemoStatus - Use PascalCase) ---
        async function handleUpdateMemoStatus(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.Username) return;
            const payload = {
                // --- Use PascalCase ---
                memoId: document.getElementById('updateMemoId').value,
                newStatus: document.getElementById('newMemoStatus').value,
                remarks: document.getElementById('memoRemarks').value,
                adminUsername: currentUser.Username // PascalCase
            };
             if (!payload.memoId) { alert("เกิดข้อผิดพลาด: ไม่พบ Memo ID"); return; }

            try {
                const result = await gasApiCall('updateMemoStatus', payload);
                alert(result.message);
                if (result.status === 'success' || result.status === 'warning') {
                    closeModal('updateMemoStatusModal');
                    await loadAllMemos();
                    await loadAllRequests(); // Refresh requests too
                }
            } catch (error) { /* Error already alerted by gasApiCall */ }
        }

        // --- UTILITY FUNCTIONS ---
        // --- (createTableHtml - OK) ---
        function createTableHtml(headers) { /* ... */ }
        // --- (formatDate - OK) ---
        function formatDate(dateString, forInput = false) { /* ... */ }
        // --- (formatDateTime - OK) ---
        function formatDateTime(dateString) { /* ... */ }
        // --- (fileToBase64 - OK) ---
        function fileToBase64(file) { /* ... */ }

        // --- REPORTS ---
        // --- (showReportByExpenseType - Use PascalCase) ---
        function showReportByExpenseType(expenseType) {
            const modal = document.getElementById('reportModal');
            const title = document.getElementById('reportTitle');
            const content = document.getElementById('reportContent');
            content.innerHTML = '<p>กำลังสร้างรายงาน...</p>';
            openModal('reportModal');

            // --- Use PascalCase ---
            title.textContent = `รายงานคำขอ (ประเภท: ${expenseType === 'no' ? 'ไม่เบิก' : 'เบิก'})`;

            let filteredRequests = [];
            if (expenseType === 'all') {
                filteredRequests = allRequestsCache;
            } else {
                 // --- Use PascalCase ---
                filteredRequests = allRequestsCache.filter(r => r.ExpenseOption === expenseType);
            }

            if (filteredRequests.length === 0) { /* ... handle no data ... */ return; }

            // Add more columns if needed, use PascalCase
            const table = createTableHtml(['ID คำขอ', 'ผู้ขอ', 'วัตถุประสงค์', 'วันที่เอกสาร', 'วันที่เดินทาง']);
            const tbody = table.querySelector('tbody');
            // --- Use PascalCase ---
            filteredRequests.sort((a,b) => new Date(b.DocDate) - new Date(a.DocDate));

            filteredRequests.forEach(req => {
                // --- Use PascalCase ---
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-2 ...">${req.RequestId || 'N/A'}</td>
                    <td class="px-4 py-2 ...">${req.RequesterName || ''}</td>
                    <td class="px-4 py-2 ...">${req.Purpose || ''}</td>
                    <td class="px-4 py-2 ...">${formatDate(req.DocDate)}</td>
                    <td class="px-4 py-2 ...">${formatDate(req.StartDate)}</td>
                `;
            });

            content.innerHTML = '';
            content.appendChild(table);
        }

    </script>

</body>
</html>
