<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WNY App ไปราชการ (Google Sheets)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .main-container { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 0.15s ease-in-out; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .form-label { font-weight: bold; color: #374151; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        fieldset { border-color: #e5e7eb; }
        legend { background-color: #f3f4f6; padding: 0.25rem 1rem; border-radius: 9999px; font-weight: 700; color: #4f46e5; font-size: 1.125rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: bold; padding: 0.6rem 1.25rem; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; border: none; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 0.75rem; }
        .nav-button.active { background-color: #e0e7ff; border: 2px solid #4f46e5; }
        .stat-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; }
        .stat-card h3 { font-size: 1.25rem; font-weight: 700; color: #111827; }
        .stat-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.2s; }
        .stat-item:hover { background-color: #eff6ff; }
        .stat-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <div id="login-screen" class="max-w-md mx-auto mt-10 p-8 rounded-2xl shadow-2xl main-container">
            <div class="text-center mb-8">
                <img src="https://www.wny.ac.th/wny/storage/2025/03/Branner-WNY-Thai.png" alt="Logo" class="mx-auto h-28 mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WNY App ไปราชการ</h1>
                <p class="text-gray-500 mt-2">กรุณาเข้าสู่ระบบเพื่อใช้งาน</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="form-label">ชื่อผู้ใช้ (Username)</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">รหัสผ่าน (Password)</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-full text-lg">
                    <div id="login-loader" class="loader hidden"></div>
                    <span id="login-button-text">เข้าสู่ระบบ</span>
                </button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
             <p class="text-center mt-4 text-sm text-gray-600">
                ยังไม่มีบัญชี? <button type="button" id="show-register-modal-button" class="font-semibold text-indigo-600 hover:text-indigo-500">สมัครใช้งานที่นี่</button>
            </p>
        </div>

        <div id="main-app" class="hidden">
            <header class="p-4 bg-white rounded-xl shadow-lg mb-6 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">ยินดีต้อนรับ, <span id="user-fullname"></span></h2>
                    <p class="text-sm text-gray-500">ตำแหน่ง: <span id="user-position"></span></p>
                </div>
                <button id="logout-button" class="btn btn-danger">ออกจากระบบ</button>
            </header>

            <div id="navigation" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 mb-6">
                <button data-target="dashboard-page" id="user-nav-dashboard" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition active">
                    <h3 class="font-bold text-indigo-700">แดชบอร์ด</h3>
                    <p class="text-xs text-gray-500">ภาพรวมของคุณ</p>
                </button>
                <button data-target="form-page" id="user-nav-form" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ร่างคำขอไปราชการ</h3>
                    <p class="text-xs text-gray-500">สร้างบันทึกข้อความ</p>
                </button>
                <button data-target="memo-page" id="user-nav-memo" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ส่งบันทึกข้อความ</h3>
                    <p class="text-xs text-gray-500">อัพโหลดไฟล์</p>
                </button>
                 <button data-target="command-generation-page" id="admin-nav-command" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-purple-700">จัดการคำสั่ง</h3>
                    <p class="text-xs text-gray-500">อนุมัติคำสั่งราชการ</p>
                </button>
                <button data-target="admin-memos-page" id="admin-nav-management" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการบันทึกข้อความ</h3>
                    <p class="text-xs text-gray-500">รายการที่ส่งแล้ว</p>
                </button>
                 <button data-target="stats-page" id="nav-stats" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-green-700">สถิติข้อมูล</h3>
                    <p class="text-xs text-gray-500">สรุปภาพรวม</p>
                </button>
                <button data-target="profile-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition">
                    <h3 class="font-bold text-indigo-700">ข้อมูลส่วนตัว</h3>
                    <p class="text-xs text-gray-500">จัดการข้อมูลของคุณ</p>
                </button>
                <button id="admin-nav-users" data-target="admin-users-page" class="nav-button p-4 text-center bg-white rounded-lg shadow hover:bg-indigo-50 transition hidden">
                    <h3 class="font-bold text-red-700">จัดการผู้ใช้</h3>
                    <p class="text-xs text-gray-500">ผู้ใช้ทั้งหมด</p>
                </button>
            </div>

            <main id="page-content" class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg">
                <div id="dashboard-page" class="page-view">
                    <h2 class="text-2xl font-bold mb-4">รายการคำขอไปราชการของฉัน</h2>
                    <input type="text" id="search-requests" class="form-input mb-4" placeholder="ค้นหาตามวัตถุประสงค์, สถานที่, เลขอ้างอิง...">
                    <div id="requests-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลคำขอ...</p>
                    </div>
                    <div id="requests-list" class="hidden"></div>
                    <p id="no-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบรายการคำขอของคุณ</p>
                </div>

                <div id="form-page" class="page-view hidden">
                     <form id="request-form">
                          <input type="hidden" id="form-request-id">
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ข้อมูลทั่วไป</legend>
                                <div><label for="form-doc-date" class="form-label">วันที่</label><input type="date" id="form-doc-date" class="form-input" required></div>
                          </fieldset>
                         <fieldset class="border p-4 rounded-lg mb-6"><legend>1. รายละเอียดการไปราชการ</legend>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                   <div><label for="form-requester-name" class="form-label">ชื่อ-นามสกุลผู้ขอ</label><input type="text" id="form-requester-name" class="form-input" required></div>
                                   <div><label for="form-requester-position" class="form-label">ตำแหน่ง</label><input type="text" id="form-requester-position" class="form-input" required></div>
                              </div>
                             <div class="mt-4"><label for="form-location" class="form-label">ขออนุญาตไปราชการ ณ สถานที่</label><input type="text" id="form-location" class="form-input" required></div>
                             <div class="mt-4"><label for="form-purpose" class="form-label">เพื่อ</label><textarea id="form-purpose" rows="2" class="form-input" required></textarea></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                   <div><label for="form-start-date" class="form-label">ตั้งแต่วันที่</label><input type="date" id="form-start-date" class="form-input" required></div>
                                   <div><label for="form-end-date" class="form-label">ถึงวันที่</label><input type="date" id="form-end-date" class="form-input" required></div>
                              </div>
                         </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>ผู้ร่วมเดินทาง (ถ้ามี)</legend>
                                <div id="form-attendees-list"></div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button type="button" id="form-add-attendee" class="btn btn-success w-full sm:w-auto"><span>+ เพิ่มผู้ร่วมเดินทาง</span></button>
                                    <button type="button" id="form-import-excel" class="btn btn-primary w-full sm:w-auto"><span>นำเข้าจาก Excel</span></button>
                                    <button type="button" id="form-download-template" class="btn bg-gray-500 text-white hover:bg-gray-600 w-full sm:w-auto"><span>ดาวน์โหลดแม่แบบ</span></button>
                                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                                </div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>2. การเบิกค่าใช้จ่าย</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="expense_no" name="expense_option" value="no" checked class="h-4 w-4"><label for="expense_no" class="ml-2">ไม่ขอเบิกค่าใช้จ่าย</label></div>
                                    <div><input type="radio" id="expense_partial" name="expense_option" value="partial" class="h-4 w-4"><label for="expense_partial" class="ml-2">ขอเบิกเฉพาะค่าใช้จ่าย</label></div>
                              </div>
                             <div id="partial-expense-options" class="pl-6 mt-3 hidden space-y-2">
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าเบี้ยเลี้ยง" data-item-name="ค่าเบี้ยเลี้ยง" class="rounded"> ค่าเบี้ยเลี้ยง</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าที่พัก" data-item-name="ค่าที่พัก" class="rounded"> ค่าที่พัก</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าพาหนะ" data-item-name="ค่าพาหนะ" class="rounded"> ค่าพาหนะ</label>
                                  <label class="block"><input type="checkbox" name="expense_item" value="ค่าน้ำมัน" data-item-name="ค่าน้ำมัน" class="rounded"> ค่าน้ำมัน</label>
                                  <div class="flex items-center gap-2"><label><input type="checkbox" name="expense_item" id="expense_other_check" data-item-name="ค่าใช้จ่ายอื่นๆ" class="rounded"> ค่าใช้จ่ายอื่นๆ</label><input type="text" id="expense_other_text" class="form-input text-sm p-1 flex-grow" placeholder="ระบุ"></div>
                             </div>
                             <div id="total-expense-container" class="mt-4 hidden"><label for="form-total-expense" class="form-label">รวมเป็นจำนวนเงิน (บาท)</label><input type="number" id="form-total-expense" class="form-input w-full md:w-1/2" placeholder="0.00" step="0.01"></div>
                          </fieldset>
                            <fieldset class="border p-4 rounded-lg mb-6"><legend>3. การเดินทาง</legend>
                                <div class="space-y-3">
                                    <div><input type="radio" id="vehicle_gov" name="vehicle_option" value="gov" checked class="h-4 w-4"><label for="vehicle_gov" class="ml-2">รถยนต์ราชการ (รถโรงเรียน)</label></div>
                                    <div><input type="radio" id="vehicle_private" name="vehicle_option" value="private" class="h-4 w-4"><label for="vehicle_private" class="ml-2">รถยนต์ส่วนตัว</label></div>
                                    <div id="private-vehicle-details" class="pl-8 mt-2 hidden"><label for="form-license-plate" class="form-label">หมายเลขทะเบียน</label><input type="text" id="form-license-plate" class="form-input w-full md:w-1/2"></div>
                                    <div><input type="radio" id="vehicle_public" name="vehicle_option" value="public" class="h-4 w-4"><label for="vehicle_public" class="ml-2">พาหนะอื่นๆ</label></div>
                              </div>
                         </fieldset>
                          <fieldset id="signer-fieldset" class="border p-4 rounded-lg mb-6"><legend>5. ข้อมูลผู้ลงนาม</legend>
                                <div class="mb-4">
                                    <label for="form-department" class="form-label">กลุ่มสาระฯ / งาน</label>
                                    <select id="form-department" class="form-input" required></select>
                                </div>
                                <div><label for="form-head-name" class="form-label">ชื่อหัวหน้ากลุ่มสาระ / หัวหน้างาน</label><input type="text" id="form-head-name" class="form-input bg-gray-200" readonly></div>
                         </fieldset>
                         <div class="text-center mt-10 border-t pt-6 border-gray-200">
                              <button type="submit" id="submit-request-button" class="btn btn-primary w-full sm:w-auto text-lg">
                                <div id="submit-loader" class="loader hidden"></div>
                                <span id="submit-button-text">บันทึกและสร้างเอกสาร</span>
                             </button>
                         </div>
                    </form>
                      <div id="form-result" class="hidden mt-6 p-6 text-center">
                          <h3 id="form-result-title" class="font-bold text-lg"></h3>
                          <p id="form-result-message" class="mt-2 text-gray-700"></p>
                            <div class="flex justify-center flex-wrap gap-4 mt-4">
                                <a id="form-result-link" href="#" target="_blank" class="btn btn-success">เปิดไฟล์ PDF</a>
                                <button type="button" id="go-to-memo-page-button" class="btn btn-primary">ไปที่หน้าส่งบันทึกข้อความ</button>
                             </div>
                      </div>
                </div>

                <div id="memo-page" class="page-view hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl font-bold mb-4">ส่งบันทึกข้อความใหม่</h2>
                            <form id="memo-form">
                                <fieldset class="border p-4 rounded-lg bg-white">
                                    <legend>อัพโหลดไฟล์และกรอกข้อมูล</legend>
                                     <div class="mb-4">
                                        <label class="form-label">ประเภทการส่ง</label>
                                        <div class="flex gap-4 mt-2">
                                            <div><input type="radio" id="memo-type-no-reimburse" name="memo_type" value="no_reimburse" checked><label for="memo-type-no-reimburse" class="ml-2">ไม่เบิก (แนบไฟล์)</label></div>
                                            <div><input type="radio" id="memo-type-reimburse" name="memo_type" value="reimburse"><label for="memo-type-reimburse" class="ml-2">เบิก (ไม่ต้องแนบไฟล์)</label></div>
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="memo-ref-number" class="form-label">เลือกร่างคำขอ (เลขที่อ้างอิง)</label>
                                        <select id="memo-ref-number" class="form-input" required></select>
                                    </div>
                                     <div id="memo-file-container" class="mb-6"><label for="memo-file" class="form-label">ไฟล์บันทึกข้อความ (PDF เท่านั้น)</label><input type="file" id="memo-file" class="form-input" accept="application/pdf" required><span id="memo-filename" class="text-sm text-gray-500 mt-1 block"></span></div>
                                    <button type="submit" id="submit-memo-button" class="btn btn-primary w-full"><div id="memo-submit-loader" class="loader hidden"></div><span id="memo-submit-button-text">ส่งบันทึกข้อความ</span></button>
                                </fieldset>
                            </form>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold mb-4">รายการที่ส่งแล้ว</h2>
                            <div id="memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                            <div id="memos-list" class="hidden space-y-3"></div>
                            <p id="no-memos-message" class="text-center text-gray-500 p-8 hidden">ยังไม่มีรายการที่ส่ง</p>
                        </div>
                    </div>
                </div>

                <div id="profile-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">ข้อมูลส่วนตัว</h2>
                      <form id="profile-form">
                         <div class="mb-4"><label for="profile-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="profile-username" class="form-input bg-gray-200" readonly></div>
                          <div class="mb-4"><label for="profile-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="profile-fullname" class="form-input" required></div>
                          <div class="mb-4"><label for="profile-position" class="form-label">ตำแหน่ง</label><input type="text" id="profile-position" class="form-input" required></div>
                        <div class="mb-6"><label for="profile-department" class="form-label">กลุ่มสาระการเรียนรู้/กลุ่มงาน</label><input type="text" id="profile-department" class="form-input" required></div>
                        <button type="submit" id="save-profile-button" class="btn btn-primary"><div id="profile-loader" class="loader hidden"></div><span id="profile-button-text">บันทึกข้อมูล</span></button>
                          <p id="profile-message" class="text-green-600 mt-4 hidden"></p>
                    </form>
                    
                    <h2 class="text-2xl font-bold mb-4 mt-10 border-t pt-6">เปลี่ยนรหัสผ่าน</h2>
                    <form id="password-form">
                        <div class="mb-4 relative">
                            <label for="profile-current-password" class="form-label">รหัสผ่านปัจจุบัน</label>
                            <input type="password" id="profile-current-password" class="form-input" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="profile-new-password" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" id="profile-new-password" class="form-input" required>
                        </div>
                        <div class="mb-6 relative">
                            <label for="profile-confirm-password" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                            <input type="password" id="profile-confirm-password" class="form-input" required>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-password-toggle" class="form-checkbox h-5 w-5 text-indigo-600">
                                <span class="ml-2 text-gray-700">แสดงรหัสผ่าน</span>
                            </label>
                        </div>
                        <button type="submit" id="save-password-button" class="btn btn-primary">
                            <div id="password-loader" class="loader hidden"></div>
                            <span id="password-button-text">เปลี่ยนรหัสผ่าน</span>
                        </button>
                        <p id="password-message" class="text-green-600 mt-4 hidden"></p>
                        <p id="password-error" class="text-red-500 mt-4 hidden"></p>
                    </form>
                </div>
                
                <div id="admin-users-page" class="page-view hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-2xl font-bold">จัดการผู้ใช้งาน</h2>
                        <div class="flex gap-2">
                             <button id="import-users-button" class="btn btn-primary">นำเข้าจาก Excel</button>
                             <button id="download-user-template-button" class="btn bg-gray-500 text-white hover:bg-gray-600">ดาวน์โหลดแม่แบบ</button>
                             <button id="add-user-button" class="btn btn-success">เพิ่มผู้ใช้ใหม่</button>
                             <input type="file" id="user-excel-input" class="hidden" accept=".xlsx, .xls">
                        </div>
                    </div>
                    <div id="admin-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูลผู้ใช้...</p></div>
                    <div id="admin-users-list" class="hidden overflow-x-auto"></div>
                </div>

                 <div id="admin-memos-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการบันทึกข้อความที่ส่งแล้ว</h2>
                    <div id="admin-memos-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดข้อมูล...</p></div>
                    <div id="admin-memos-list" class="hidden overflow-x-auto"></div>
                    <p id="no-admin-memos-message" class="text-center text-gray-500 p-8 hidden">ไม่พบบันทึกข้อความ</p>
                </div>

                <div id="command-generation-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-4">จัดการและอนุมัติคำสั่งไปราชการ</h2>
                    <div id="command-requests-loader" class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">กำลังโหลดคำขอทั้งหมด...</p></div>
                    <div id="command-requests-list" class="hidden overflow-x-auto"></div>
                    <p id="no-command-requests-message" class="text-center text-gray-500 p-8 hidden">ไม่พบคำขอที่ต้องอนุมัติ</p>
                </div>
                
                <div id="stats-page" class="page-view hidden">
                    <h2 class="text-2xl font-bold mb-6">สรุปสถิติข้อมูลทั้งหมด</h2>
                    <div id="stats-loader" class="text-center p-8">
                        <div class="loader mx-auto"></div>
                        <p class="mt-4">กำลังประมวลผลข้อมูลสถิติ...</p>
                    </div>
                    <div id="stats-content" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                        <div id="stats-by-user" class="stat-card"></div>
                        <div id="stats-by-department" class="stat-card"></div>
                        <div id="stats-by-year" class="stat-card"></div>
                        <div id="stats-by-expense" class="stat-card"></div>
                    </div>
                </div>
            </main>
        </div>
        <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
            <p>พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">สมัครใช้งานใหม่</h3>
            <form id="register-form">
                <div class="mb-4"><label for="register-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="register-username" class="form-input" required></div>
                 <div class="mb-4"><label for="register-password" class="form-label">รหัสผ่าน (Password)</label><input type="password" id="register-password" class="form-input" required></div>
                 <div class="mb-4"><label for="register-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="register-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="register-position" class="form-label">ตำแหน่ง</label><input type="text" id="register-position" class="form-input" required></div>
                 <div class="mb-4"><label for="register-department" class="form-label">กลุ่มสาระการเรียนรู้</label><input type="text" id="register-department" class="form-input" required></div>
                <p id="register-error" class="text-red-500 mb-4 hidden"></p>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="register-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="register-save-button" class="btn btn-primary"><div id="register-loader" class="loader hidden"></div><span id="register-button-text">สมัครใช้งาน</span></button></div>
            </form>
        </div>
    </div>
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h3 id="admin-modal-title" class="text-xl font-bold mb-4">เพิ่มผู้ใช้ใหม่</h3>
            <form id="admin-modal-form">
                <input type="hidden" id="modal-original-username">
                <div class="mb-4"><label for="modal-username" class="form-label">ชื่อผู้ใช้ (Username)</label><input type="text" id="modal-username" class="form-input" required></div>
                <div class="mb-4"><label for="modal-password" class="form-label">รหัสผ่าน (เว้นว่างไว้หากไม่ต้องการเปลี่ยน)</label><input type="password" id="modal-password" class="form-input" placeholder="รหัสผ่านใหม่"></div>
                 <div class="mb-4"><label for="modal-fullname" class="form-label">ชื่อ-นามสกุล</label><input type="text" id="modal-fullname" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-position" class="form-label">ตำแหน่ง</label><input type="text" id="modal-position" class="form-input" required></div>
                 <div class="mb-4"><label for="modal-department" class="form-label">กลุ่มสาระฯ/งาน</label><input type="text" id="modal-department" class="form-input" required></div>
                 <div class="mb-4">
                    <label for="modal-role" class="form-label">สิทธิ์</label>
                    <select id="modal-role" class="form-input"><option value="user">User</option><option value="admin">Admin</option></select>
                </div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="admin-modal-close-button" class="btn bg-gray-300">ยกเลิก</button><button type="submit" id="admin-modal-save-button" class="btn btn-primary"><div id="admin-modal-loader" class="loader hidden"></div><span id="admin-modal-button-text">บันทึก</span></button></div>
            </form>
        </div>
    </div>
    <div id="alert-modal" class="modal"><div class="modal-content text-center"><h3 id="alert-modal-title" class="text-xl font-bold mb-4"></h3><p id="alert-modal-message" class="mb-6"></p><button id="alert-modal-close-button" class="btn btn-primary">ตกลง</button></div></div>
    <div id="confirm-modal" class="modal"><div class="modal-content text-center"><h3 id="confirm-modal-title" class="text-xl font-bold mb-4"></h3><p id="confirm-modal-message" class="mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-modal-no-button" class="btn bg-gray-300">ยกเลิก</button><button id="confirm-modal-yes-button" class="btn btn-danger">ยืนยัน</button></div></div></div>
    
    <div id="command-approval-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">เลือกรูปแบบคำสั่งเพื่ออนุมัติ</h3>
            <form id="command-approval-form">
                <input type="hidden" id="approval-request-id">
                <p class="mb-4">กรุณาเลือกรูปแบบคำสั่งที่ถูกต้องตามจำนวนผู้เดินทาง</p>
                <div class="space-y-2">
                    <div><input type="radio" id="template-solo" name="templateType" value="solo" required><label for="template-solo" class="ml-2">เดินทาง 1 คน</label></div>
                    <div><input type="radio" id="template-small" name="templateType" value="groupSmall"><label for="template-small" class="ml-2">เดินทาง 2-5 คน</label></div>
                    <div><input type="radio" id="template-large" name="templateType" value="groupLarge"><label for="template-large" class="ml-2">เดินทาง 6 คนขึ้นไป</label></div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="command-approval-modal-close-button">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary">ยืนยันและอนุมัติ</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="admin-memo-action-modal" class="modal">
        <div class="modal-content">
             <h3 class="text-xl font-bold mb-4">จัดการไฟล์ที่เสร็จสมบูรณ์</h3>
             <form id="admin-memo-action-form">
                <input type="hidden" id="action-memo-id">
                <p class="mb-4">อัปโหลดไฟล์ที่ผ่านการอนุมัติและลงนามเรียบร้อยแล้ว</p>
                <div class="mb-3">
                    <label for="completed-memo-file" class="form-label">ไฟล์บันทึกข้อความ (ฉบับสมบูรณ์)</label>
                    <input type="file" id="completed-memo-file" class="form-input" accept="application/pdf">
                </div>
                 <div class="mb-3">
                    <label for="completed-command-file" class="form-label">ไฟล์คำสั่ง (ฉบับสมบูรณ์)</label>
                    <input type="file" id="completed-command-file" class="form-input" accept="application/pdf">
                </div>
                <div class="mb-6">
                    <label for="dispatch-book-file" class="form-label">หนังสือส่ง (ถ้ามี)</label>
                    <input type="file" id="dispatch-book-file" class="form-input" accept="application/pdf">
                </div>
                 <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="btn bg-gray-300" id="admin-memo-action-modal-close-button">ยกเลิก</button>
                    <button type="submit" class="btn btn-success">เสร็จสิ้นและส่งไฟล์</button>
                </div>
             </form>
        </div>
    </div>
    
    <div id="stats-detail-modal" class="modal">
        <div class="modal-content">
            <h3 id="stats-detail-title" class="text-xl font-bold mb-4"></h3>
            <div id="stats-detail-content" class="max-h-[60vh] overflow-y-auto"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" class="btn bg-gray-300" id="stats-detail-modal-close-button">ปิด</button>
            </div>
        </div>
    </div>


    <script>
        // Use the Google Apps Script URL provided by the user
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvi_gK-fITm3N74_-qrRI9t4oNkGBW2d02fo6a0j622nZpR1qq8aMhjroGSG-Oyp_Ryg/exec";

        // Global State
        let allRequestsCache = [];
        let allMemosCache = [];
        let allUsersCache = [];
        let specialPositionMap = {};


        // --- API HELPER FUNCTIONS ---
        
        async function apiCall(method, action, payload = {}) {
            let url = SCRIPT_URL;
            const options = {
                method: method,
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8', },
            };

            if (method === 'GET') {
                const params = new URLSearchParams({ action, ...payload });
                url += `?${params}`;
            } else {
                options.body = JSON.stringify({ action, payload });
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ', error.message);
                throw error;
            }
        }
        
        // --- UTILITY FUNCTIONS ---
        
        function showAlert(title, message) {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal').style.display = 'flex';
        }
        
        function showConfirm(title, message) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            document.getElementById('confirm-modal').style.display = 'flex';

            return new Promise((resolve) => {
                const yesButton = document.getElementById('confirm-modal-yes-button');
                const noButton = document.getElementById('confirm-modal-no-button');
                const onYes = () => { cleanup(); resolve(true); };
                const onNo = () => { cleanup(); resolve(false); };
                
                const cleanup = () => {
                    document.getElementById('confirm-modal').style.display = 'none';
                    yesButton.removeEventListener('click', onYes);
                    noButton.removeEventListener('click', onNo);
                };

                yesButton.addEventListener('click', onYes, { once: true });
                noButton.addEventListener('click', onNo, { once: true });
            });
        }
        
        function toggleLoader(buttonId, show) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            const loader = button.querySelector('.loader');
            const text = button.querySelector('span');
            
            if (show) {
                if (loader) loader.classList.remove('hidden');
                if (text) text.classList.add('hidden');
                button.disabled = true;
            } else {
                if (loader) loader.classList.add('hidden');
                if (text) text.classList.remove('hidden');
                button.disabled = false;
            }
        }
        
        function getCurrentUser() {
            const userJson = sessionStorage.getItem('currentUser');
            return userJson ? JSON.parse(userJson) : null;
        }

        function fileToObject(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const data = reader.result.toString().split(',')[1];
                    resolve({ filename: file.name, mimeType: file.type, data: data });
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // --- PAGE NAVIGATION ---
        
        async function switchPage(targetPageId) {
            document.querySelectorAll('.page-view').forEach(page => page.classList.add('hidden'));
            document.getElementById(targetPageId)?.classList.remove('hidden');

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.target === targetPageId) {
                    btn.classList.add('active');
                }
            });

            if (targetPageId === 'form-page') await resetRequestForm();
            if (targetPageId === 'dashboard-page') await fetchUserRequests();
            if (targetPageId === 'memo-page') await fetchUserMemos();
            if (targetPageId === 'profile-page') loadProfileData();
            if (targetPageId === 'stats-page') await loadStatsData();
            if (targetPageId === 'admin-users-page') await fetchAllUsers();
            if (targetPageId === 'admin-memos-page') await fetchAllMemos();
            if (targetPageId === 'command-generation-page') await fetchAllRequestsForCommand();
        }

        // --- MAIN APP LOGIC ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log('App Initializing with Google Sheets Backend...');
            setupEventListeners();
            const user = getCurrentUser();
            if (user) {
                initializeUserSession(user);
            } else {
                showLoginScreen();
            }
        });

        // --- INITIALIZATION ---
        
        function initializeUserSession(user) {
            updateUIForUser(user);
            showMainApp();
            switchPage('dashboard-page');
        }

        function updateUIForUser(user) {
            document.getElementById('user-fullname').textContent = user.fullName || 'N/A';
            document.getElementById('user-position').textContent = user.position || 'N/A';

            const isAdmin = user.role === 'admin';
            document.getElementById('admin-nav-command').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-nav-management').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-nav-users').classList.toggle('hidden', !isAdmin);
        }
        
        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }
        
        function showLoginScreen() {
            sessionStorage.removeItem('currentUser');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // --- EVENT LISTENER SETUP ---
        
        function setupEventListeners() {
            // Auth
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', showLoginScreen);
            document.getElementById('show-register-modal-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'flex');
            document.getElementById('register-form').addEventListener('submit', handleRegister);

            // Navigation
            document.getElementById('navigation').addEventListener('click', (e) => {
                const navButton = e.target.closest('.nav-button');
                if (navButton && navButton.dataset.target) {
                    switchPage(navButton.dataset.target);
                }
            });
            document.getElementById('go-to-memo-page-button').addEventListener('click', () => switchPage('memo-page'));

            // Modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            });
            document.getElementById('register-modal-close-button').addEventListener('click', () => document.getElementById('register-modal').style.display = 'none');
            document.getElementById('admin-modal-close-button').addEventListener('click', () => document.getElementById('admin-modal').style.display = 'none');
            document.getElementById('alert-modal-close-button').addEventListener('click', () => document.getElementById('alert-modal').style.display = 'none');
            document.getElementById('command-approval-modal-close-button').addEventListener('click', () => document.getElementById('command-approval-modal').style.display = 'none');
            document.getElementById('admin-memo-action-modal-close-button').addEventListener('click', () => document.getElementById('admin-memo-action-modal').style.display = 'none');
            document.getElementById('stats-detail-modal-close-button').addEventListener('click', () => document.getElementById('stats-detail-modal').style.display = 'none');

            // Forms
            document.getElementById('request-form').addEventListener('submit', handleRequestFormSubmit);
            document.getElementById('form-add-attendee').addEventListener('click', () => addAttendeeField());
            document.getElementById('form-import-excel').addEventListener('click', () => document.getElementById('excel-file-input').click());
            document.getElementById('excel-file-input').addEventListener('change', handleExcelImport);
            document.getElementById('form-download-template').addEventListener('click', downloadAttendeeTemplate);
            document.querySelectorAll('input[name="expense_option"]').forEach(radio => radio.addEventListener('change', toggleExpenseOptions));
            document.querySelectorAll('input[name="vehicle_option"]').forEach(radio => radio.addEventListener('change', toggleVehicleOptions));
            document.getElementById('memo-form').addEventListener('submit', handleMemoSubmit);
            document.querySelectorAll('input[name="memo_type"]').forEach(radio => radio.addEventListener('change', (e) => {
                const fileContainer = document.getElementById('memo-file-container');
                const fileInput = document.getElementById('memo-file');
                const isReimburse = e.target.value === 'reimburse';
                fileContainer.classList.toggle('hidden', isReimburse);
                fileInput.required = !isReimburse;
            }));

            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
            document.getElementById('password-form').addEventListener('submit', handlePasswordUpdate);
            document.getElementById('show-password-toggle').addEventListener('change', togglePasswordVisibility);
            document.getElementById('command-approval-form').addEventListener('submit', handleCommandApproval);
            document.getElementById('admin-memo-action-form').addEventListener('submit', handleAdminMemoActionSubmit);
            document.getElementById('form-department').addEventListener('change', (e) => {
                const selectedPosition = e.target.value;
                const headNameInput = document.getElementById('form-head-name');
                headNameInput.value = specialPositionMap[selectedPosition] || '';
            });
            
            // Search
            document.getElementById('search-requests').addEventListener('input', (e) => renderRequestsList(allRequestsCache, e.target.value));

            // Admin
            document.getElementById('add-user-button').addEventListener('click', openAddUserModal);
            document.getElementById('admin-modal-form').addEventListener('submit', handleAdminUserSave);
            document.getElementById('download-user-template-button').addEventListener('click', downloadUserTemplate);
            document.getElementById('import-users-button').addEventListener('click', () => document.getElementById('user-excel-input').click());
            document.getElementById('user-excel-input').addEventListener('change', handleUserImport);
        }
        
        // --- AUTHENTICATION HANDLERS ---
        
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.classList.add('hidden');
            toggleLoader('login-button', true);

            try {
                const result = await apiCall('POST', 'verifyCredentials', { username, password });
                sessionStorage.setItem('currentUser', JSON.stringify(result.user));
                initializeUserSession(result.user);
            } catch (error) {
                errorP.textContent = error.message;
                errorP.classList.remove('hidden');
            } finally {
                toggleLoader('login-button', false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const payload = {
                username: document.getElementById('register-username').value.trim(),
                password: document.getElementById('register-password').value,
                fullName: document.getElementById('register-fullname').value.trim(),
                position: document.getElementById('register-position').value.trim(),
                department: document.getElementById('register-department').value.trim(),
                role: 'user'
            };
            const errorP = document.getElementById('register-error');
            errorP.classList.add('hidden');
            
            if (payload.password.length < 6) {
                errorP.textContent = "รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร";
                errorP.classList.remove('hidden');
                return;
            }

            toggleLoader('register-save-button', true);
            
            try {
                const result = await apiCall('POST', 'registerUser', payload);
                document.getElementById('register-modal').style.display = 'none';
                e.target.reset();
                showAlert("สมัครสำเร็จ", result.message);
            } catch (error) {
                errorP.textContent = error.message;
                errorP.classList.remove('hidden');
            } finally {
                toggleLoader('register-save-button', false);
            }
        }
        
        // --- DATA FETCHING & RENDERING (USER) ---
        
        async function fetchUserRequests() {
            const user = getCurrentUser();
            if (!user) return;
            const loader = document.getElementById('requests-loader');
            const list = document.getElementById('requests-list');
            loader.classList.remove('hidden');
            list.classList.add('hidden');

            try {
                const result = await apiCall('GET', 'getUserRequests', { username: user.username });
                allRequestsCache = result.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) || [];
                renderRequestsList(allRequestsCache);
            } catch (error) {
                console.error("Error fetching user requests:", error);
                document.getElementById('no-requests-message').classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        function renderRequestsList(requests, searchTerm = '') {
            const listContainer = document.getElementById('requests-list');
            const noDataMsg = document.getElementById('no-requests-message');
            listContainer.innerHTML = '';

            let filteredRequests = requests;
            if (searchTerm) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                filteredRequests = requests.filter(req => 
                    req.purpose?.toLowerCase().includes(lowerCaseSearch) ||
                    req.location?.toLowerCase().includes(lowerCaseSearch) ||
                    req.id?.toLowerCase().includes(lowerCaseSearch)
                );
            }
            
            if (filteredRequests.length === 0) {
                noDataMsg.classList.remove('hidden');
                listContainer.classList.add('hidden');
            } else {
                noDataMsg.classList.add('hidden');
                const list = document.createElement('div');
                list.className = 'space-y-4';
                filteredRequests.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'p-4 border rounded-lg shadow-sm hover:shadow-md transition bg-white';
                    card.innerHTML = `
                        <div class="flex flex-wrap justify-between items-start gap-2">
                            <div>
                                <h4 class="font-bold text-lg text-indigo-700">${req.purpose}</h4>
                                <p class="text-sm text-gray-600"><strong>สถานที่:</strong> ${req.location}</p>
                                <p class="text-xs text-gray-400 mt-1"><strong>ID:</strong> ${req.id}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold px-2 py-1 rounded-full bg-blue-100 text-blue-800">${req.status || 'N/A'}</span>
                                <p class="text-xs text-gray-500 mt-1">${req.commandStatus || ''}</p>
                            </div>
                        </div>
                        <div class="border-t mt-3 pt-3 flex flex-wrap gap-2 justify-end">
                            ${req.pdfUrl ? `<a href="${req.pdfUrl}" target="_blank" class="btn btn-sm btn-success">ดูบันทึกข้อความ</a>` : ''}
                            ${req.commandPdfUrl ? `<a href="${req.commandPdfUrl}" target="_blank" class="btn btn-sm btn-primary">ดูคำสั่ง</a>` : ''}
                            <button class="btn text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900" data-id="${req.id}" data-action="edit">แก้ไข</button>
                            <button class="btn text-sm btn-danger" data-id="${req.id}" data-action="delete">ลบ</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
                listContainer.innerHTML = '';
                listContainer.appendChild(list);
                listContainer.addEventListener('click', handleRequestAction);
                listContainer.classList.remove('hidden');
            }
        }
        
        async function handleRequestAction(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const requestId = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'edit') {
                await editRequest(requestId);
            } else if (action === 'delete') {
                const confirmed = await showConfirm("ยืนยันการลบ", "คุณต้องการลบรายการคำขอนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้");
                if (confirmed) {
                    try {
                       await apiCall('POST', 'deleteRequest', { id: requestId });
                       showAlert("ลบสำเร็จ", "รายการคำขอถูกลบเรียบร้อยแล้ว");
                       await fetchUserRequests(); // Refresh list
                    } catch(error) {
                        showAlert("เกิดข้อผิดพลาด", "ไม่สามารถลบรายการได้: " + error.message);
                    }
                }
            }
        }
        
        async function editRequest(requestId) {
            const requestData = allRequestsCache.find(r => r.id === requestId);
            if (!requestData) {
                showAlert("ผิดพลาด", "ไม่พบข้อมูลคำขอ");
                return;
            }
            
            try {
                const attendeesResult = await apiCall('GET', 'getAttendeesForRequest', { requestId });
                const attendees = attendeesResult.data;
                
                await resetRequestForm();
                document.getElementById('form-request-id').value = requestId;
                document.getElementById('form-doc-date').value = new Date(requestData.docDate).toISOString().split('T')[0];
                document.getElementById('form-requester-name').value = requestData.requesterName;
                document.getElementById('form-requester-position').value = requestData.requesterPosition;
                document.getElementById('form-location').value = requestData.location;
                document.getElementById('form-purpose').value = requestData.purpose;
                document.getElementById('form-start-date').value = new Date(requestData.startDate).toISOString().split('T')[0];
                document.getElementById('form-end-date').value = new Date(requestData.endDate).toISOString().split('T')[0];
                
                attendees.forEach(att => addAttendeeField(att.name, att.position));
                
                document.querySelector(`input[name="expense_option"][value="${requestData.expenseOption}"]`).checked = true;
                toggleExpenseOptions();
                if(requestData.expenseOption === 'partial') {
                    const expenseItems = JSON.parse(requestData.expenseItems || '[]');
                    expenseItems.forEach(item => {
                        const chk = document.querySelector(`input[data-item-name="${item.name}"]`);
                        if(chk) {
                            chk.checked = true;
                            if(item.name === 'ค่าใช้จ่ายอื่นๆ') {
                               document.getElementById('expense_other_text').value = item.detail;
                            }
                        }
                    });
                   document.getElementById('form-total-expense').value = requestData.totalExpense;
                }
                document.querySelector(`input[name="vehicle_option"][value="${requestData.vehicleOption}"]`).checked = true;
                toggleVehicleOptions();
                if (requestData.vehicleOption === 'private') {
                    document.getElementById('form-license-plate').value = requestData.licensePlate;
                }
                
                const departmentSelect = document.getElementById('form-department');
                departmentSelect.value = requestData.department;
                departmentSelect.dispatchEvent(new Event('change')); // Trigger change to update head name

                document.getElementById('submit-button-text').textContent = 'อัปเดตและสร้างเอกสารใหม่';
                switchPage('form-page');

            } catch(error) {
                 showAlert("ผิดพลาด", "ไม่สามารถโหลดข้อมูลผู้ร่วมเดินทางได้: " + error.message);
            }
        }
       
        // --- FORM HANDLING ---

        async function resetRequestForm() {
            const user = getCurrentUser();
            document.getElementById('request-form').reset();
            document.getElementById('form-request-id').value = '';
            document.getElementById('form-attendees-list').innerHTML = '';
            document.getElementById('form-doc-date').valueAsDate = new Date();
            document.getElementById('form-requester-name').value = user.fullName;
            document.getElementById('form-requester-position').value = user.position;
            
            await populateDepartmentDropdownFromUsers();
            const departmentSelect = document.getElementById('form-department');
            if (user.department && Array.from(departmentSelect.options).some(opt => opt.value === user.department)) {
                departmentSelect.value = user.department;
            }
            departmentSelect.dispatchEvent(new Event('change'));

            toggleExpenseOptions();
            toggleVehicleOptions();
            document.getElementById('form-result').classList.add('hidden');
            document.getElementById('submit-button-text').textContent = 'บันทึกและสร้างเอกสาร';
        }
        
        function addAttendeeField(name = '', position = '') {
            const list = document.getElementById('form-attendees-list');
            const attendeeDiv = document.createElement('div');
            attendeeDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center mb-2';
            attendeeDiv.innerHTML = `
                <input type="text" class="form-input attendee-name md:col-span-1" placeholder="ชื่อ-นามสกุล" required>
                <div class="attendee-position-wrapper md:col-span-1">
                     <select class="form-input attendee-position-select">
                        <option value="">-- เลือกตำแหน่ง --</option>
                        <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                        <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                        <option value="ครู">ครู</option>
                        <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                        <option value="พนักงานราชการ">พนักงานราชการ</option>
                        <option value="ครูอัตราจ้าง">ครูอัตราจ้าง</option>
                        <option value="พนักงานขับรถ">พนักงานขับรถ</option>
                        <option value="นักเรียน">นักเรียน</option>
                        <option value="other">อื่นๆ (โปรดระบุ)</option>
                    </select>
                    <input type="text" class="form-input attendee-position-other hidden mt-1" placeholder="ระบุตำแหน่ง">
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">ลบ</button>
            `;
            list.appendChild(attendeeDiv);
            
            const nameInput = attendeeDiv.querySelector('.attendee-name');
            const select = attendeeDiv.querySelector('.attendee-position-select');
            const otherInput = attendeeDiv.querySelector('.attendee-position-other');

            nameInput.value = name;
            
            const optionExists = Array.from(select.options).some(opt => opt.value === position);
            if (optionExists) {
                select.value = position;
            } else if (position) {
                select.value = 'other';
                otherInput.value = position;
                otherInput.classList.remove('hidden');
            }

            select.addEventListener('change', () => {
                otherInput.classList.toggle('hidden', select.value !== 'other');
            });
        }
        
        async function handleRequestFormSubmit(e) {
            e.preventDefault();
            toggleLoader('submit-request-button', true);

            const expenseItems = [];
            if (document.querySelector('input[name="expense_option"]:checked').value === 'partial') {
                document.querySelectorAll('input[name="expense_item"]:checked').forEach(chk => {
                    const item = { name: chk.dataset.itemName };
                    if (item.name === 'ค่าใช้จ่ายอื่นๆ') {
                        item.detail = document.getElementById('expense_other_text').value.trim();
                    }
                    expenseItems.push(item);
                });
            }

            const payload = {
                id: document.getElementById('form-request-id').value || null,
                username: getCurrentUser().username,
                docDate: document.getElementById('form-doc-date').value,
                requesterName: document.getElementById('form-requester-name').value.trim(),
                requesterPosition: document.getElementById('form-requester-position').value.trim(),
                location: document.getElementById('form-location').value.trim(),
                purpose: document.getElementById('form-purpose').value.trim(),
                startDate: document.getElementById('form-start-date').value,
                endDate: document.getElementById('form-end-date').value,
                attendees: Array.from(document.querySelectorAll('#form-attendees-list > div')).map(div => {
                    const select = div.querySelector('.attendee-position-select');
                    let position = select.value;
                    if (position === 'other') {
                        position = div.querySelector('.attendee-position-other').value.trim();
                    }
                    return {
                        name: div.querySelector('.attendee-name').value.trim(),
                        position: position
                    };
                }),
                expenseOption: document.querySelector('input[name="expense_option"]:checked').value,
                expenseItems: expenseItems,
                totalExpense: document.getElementById('form-total-expense').value || 0,
                vehicleOption: document.querySelector('input[name="vehicle_option"]:checked').value,
                licensePlate: document.getElementById('form-license-plate').value.trim(),
                department: document.getElementById('form-department').value,
                headName: document.getElementById('form-head-name').value,
            };

            try {
                const result = await apiCall('POST', 'createRequest', payload);
                
                document.getElementById('form-result-title').textContent = 'สร้างเอกสารสำเร็จ!';
                document.getElementById('form-result-message').textContent = `บันทึกข้อความสำหรับ ID ${result.data.id} ถูกสร้างแล้ว`;
                document.getElementById('form-result-link').href = result.data.pdfUrl;
                document.getElementById('form-result').classList.remove('hidden');
                
                await fetchUserRequests();
            } catch (error) {
                showAlert("เกิดข้อผิดพลาด", "ไม่สามารถบันทึกข้อมูลได้: " + error.message);
            } finally {
                toggleLoader('submit-request-button', false);
            }
        }

        async function populateDepartmentDropdownFromUsers() {
            const select = document.getElementById('form-department');
            // Do not return if already populated, to ensure it's always fresh
            
            try {
                const result = await apiCall('GET', 'getAllUsers');
                const users = result.data || [];
                specialPositionMap = {};
                const specialPositions = new Set();

                users.forEach(user => {
                    if (user.specialPosition && user.specialPosition.trim() !== '') {
                        const pos = user.specialPosition.trim();
                        specialPositions.add(pos);
                        if (!specialPositionMap[pos]) {
                            specialPositionMap[pos] = user.fullName;
                        }
                    }
                });

                select.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
                specialPositions.forEach(pos => {
                    const option = document.createElement('option');
                    option.value = pos;
                    option.textContent = pos;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error("Error populating departments from users:", error);
            }
        }
        
        function toggleExpenseOptions() {
            const partialOptions = document.getElementById('partial-expense-options');
            const totalContainer = document.getElementById('total-expense-container');
            if (document.getElementById('expense_partial').checked) {
                partialOptions.classList.remove('hidden');
                totalContainer.classList.remove('hidden');
            } else {
                partialOptions.classList.add('hidden');
                totalContainer.classList.add('hidden');
            }
        }
        
        function toggleVehicleOptions() {
            const privateDetails = document.getElementById('private-vehicle-details');
            if (document.getElementById('vehicle_private').checked) {
                privateDetails.classList.remove('hidden');
            } else {
                privateDetails.classList.add('hidden');
            }
        }

        function handleExcelImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                json.forEach(row => {
                    const name = row['ชื่อ-นามสกุล'] || row['FullName'];
                    const position = row['ตำแหน่ง'] || row['Position'];
                    if (name && position) addAttendeeField(name, position);
                });
                showAlert("นำเข้าสำเร็จ", `เพิ่มผู้ร่วมเดินทางจำนวน ${json.length} คนเรียบร้อยแล้ว`);
            };
            reader.readAsArrayBuffer(file);
        }
        
        function downloadAttendeeTemplate() {
            const data = [{ "ชื่อ-นามสกุล": "นายสมชาย ใจดี", "ตำแหน่ง": "ครู" }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendees");
            XLSX.writeFile(wb, "attendee_template.xlsx");
        }
        
        function togglePasswordVisibility() {
            const isChecked = document.getElementById('show-password-toggle').checked;
            const type = isChecked ? 'text' : 'password';
            document.getElementById('profile-current-password').type = type;
            document.getElementById('profile-new-password').type = type;
            document.getElementById('profile-confirm-password').type = type;
        }

        // --- MEMO FUNCTIONS ---
        async function fetchUserMemos() {
            const user = getCurrentUser();
            if (!user) return;
            document.getElementById('memos-loader').classList.remove('hidden');
            document.getElementById('memos-list').classList.add('hidden');
            try {
                const result = await apiCall('GET', 'getSentMemos', { username: user.username });
                const memos = result.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) || [];
                renderUserMemosList(memos);
                await populateMemoRefDropdown();
            } catch (error) {
                 document.getElementById('no-memos-message').classList.remove('hidden');
            } finally {
                 document.getElementById('memos-loader').classList.add('hidden');
            }
        }

        function renderUserMemosList(memos) {
            const listContainer = document.getElementById('memos-list');
            const noDataMsg = document.getElementById('no-memos-message');
            listContainer.innerHTML = '';
            if (memos.length === 0) {
                noDataMsg.classList.remove('hidden');
                listContainer.classList.add('hidden');
            } else {
                noDataMsg.classList.add('hidden');
                memos.forEach(memo => {
                    const card = document.createElement('div');
                    card.className = 'p-3 border rounded-md bg-gray-50';
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold">${memo.refNumber}</p>
                            <span class="text-xs font-bold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">${memo.status}</span>
                        </div>
                        <div class="mt-2 text-right">
                           ${memo.fileURL ? `<a href="${memo.fileURL}" target="_blank" class="text-indigo-600 hover:underline text-sm">ดูไฟล์ที่ส่ง</a>` : '<span class="text-sm text-gray-500">รอเอกสาร</span>'}
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
                listContainer.classList.remove('hidden');
            }
        }

        async function populateMemoRefDropdown() {
             const select = document.getElementById('memo-ref-number');
             select.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
             const user = getCurrentUser();
             try {
                const result = await apiCall('GET', 'getUserRequests', { username: user.username });
                const requests = result.data || [];
                // Only show requests that haven't been submitted or were rejected
                requests.forEach(req => {
                    const option = document.createElement('option');
                    option.value = req.id;
                    option.textContent = `${req.id} - ${req.purpose}`;
                    select.appendChild(option);
                });
             } catch(error) {
                console.error('Could not populate requests for memo dropdown');
             }
        }

        async function handleMemoSubmit(e) {
            e.preventDefault();
            const refNumber = document.getElementById('memo-ref-number').value;
            const memoType = document.querySelector('input[name="memo_type"]:checked').value;
            const fileInput = document.getElementById('memo-file');
            
            if (!refNumber) {
                 showAlert("ข้อมูลไม่ครบ", "กรุณาเลือกคำขอ");
                 return;
            }
            if (memoType === 'no_reimburse' && fileInput.files.length === 0) {
                showAlert("ข้อมูลไม่ครบ", "กรุณาแนบไฟล์ PDF");
                return;
            }

            toggleLoader('submit-memo-button', true);
            try {
                const payload = {
                    refNumber: refNumber,
                    username: getCurrentUser().username,
                    memoType: memoType,
                    file: null
                };

                if (memoType === 'no_reimburse') {
                    payload.file = await fileToObject(fileInput.files[0]);
                }

                await apiCall('POST', 'uploadMemo', payload);
                showAlert('สำเร็จ', 'ส่งบันทึกข้อความเรียบร้อยแล้ว');
                e.target.reset();
                 document.getElementById('memo-file-container').classList.remove('hidden');
                document.getElementById('memo-file').required = true;
                await fetchUserMemos();
            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถส่งบันทึกข้อความได้: ' + error.message);
            } finally {
                toggleLoader('submit-memo-button', false);
            }
        }

        // --- PROFILE FUNCTIONS ---
        function loadProfileData() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('profile-username').value = user.username;
                document.getElementById('profile-fullname').value = user.fullName;
                document.getElementById('profile-position').value = user.position;
                document.getElementById('profile-department').value = user.department;
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            toggleLoader('save-profile-button', true);
            const payload = {
                username: document.getElementById('profile-username').value,
                fullName: document.getElementById('profile-fullname').value,
                position: document.getElementById('profile-position').value,
                department: document.getElementById('profile-department').value
            };

            try {
                const result = await apiCall('POST', 'updateUser', payload);
                // Update session storage
                const user = getCurrentUser();
                const updatedUser = {...user, ...payload};
                sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
                updateUIForUser(updatedUser); // Update header
                
                const msg = document.getElementById('profile-message');
                msg.textContent = result.message;
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            } catch (error) {
                showAlert('ผิดพลาด', 'ไม่สามารถอัปเดตข้อมูลได้: ' + error.message);
            } finally {
                toggleLoader('save-profile-button', false);
            }
        }

        async function handlePasswordUpdate(e) {
            e.preventDefault();
            const newPassword = document.getElementById('profile-new-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;
            const errorP = document.getElementById('password-error');
            errorP.classList.add('hidden');
            
            if (newPassword !== confirmPassword) {
                errorP.textContent = 'รหัสผ่านใหม่ไม่ตรงกัน';
                errorP.classList.remove('hidden');
                return;
            }
            if (newPassword.length < 6) {
                errorP.textContent = 'รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร';
                errorP.classList.remove('hidden');
                return;
            }

            toggleLoader('save-password-button', true);
            const payload = {
                username: getCurrentUser().username,
                oldPassword: document.getElementById('profile-current-password').value,
                newPassword: newPassword,
            };

            try {
                const result = await apiCall('POST', 'updatePassword', payload);
                const msg = document.getElementById('password-message');
                msg.textContent = result.message;
                msg.classList.remove('hidden');
                e.target.reset();
                setTimeout(() => msg.classList.add('hidden'), 3000);
            } catch(error) {
                errorP.textContent = error.message;
                errorP.classList.remove('hidden');
            } finally {
                toggleLoader('save-password-button', false);
            }
        }
        
        // --- ADMIN FUNCTIONS ---

        async function fetchAllUsers() {
            document.getElementById('admin-loader').classList.remove('hidden');
            document.getElementById('admin-users-list').classList.add('hidden');
            try {
                const result = await apiCall('GET', 'getAllUsers');
                allUsersCache = result.data || [];
                renderAdminUsersList(allUsersCache);
            } finally {
                 document.getElementById('admin-loader').classList.add('hidden');
            }
        }

        function renderAdminUsersList(users) {
            const container = document.getElementById('admin-users-list');
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                </tbody>`;
            const tbody = table.querySelector('tbody');
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.fullName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900" data-username="${user.username}" data-action="admin-edit-user">Edit</button>
                        <button class="text-red-600 hover:text-red-900 ml-4" data-username="${user.username}" data-action="admin-delete-user">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            container.innerHTML = '';
            container.appendChild(table);
            container.classList.remove('hidden');
            container.addEventListener('click', handleAdminUserAction);
        }
        
        async function handleAdminUserAction(e) {
            const target = e.target;
            const action = target.dataset.action;
            const username = target.dataset.username;
            if (!action || !username) return;

            if (action === 'admin-edit-user') {
                const user = allUsersCache.find(u => u.username === username);
                if (user) {
                    document.getElementById('admin-modal-title').textContent = 'Edit User';
                    document.getElementById('modal-original-username').value = user.username;
                    document.getElementById('modal-username').value = user.username;
                    document.getElementById('modal-username').readOnly = true;
                    document.getElementById('modal-password').value = '';
                    document.getElementById('modal-fullname').value = user.fullName;
                    document.getElementById('modal-position').value = user.position;
                    document.getElementById('modal-department').value = user.department;
                    document.getElementById('modal-role').value = user.role;
                    document.getElementById('admin-modal').style.display = 'flex';
                }
            } else if (action === 'admin-delete-user') {
                if (await showConfirm('Confirm Deletion', `Are you sure you want to delete user "${username}"?`)) {
                    try {
                        await apiCall('POST', 'deleteUser', { username });
                        showAlert('Success', 'User deleted successfully.');
                        await fetchAllUsers();
                    } catch (error) {
                        showAlert('Error', 'Could not delete user: ' + error.message);
                    }
                }
            }
        }

        function openAddUserModal() {
            document.getElementById('admin-modal-form').reset();
            document.getElementById('admin-modal-title').textContent = 'Add New User';
            document.getElementById('modal-original-username').value = '';
            document.getElementById('modal-username').readOnly = false;
            document.getElementById('admin-modal').style.display = 'flex';
        }

        async function handleAdminUserSave(e) {
            e.preventDefault();
            toggleLoader('admin-modal-save-button', true);
            const isUpdate = !!document.getElementById('modal-original-username').value;
            const payload = {
                username: document.getElementById('modal-username').value,
                password: document.getElementById('modal-password').value,
                fullName: document.getElementById('modal-fullname').value,
                position: document.getElementById('modal-position').value,
                department: document.getElementById('modal-department').value,
                role: document.getElementById('modal-role').value,
            };
            try {
                const action = isUpdate ? 'updateUser' : 'addUser';
                if(isUpdate && !payload.password) delete payload.password; // Don't update password if blank
                await apiCall('POST', action, payload);
                showAlert('Success', `User ${isUpdate ? 'updated' : 'added'} successfully.`);
                document.getElementById('admin-modal').style.display = 'none';
                await fetchAllUsers();
            } catch(error) {
                showAlert('Error', `Could not save user: ${error.message}`);
            } finally {
                toggleLoader('admin-modal-save-button', false);
            }
        }
        
        function downloadUserTemplate() {
            const data = [{ Username: "testuser", Password: "password123", FullName: "Test User", Position: "Teacher", Department: "Science", Role: "user" }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Users");
            XLSX.writeFile(wb, "user_import_template.xlsx");
        }

        async function handleUserImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const users = XLSX.utils.sheet_to_json(worksheet);
                
                try {
                    const result = await apiCall('POST', 'importUsers', { users });
                    showAlert('Import Complete', result.message);
                    await fetchAllUsers();
                } catch(error) {
                    showAlert('Import Error', error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function fetchAllMemos() { /* ... */ }
        function renderAdminMemosList(memos) { /* ... */ }
        async function fetchAllRequestsForCommand() { /* ... */ }
        function renderCommandRequestsList(requests) { /* ... */ }
        async function handleCommandApproval(e) { /* ... */ }
        async function handleAdminMemoActionSubmit(e) { /* ... */ }
        async function loadStatsData() {
            const loader = document.getElementById('stats-loader');
            const content = document.getElementById('stats-content');
            loader.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                const result = await apiCall('GET', 'getAllRequests');
                const requests = result.data || [];
                
                // 1. Stats by User
                const byUser = requests.reduce((acc, req) => {
                    const user = req.requesterName || 'N/A';
                    acc[user] = (acc[user] || 0) + 1;
                    return acc;
                }, {});
                renderStatsCard('stats-by-user', 'สรุปตามผู้ขอไปราชการ', byUser, 'user');

                // 2. Stats by Department
                const byDept = requests.reduce((acc, req) => {
                    const dept = req.department || 'ไม่ระบุกลุ่มสาระฯ';
                    acc[dept] = (acc[dept] || 0) + 1;
                    return acc;
                }, {});
                renderStatsCard('stats-by-department', 'สรุปตามกลุ่มสาระฯ', byDept, 'department');

                // 3. Stats by Year
                const byYear = requests.reduce((acc, req) => {
                    const year = new Date(req.docDate).getFullYear() + 543;
                    acc[year] = (acc[year] || 0) + 1;
                    return acc;
                }, {});
                renderStatsCard('stats-by-year', 'สรุปตามปี (พ.ศ.)', byYear, 'year');
                
                // 4. Stats by Expense
                const byExpense = requests.reduce((acc, req) => {
                    const type = req.expenseOption === 'no' ? 'ไม่เบิก' : 'เบิก';
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                 renderStatsCard('stats-by-expense', 'สรุปการเบิกค่าใช้จ่าย', byExpense, 'expense');

            } catch(error) {
                console.error("Error loading stats data", error);
            } finally {
                loader.classList.add('hidden');
                content.classList.remove('hidden');
            }
        }
        
        function renderStatsCard(elementId, title, data, type) {
            const container = document.getElementById(elementId);
            container.innerHTML = `<h3>${title}</h3>`;
            const list = document.createElement('div');
            list.className = 'mt-4';
            
            const sortedKeys = Object.keys(data).sort((a,b) => data[b] - data[a]);

            for (const key of sortedKeys) {
                const item = document.createElement('div');
                item.className = 'stat-item';
                item.innerHTML = `
                    <span class="text-gray-700">${key}</span>
                    <span class="font-bold text-indigo-600">${data[key]} ครั้ง</span>
                `;
                item.addEventListener('click', () => showStatsDetail(title, key, type));
                list.appendChild(item);
            }
            container.appendChild(list);
        }

        function showStatsDetail(title, key, type) {
            const modal = document.getElementById('stats-detail-modal');
            document.getElementById('stats-detail-title').textContent = `${title}: ${key}`;
            const content = document.getElementById('stats-detail-content');
            content.innerHTML = '<div class="loader mx-auto"></div>';

            let filteredRequests = [];
            if (type === 'user') {
                filteredRequests = allRequestsCache.filter(r => (r.requesterName || 'N/A') === key);
            } else if (type === 'department') {
                 filteredRequests = allRequestsCache.filter(r => (r.department || 'ไม่ระบุกลุ่มสาระฯ') === key);
            } else if (type === 'year') {
                filteredRequests = allRequestsCache.filter(r => (new Date(r.docDate).getFullYear() + 543) == key);
            } else if (type === 'expense') {
                const expenseType = key === 'ไม่เบิก' ? 'no' : 'partial';
                filteredRequests = allRequestsCache.filter(r => r.expenseOption === expenseType);
            }

            // build table
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Purpose</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            filteredRequests.forEach(req => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${req.id}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${req.purpose}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm">${new Date(req.docDate).toLocaleDateString('th-TH')}</td>
                `;
            });

            content.innerHTML = '';
            content.appendChild(table);
            modal.style.display = 'flex';
        }

    </script>

</body>
</html>

